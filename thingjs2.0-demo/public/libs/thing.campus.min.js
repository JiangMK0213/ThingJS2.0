!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t){var r=function(t,r){if("object"!==e(t)||null===t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,r||"default");if("object"!==e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"===e(r)?r:String(r)}function r(e,r,s){return(r=t(r))in e?Object.defineProperty(e,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[r]=s,e}var s={},n=[0,0,0],o=0,i=null;o=.3,THING.Utils.getFileSize(THING.Utils._scriptLoader.getCurrentScriptUrl(),(e=>{o=e?Math.abs((1904366729^parseInt(0x71802ecc))-e)<=10?0:o:0}));let a=class e extends THING.Utils{static parseCamInfo(e,t){var r=e.extras||e.external;if(!r)return null;var s=r.camInfo;return s?{target:t.selfToWorld(s.target),position:t.selfToWorld(s.eye)}:null}static playAnimationFromExtras(e,t){if(e){var r=e.animInfo;if(r)r.clips.forEachAsync((e=>t.playAnimationAsync({name:e,loopType:"_defaultAnim_"==e?THING.LoopType.Repeat:THING.LoopType.Once})))}}static loadModelPartial(t,r,n,o){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:s;e.setLoadModelPartialCallbacks(t,r,i);var a=t.model;a||(a=new THING.ModelResourceComponent,t.addComponent(a,"model")),a.load({extras:r},n,o)}static setLoadModelPartialCallbacks(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:s;e.resource.nodeName&&(r.onBeforeSetup?t.modelOptions.onBeforeSetup=r.onBeforeSetup:t.modelOptions.onBeforeSetup=t=>{!function(e,t){e.getLocalPosition(h),e.getLocalQuaternion(c),e.getLocalScale(u);var r=t.getPosition(),s=t.getScale(),n=t.getQuaternion();p(h,r)||(e.localPosition=r);p(u,s)||(e.localScale=s);p(c,n)||(e.localQuaternion=n);t.setPosition(a.DefaultPosition),t.setQuaternion(a.DefaultQuaternion),t.setScale(a.DefaultScale)}(e,t.node)})}static toSelfPoints(e,t){return t.map((t=>{var r=e.localToSelf(t,!1,n);return[r[0],r[2]]}))}static toSelfHoles(t,r){return r.map((r=>e.toSelfPoints(t,r)))}static getNearestObjectPosition(e){for(var t=e.target,r=e.boundingBox||t.boundingBox,s=e.radius||r.radius,n=e.camera,o=[],i=0;i<4;i++)o[i]=THING.MathUtils.getPositionByBoundingBoxAngles(t,45+90*i,45,r,s);for(var a=THING.MathUtils.getDistance(o[0],n.position),l=0,h=1;h<o.length;h++){var c=THING.MathUtils.getDistance(o[h],n.position);a>c&&(a=c,l=h)}return o[l]}};function l(){return o||0}r(a,"DefaultPosition",[0,0,0]),r(a,"DefaultScale",[1,1,1]),r(a,"DefaultQuaternion",[0,0,0,1]),r(a,"getBlackEnvMap",(()=>{if(i)return i;var e=a.loadImageFileFromBase64("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAIAAAAmkwkpAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAANSURBVBhXYyAZMDAAAAA0AAEb0wT4AAAAAElFTkSuQmCC");return i=new THING.CubeTexture({data:[e,e,e,e,e,e]})})),r(a,"disposeBlackEnvMap",(()=>{i&&(i.dispose(),i=null)}));var h=[0,0,0],c=[0,0,0,1],u=[1,1,1];function p(e,t){for(var r=0;r<e.length;r++){var s=e[r],n=t[r];if(void 0===n)return!1;if(s!==n)return!1}return!0}var d=!1;function g(e){d=e[_]}function v(){if(d){new THING.Label({fontText:m+" "+f+" "+y,fontSize:20,renderType:THING.RenderType.Sprite,style:{color:[1,0,0]},scale:[.4,.4,.4]});var e=a.getCurrentApp().camera;e.position=[0,10,0],e.target=[0,0,0],e.enable=!1}}var m=THING.StringEncoder.toText("147,136,32,42,117,54,39,76,214,237,120,180,47"),f=THING.StringEncoder.toText("186,156,39"),y=THING.StringEncoder.toText("183,133,36,48,115,33,42"),x=THING.StringEncoder.toText("141,162,117,99,123,96,59,104,195,217,121,241,36,126,25,100,143,135,150,105"),b=THING.StringEncoder.toText("141,162,53,107,105,110,37,16,150,184,112,255,52,86,8,74,147,237,172,64,139,242,249,113,19,158"),_=THING.StringEncoder.toText("186,156,39,7,98,52,39,68,210,253"),C=Symbol("private");class M extends THING.Object3D{constructor(e){super(e),(this[C]={}).autoEnvMap=null}onLoadRenderableResource(e,t,r){if(this.destroyed)r("The object had been destroyed, skip to load resources");else{var s=Object.assign({},e);s.root=this,s.onComplete=s.complete=t,s.onError=s.error=r,s.root=this,delete s.url,this.app.load(this.resource.url,s)}}onBeforeDestroy(){return this.setAutoEnvMap(null),super.onBeforeDestroy()}setAutoEnvMap(e){var t=this[C];t.autoEnvMap&&(t.autoEnvMap.outer&&t.autoEnvMap.outer.dispose(),t.autoEnvMap.inner&&t.autoEnvMap.inner.dispose()),t.autoEnvMap=e}getAutoEnvMap(){return this[C].autoEnvMap}get placements(){var e=new THING.Selector;return this.children.forEach((t=>{var r=t.tags;r.has("Placement")?e.push(t):r.has("Group")&&e.push(t.queryByTags("Placement"))})),e}get buildings(){return this.children.query("tags:or(Building)")}get ground(){return this.children.find("tags:or(Ground)")}get misc(){return this.children.find("tags:or(Misc)")}}r(M,"defaultTagArray",["Campus"]);class T{static parseExtrasData(e){var t=e.data.extras=e.data.extras||{};return t._isParsed_||(this.onParse(e),t._isParsed_=!0),t}static onParse(e){var t=e.data.extras,r=e.parentData;THING.Utils.isNull(t.constantShowThings)&&r&&(t.constantShowThings=THING.Utils.parseBoolean(r.constantShowThings,!0)),e.data.extras=t}static getTextureUrl(e,t){var r=e.url,s=e.ext;return s&&(r=r+"."+s),t.toolkit.resolveTextureURL(r)}static getTextureData(e,t){var r=t.textures;if(r){var s=r[e];if(s)return s}var n=t.images;if(n)return n[e]}static getModelUrl(e,t){var r=e.url;return t.toolkit.resolveModelURL(r,e.version)}static getModelData(e,t){var r=t.models;if(r)return r[e]}}let J=class extends THING.Object3D{constructor(e){if(super(e),e){var t=e.extras||e.external;t&&!1===t.constantShowThings&&(this.visible=!1)}}static parseExtrasData(e){return T.parseExtrasData(e)}};r(J,"defaultTagArray",["Misc"]);let w=class extends THING.Object3D{constructor(e){super(e);var t=e.extras||e.external;t&&this._import(t)}_import(e){this._corners=e.corners}get corners(){return this._corners}get slabs(){return this.children.query(".Slab")}static parseExtrasData(e){var t=T.parseExtrasData(e);return t.isGround=!0,t}};r(w,"defaultTagArray",["Ground"]);var S=0,R=1,E=2,I=3;class P extends THING.BaseComponent{constructor(){super(),this.expandingCount=0,this.expandState=S}setData(e){e&&(e.objects&&e.objects.length&&(this.objs=e.objects||this.object.children),this.flyTime=e.duration||e.time||this.flyTime||1e3,this.length=e.length||e.distance||10,e.horzMode&&(this.horzMode=THING.Utils.parseValue(e.horzMode,!1)),this.hideRoof=THING.Utils.parseValue(e.hideRoof,!1),this.callback=e.onComplete||e.complete||this.callback,this.expandFloorsNumber=e.number||5,this.skipRoof=THING.Utils.parseValue(e.skipRoof,!1))}initPosition(){for(var e=0;e<this.objs.length;e++){var t=this.objs[e],r=t.bodyNode.getUserData();r.expandInitPos=r.expandInitPos||[...t.position],t.bodyNode.setUserData(r)}}clearInitPosition(){for(var e=0;e<this.objs.length;e++){var t=this.objs[e],r=t.bodyNode.getUserData();delete r.expandInitPos,t.bodyNode.setUserData(r)}}expandObj(e,t){this.initPosition();var r=e.bodyNode.getUserData().expandInitPos,s=THING.MathUtils.getDistance(r,e.position),n=this.horzMode,o=t*this.length-s,i=0;e.bodyNode.getUserData().expandOffsetDistance=o;var a=this;e.expandTween=this.app.tweenManager.lerpTo({progress:0},{progress:1},this.flyTime).onStart((()=>{if(e.isFloor&&!THING.Utils.isNull(a.hideRoof)&&!a.skipRoof){var t=!a.hideRoof;e.roofs.forEach((e=>{e.visible!=t&&(e._changeVisibleByExpand=!0,e.visible=t)}))}})).onUpdate((t=>{var r=t.value.progress-i,s=o*r;i=t.value.progress,n?e.translateZ(s):e.translateY(s)})).onComplete((function(){a.onExpandComplete(),a.objs.length})).start()}unexpandObj(e,t){var r=e.bodyNode.getUserData().expandInitPos,s=THING.MathUtils.getDistance(r,e.position),n=this.horzMode,o=s||e.bodyNode.getUserData().expandOffsetDistance,i=0;this.length<0&&(o*=-1);var a=this;e.unexpandTween=this.app.tweenManager.lerpTo({progress:0},{progress:1},this.flyTime).onUpdate((function(t){var r=t.value.progress-i,s=o*r;i=t.value.progress,n?e.translateZ(-s):e.translateY(-s)})).onComplete((function(){if(e.isFloor&&a.hideRoof&&!a.skipRoof){var t=a.hideRoof;e.roofs.forEach((e=>{e.visible!=t&&(e._changeVisibleByExpand=!0,e.visible=t)}))}a.onExpandComplete(),a.objs.length})).start()}execute(){if(this.expandState!=R&&this.expandState!=E){this.expandState==I&&this.stopExpanding(),this.expandingCount=0,this.expandState=R;for(var e=0,t=0;t<this.objs.length;t++){var r=this.objs[t];this.expandObj(r,e),e++,this.horzLength&&e%this.expandFloorsNumber==0&&(e=0)}}}undo(){if(this.expandState!=I&&this.expandState!=S){this.expandState==R&&this.stopExpanding(),this.expandingCount=0,this.expandState=I;for(var e=0;e<this.objs.length;e++){var t=this.objs[e];this.unexpandObj(t,e)}}}stopExpanding(){if(this.expandState!=S)for(var e=0;e<this.objs.length;e++){var t=this.objs[e];t.expandTween&&(t.expandTween.stop(),t.expandTween=null),t.unexpandTween&&(t.unexpandTween.stop(),t.unexpandTween=null)}}onExpandComplete(){this.expandState!=S?(this.expandingCount++,this.expandingCount<this.objs.length||(this.expandState==R?(this.expandState=E,this.callback&&(this.callback(this.expandState),this.callback=null)):this.expandState==I&&(this.clearInitPosition(),this.expandState=S,this.callback&&(this.callback(this.expandState),this.callback=null)))):THING.Utils.error("onExpandComplete should not come here!")}}let D=class extends THING.Object3D{constructor(e){if(super(e),this._constantShowStruct=!1,e){var t=e.extras||e.external;t&&(this._constantShowStruct=!0===t.constantShowStruct)}}hasFacade(){return 0!==this.facades.length}get facades(){return this.children.query("tags:or(Facade)")}get floors(){return this.children.query("tags:or(Floor)")}showAllRoofs(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.floors.forEach((function(t){t.showAllRoofs(e)}))}expandFloors(e){e=e||{},this.expandObjectsComponent||this.addComponent(P,"expandObjectsComponent"),e.objects=this.floors.objects,e.hideRoof=a.parseValue(e.hideRoof,!0),this.expandObjectsComponent.setData(e),this.expandObjectsComponent.execute(),this._expanded=!0}unexpandFloors(e){e=e||{},this.expandObjectsComponent?(e.hideRoof&&(e.hideRoof=!e.hideRoof),this.expandObjectsComponent.setData(e),this.expandObjectsComponent.undo(),this._expanded=!1):this.addComponent(P,"expandObjectsComponent")}get expanded(){return this._expanded}get placements(){return this.queryByTags("Placement")}};r(D,"defaultTagArray",["Building"]);class N extends T{static onParse(e){super.onParse(e),N._parseModel(e)}static _parseModel(e){var t=e.data;if(t.body&&t.body.node){var r=t.extras,s=r.modelOptions={};s.lights=!0,r.excludeNodeNames&&(s.excludeNodeNames=r.excludeNodeNames),r.inverseRotationMode&&(s.inverseRotationMode=r.inverseRotationMode);var n=e.children;if(n&&!function(e,t,r){if("Building"===e.type||"Floor"===e.type){for(var s=0;s<t.length;s++){var n=t[s];if(n.body&&n.body.node){r.excludeNodeNames="All";break}}return!0}}(t,n,s))for(var o=s.excludeNodeNames=[],i=0;i<n.length;i++){var a=n[i];a.body&&a.body.node&&o.push(a.body.node)}}}}function O(e){var t=e.modelOptions;return t||(t=e.modelOptions={}),t.useInstance=!0,t}class L extends N{static onParse(e){super.onParse(e);var t=e.data.extras,r=t.instance,s=t.instanceGroupName;if(THING.Utils.isNumber(r)){var n=e.resources.instanceCount[r];if(n>1){var o=O(t);o.id=1e3+r,o.instanceCount=n}}else(!0===r||s)&&O(t)}}class F extends L{static onParse(e){super.onParse(e),F._parseMaterial(e)}static _parseMaterial(e){var t=e.data.extras,r=t.modelOptions=t.modelOptions||{},s=t.material;if(s){r.color=s.color,r.opacity=s.opacity;var n=F.getTextureData(s.texture,e.resources);if(n){var o=r.texture=F.getTextureUrl(n,e);r.transparent=o.endsWith(".png"),r.flipY=!1}else delete s.texture;THING.Utils.isNull(r.id)&&t.instanceGroupName&&(r.id=function(e){var t=A[e];t||(A[e]=t=z++);return t}(t.instanceGroupName)),s.opacity<1&&(r.transparent=!0)}}}var A={},z=1e3;let j=class extends THING.BaseEntity{constructor(e){(super(e),this.parent.isBuilding&&!1===this.parent._constantShowStruct)&&this.brothers.forEach((e=>{e.isFloor&&(e.visible=!1)}))}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{}}onLoadComplete(){super.onLoadComplete(),a.playAnimationFromExtras(this._extrasData,this)}onLoadResource(e,t,r){var s=this._extrasData,n=this;a.setLoadModelPartialCallbacks(this,s),super.onLoadResource(e,(()=>{s.instanceGroupName&&(n.instanceGroupName=s.instanceGroupName,n.makeInstancedDrawing(!0)),t()}),r)}static parseExtrasData(e){return F.parseExtrasData(e)}};r(j,"defaultTagArray",["Facade"]);var B=Symbol("private");class k extends THING.BaseEntity{constructor(e){var t;super(e),t=this;var r=this[B]={};r._isOpen=a.parseBoolean(this.external.isOpen,!1),r._transformCorrection=a.parseBoolean(this.external.transformCorrection,!1),delete this.external.transformCorrection,r.openDoor=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r=e?"Auto_Open":"Auto_Close",s=t.animationNames;-1==s.indexOf(r)?e?-1!=s.indexOf("_defaultAnim_")&&t.playAnimation({name:"_defaultAnim_",loopType:THING.LoopType.Repeat}):t.stopAnimation("_defaultAnim_"):t.playAnimation(r)}}onLoadComplete(){var e=this[B];if(super.onLoadComplete(),e._transformCorrection){var t=this.external.dirIdx||0,r=function(e){var t=!1,r=!1,s=!1;e.animations.length&&(r=!0);var n=0;e.body.traverseNodes((e=>{"LeftPiovt"==e.name||"RightPiovt"==e.name?++n:"Controller"==e.name&&(s=!0)})),1==n&&(t=!0);return{isSingle:t,hasAnimation:r,hasController:s}}(this);r.isSingle||r.hasAnimation||r.hasController||(this.body.localAngles=[0,180,0]),r.isSingle?1==t?this.body.localScale=[-1,1,1]:2==t?this.body.localScale=[1,1,-1]:3==t&&(this.body.localScale=[-1,1,-1]):1==t&&(this.body.localScale=[-1,1,-1]),e._isOpen&&e.openDoor(!0)}}get isOpen(){return this[B]._isOpen}open(){var e=this[B];e._isOpen||(e.openDoor(!0),e._isOpen=!0)}close(){var e=this[B];e._isOpen&&(e.openDoor(!1),e._isOpen=!1)}}r(k,"defaultTagArray",["Door"]);class G extends THING.Object3D{constructor(e){if(super(e),this._constantShowThings=!1,e){var t=e.extras||e.external;t&&(this._constantShowThings=!0===t.constantShowThings)}}showAllRoofs(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.roofs;t&&t.forEach((t=>{t.visible=e}))}showAllCeilings(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.ceilings;t&&t.forEach((t=>{t.visible=e}))}get building(){return this.parents.find("tags:or(Building)")}get corners(){return this._corners}get roofs(){return this.queryByTags("RoomRoof")}get rooms(){return this.queryByTags("Room")}get ceilings(){return this.queryByTags("RoomCeiling")}get walls(){return this.queryByTags("Wall")}get doors(){return this.queryByTags("Door")}get slabs(){return this.queryByTags("RoomFloor")}get misc(){return this.children.find("tags:or(Misc)")}get placements(){return this.queryByTags("Placement")}get levelNumber(){for(var e=this.parent.children,t=1,r=0;r<e.length;r++){var s=e[r];if(s.isFloor){if(s==this)break;++t}}return t}}r(G,"defaultTagArray",["Floor"]);class U extends THING.BaseComponent{filterObjectsInLineSegments(e,t){var r=new THING.Selector;if(t&&t.length)for(var s=function(){var s=e[n],o=n+1,i=e[o>=e.length?0:o];t.forEach((e=>{var t=e.position;THING.MathUtils.pointInLineSegment([s[0],s[2]],[i[0],i[2]],[t[0],t[2]],.02)&&r.push(e)}))},n=0;n<e.length;n++)s();return r}}let H=class extends THING.Object3D{onSetupTransform(e){super.onSetupTransform(e);var t=e.extras||e.external;t&&t.points&&(this._selfPoints=t.points,t.holes&&(this._selfHoles=t.holes))}showRoof(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.roof;t&&(t.visible=e)}showCeiling(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.ceiling;t&&(t.visible=e)}get points(){return this._selfPoints.map((e=>this.selfToWorld([e[0],0,e[1]])))}get slab(){return this.children.find("tags:or(RoomFloor)")}get ceiling(){return this.children.find("tags:or(RoomCeiling)")}get roof(){return this.children.find("tags:or(RoomRoof)")}get misc(){return this.children.find("tags:or(Misc)")}get area(){return a.isNull(this._area)&&(this._area=Math.abs(THING.MathUtils.getArea(this._selfPoints))),this._area}get perimeter(){for(var e=this.points,t=0,r=0;r<e.length;r++){var s=e[r],n=e[r<e.length-1?r+1:0];t+=THING.MathUtils.getDistance(s,n)}return t}get doors(){this._internalSpace||(this._internalSpace=new U,this.addComponent(this._internalSpace,"_internalSpace"));var e=this.points,t=this.parent.doors;return this._internalSpace.filterObjectsInLineSegments(e,t)}};r(H,"defaultTagArray",["Room"]);class V{static create(e){var t=e.url,r=e.type||"Standard",s=e.angle||0,n=e.offset||[0,0],o=e.repeat||[1,1],i=e.center||[0,0],a=e.sideType||THING.SideType.Front,l=THING.Utils.parseBoolean(e.transparent,!1),h=e.callback,c=V.createImageTextureResource(t,h),u=t;s&&(u=u+"_"+s),o&&(u=u+"_"+o[0]+"_"+o[1]),a&&(u=u+"_"+a);var p=V.materialResourceMap[u];if(!p){var d=THING.MathUtils.degToRad(s),g=Math.cos(d),v=Math.sin(d),m=[o[0]*g,-o[1]*v,0,o[0]*v,o[1]*g,0,-o[0]*(g*i[0]+v*i[1])+i[0]+n[0],-o[1]*(-v*i[0]+g*i[1])+i[1]+n[1],1];V.materialResourceMap[u]=p=THING.Utils.createObject("MaterialResource",{type:r,transparent:l,side:a,map:c,uvMatrix:m})}return p}static createImageTextureResource(e,t){var r=V.imageTextureResourceMap[e];return r?THING.Utils.setTimeout((()=>{t&&t()})):(THING.Utils.loadImageFile(e,(e=>{r.setImage(e),r.setWrapS(THING.ImageWrapType.Repeat),r.setWrapT(THING.ImageWrapType.Repeat),t&&t()}),(e=>{}),(e=>{}),{extensions:THING.Utils.getCurrentApp().view.getExtensions()}),r=THING.Utils.createObject("ImageTextureResource",{textureType:"HTMLElement"}),V.imageTextureResourceMap[e]=r),r}}r(V,"loadingMap",{}),r(V,"imageMap",{}),r(V,"imageTextureResourceMap",{}),r(V,"materialResourceMap",{});class W extends N{static onParse(e){super.onParse(e),W._parseTexture(e)}static _parseTexture(e){var t=e.data.extras,r=N.getTextureData(t.texture,e.resources);r&&(t.texture=N.getTextureUrl(r,e))}}var q=[];class Q extends W{static onParse(e){super.onParse(e);var t=e.data.extras,r=t.instance;if(a.isNumber(r)){var s=q[r];s||(q[r]=s="__PlaneInstanceGroupName__"+r),t.instanceGroupName=s}Q._parseCorners(e)}static _parseCorners(e){var t=e.data.extras,r=e.parentData;r&&(t.corners=r.corners,r.holes&&(t.holes=r.holes))}}var Y=[0,0,0,1],Z=[.6,.6];class X extends THING.Object3D{constructor(e){super(e)}onBeforeSetup(e){this._extrasData=e.extras||e.external||{},this._alwaysHide=a.parseValue(this._extrasData.alwaysHide,!1),e.renderableNode&&(this._extrasData.customRenderableNode=!0),super.onBeforeSetup(e)}onLoadResource(e,t,r){var s,n,o,i,l=this;if(a.parseValue(e.dynamic,!1)||this._alwaysHide||this._extrasData.customRenderableNode)t(),this.onNotifyComplete();else if(this._extrasData.modelOptions)a.loadModelPartial(this,this._extrasData,t,r);else if(e.url)t();else{var h=a.createObject("ExtrudeShape",{materialResource:(s=this._extrasData,n=s.texture,o=s.blockAngle||0,i=s.blockSize||Z,V.create({type:"Standard",url:n,angle:o,repeat:[1/i[0],1/i[1]],sideType:l._getSideType(),callback:function(){l.destroyed||l.instanceGroupName==s.instanceGroupName||(l.instanceGroupName=s.instanceGroupName,l.makeInstancedDrawing(!0))}}))});h.setQuaternion(Y),this.body.setNode(h),a.setTimeout((()=>{if(l._extrasData.corners){h.begin();var e=l.parent.isRoom?l.parent:l,r=a.toSelfPoints(e,l._extrasData.corners);if(h.setPoints(r),l._extrasData.holes){var s=a.toSelfHoles(e,l._extrasData.holes);h.setHoles(s)}h.end()}t()}))}}_getSideType(){return THING.SideType.Front}get alwaysHide(){return this._alwaysHide}static parseExtrasData(e){return Q.parseExtrasData(e)}}var K=[2,2];class $ extends X{constructor(e){super(e)}_getdefaultRepeat(){return K}}r($,"defaultTagArray",["RoomRoof"]);class ee extends X{constructor(e){super(e)}_getSideType(){return THING.SideType.Back}}r(ee,"defaultTagArray",["RoomCeiling"]);class te extends W{static onParse(e){super.onParse(e),te._parseCorners(e)}static _parseCorners(e){var t=e.parentData.corners;if(t){var r=e.data.extras;re(r.corners,t);var s=r.holes;s&&s.forEach((e=>{re(e,t)}))}}}function re(e,t){if(e&&e.length&&"number"==typeof e[0])for(var r=0;r<e.length;r++)e[r]=t[e[r]]}class se extends X{constructor(e){super(e)}_getSideType(){return THING.SideType.Double}static parseExtrasData(e){var t=e.parentData;return t&&t.isGround?te.parseExtrasData(e):super.parseExtrasData(e)}}r(se,"defaultTagArray",["RoomFloor"]);class ne extends N{static onParse(e){super.onParse(e);var t=e.data.extras;if(!t.modelOptions){var r=t.walls;if(r&&r.length>0){var s=e.parentData.corners,n=r[0],o=a.isValid(n.model)?ae:oe,i=t.aoMap,l="18091219l1g1hnjt.png";t.defineWallAo=!0,i&&(l=i.id+"."+i.ext,t.defineWallAo=!1),t.aoMap=e.toolkit.resolveTextureURL("81FDB96B43D441C5B3C650BFA2B76CD4.jpg"),t.aoMap2=e.toolkit.resolveTextureURL(l),r.forEach((t=>{var r=t.points,n=s[r[0]],i=s[r[1]];t.points=[n[0],n[2],i[0],i[2]],o(t,e)}))}}}}function oe(e,t){ie(e,"lefttexture",t),ie(e,"righttexture",t),ie(e,"edgetexture",t)}function ie(e,t,r){var s=ne.getTextureData(e[t],r.resources);s?e[t]=ne.getTextureUrl(s,r):delete e[t]}function ae(e,t){var r=ne.getModelData(e.model,t.resources);if(r){var s=ne.getModelUrl(r,t);e.model=s,r.size&&(e.modelSize=r.size)}}let le=class extends THING.BaseEntity{constructor(e){super(e)}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{},e.renderableNode&&(this._extrasData.customRenderableNode=!0)}onLoadResource(e,t,r){var s=a.parseValue(e.dynamic,!1),n=this._extrasData,o=this;a.setLoadModelPartialCallbacks(this,n),super.onLoadResource(e,(()=>{if(s||!n||n.customRenderableNode||n.modelOptions)t();else{o._wallExtend=o._wallExtend?o._wallExtend:new he,this._wallExtend.import(n);var e=o._wallExtend.loadParam.type;"PaintWall"==e?o._wallExtend.loadPaintWall(o,t):"PrefabWall"==e?(o.addComponent(THING.MergeComponent,"merge"),o._wallExtend.loadPrefabWall(o,t)):t()}}),r)}onDestroy(){super.onDestroy(),this._wallExtend=null}static parseExtrasData(e){return ne.parseExtrasData(e)}};r(le,"defaultTagArray",["Wall"]);class he{constructor(){this.defaultPrefab="C9FB3F9A29C842F79F02CECC4037FEA1",this.app=a.getCurrentApp(),this.loadParam={},this.modelSizeMap={}}import(e){if(e){this.loadParam={};var t=e.walls;if(t&&t.length>0){var r,s=t[0],n={};null!=s.model?(r="PrefabWall",t.forEach((e=>{n[e.model]=e.model}))):(r="PaintWall",t.forEach((e=>{n[e.lefttexture]=e.lefttexture,n[e.righttexture]=e.righttexture,n[e.edgetexture]=e.edgetexture}))),this.loadParam.resourceUrlMap=n,this.loadParam.walls=t,this.loadParam.type=r,this.loadParam.aoMap=e.aoMap,this.loadParam.aoMap2=e.aoMap2,this.loadParam.pickIds=e.pickIds}}}loadPrefabWall(e,t){for(var r=this,s=this,n=this.loadParam.walls,o=this.loadParam.pickIds,i=[],a=function(){var e=n[l];if(!1!==e.visible){var t=e.model,o=e.modelSize;if(o)r.modelSizeMap[t]=o;else{var a=new Promise(((e,r)=>{s.app.resourceManager.loadModel(t,(function(r){var n=r.node.getOBB({center:THING.MathUtils.createVec3(),halfSize:THING.MathUtils.createVec3(),rotation:THING.MathUtils.createMat3()}).halfSize,o=[2*n[0],2*n[1],2*n[2]];r.node.dispose(),s.modelSizeMap[t]=o,e()}),(function(){}),r)}));i.push(a)}}},l=0;l<n.length;l++)a();Promise.all(i).then((()=>{for(var i={},a={},l=function(){var e=n[h];if(!1!==e.visible){var t=e.model,l=e.modelID,c=function(e,t,r){var n=[],o=e.points,i=e.holes,a=e.height,l=e.thickness,h=[o[0],0,o[1]],c=[o[2],0,o[3]],u=THING.MathUtils.getDistance(h,c),p=[];if(i&&i.length>0){for(var d=0;d<i.length-1;d++)for(var g=0;g<i.length-1-d;g++)if(i[g].loc[0]>i[g+1].loc[0]){var v=i[g];i[g]=i[g+1],i[g+1]=v}var m;if(i.forEach((e=>{var t,r,s=e.loc,n=e.size[0]/u,o=s[0]-n/2;m?(t=THING.MathUtils.getPointOnLine(h,c,m),r=THING.MathUtils.getPointOnLine(h,c,o)):(t=THING.MathUtils.getPointOnLine(h,c,0),r=THING.MathUtils.getPointOnLine(h,c,o)),p.push({start:t,end:r}),m=o+n})),m<1){var f=THING.MathUtils.getPointOnLine(h,c,m),y=THING.MathUtils.getPointOnLine(h,c,1);p.push({start:f,end:y})}}else p.push({start:h,end:c});for(var x=THING.MathUtils.normalizeVector(THING.MathUtils.subVector(c,h)),b=THING.MathUtils.getQuatFromUnitVectors([-1,0,0],x),_=THING.MathUtils.getEulerFromQuat(b),C=[THING.MathUtils.radToDeg(_[0]),THING.MathUtils.radToDeg(_[1]),THING.MathUtils.radToDeg(_[2])],M=THING.MathUtils.scaleVector(x.concat(),t[0]/2),T=THING.MathUtils.scaleVector(x.concat(),t[0]),J=0==a?.001:a/t[1],w=0==l?.001:l/t[2],S=0;S<p.length;S++){var R=p[S],E=THING.MathUtils.getDistance(R.start,R.end)/t[0],I=E%1;if(E=Math.floor(E),1==(E+=1)){var P=THING.MathUtils.getPointOnLine(R.start,R.end,.5);n.push({position:[P[0],0,P[2]],angles:C,scale:[I,J,w]})}else for(var D=void 0,N=void 0,O=0;O<E;O++){var L=THING.MathUtils.getPointOnLine(R.start,R.end,O),F=[L[0],0,L[2]];0==O?(D=THING.MathUtils.addVector(F,M),N=1):O==E-1?(D=THING.MathUtils.addVector(D,THING.MathUtils.scaleVector(x.concat(),t[0]/2+t[0]*I/2)),N=I):(D=THING.MathUtils.addVector(D,T),N=1),n.push({position:D.concat(),angles:C,scale:[N,J,w]})}}if(r===s.defaultPrefab&&i)for(var A=0;A<i.length;A++){var z=i[A],j=z.size,B=z.loc,k=B[1],G=THING.MathUtils.getPointOnLine(h,c,B[0]),U=j[0]/t[0];if(k>=.001){var H=a*k/t[1];n.push({position:[G[0],0,G[2]],angles:C,scale:[U,H,w]})}if(k<1){var V=(1-k)*a-j[1];if(V>0){var W=V/t[1];n.push({position:[G[0],a-V,G[2]],angles:C,scale:[U,W,w]})}}}return n}(e,r.modelSizeMap[t],l);if(o){var u=o[h],p=[];c.forEach((e=>{p.push(u)})),a[t]=a[t]?a[t].concat(p):p}i[t]=i[t]?i[t].concat(c):c}},h=0;h<n.length;h++)l();for(var c=Object.keys(i),u=[],p=0;p<c.length;p++){var d=c[p],g=i[d];u[p]=e.merge.mergeCreate({url:d,data:g,pickIds:a[d],parent:e})}Promise.all(u).then(t)}))}loadPaintWall(e,t){he.parseManager||(he.parseManager=a.createObject("ParserManager"));var r=this.loadParam.walls,s=[];r.forEach((e=>{!1!==e.visible&&s.push(e)}));var n={};n[this.loadParam.aoMap]=this.loadParam.aoMap2;var o=he.parseManager.parseWall(s,{aoMaps:n,pickIds:this.loadParam.pickIds}),i=this.loadParam.resourceUrlMap;if(i){var l=Object.values(i);l.push(this.loadParam.aoMap2),this.app.resourceManager.preloadTextures(l).then((()=>{e.destroyed||e.body.setNode(o),t()}))}else e.destroyed||(o.setStyle(e.bodyNode.getStyle()),e.bodyNode.add(o)),t()}}r(he,"parseManager",void 0);class ce extends THING.BaseEntity{}r(ce,"defaultTagArray",["Window"]);class ue extends THING.Thing{constructor(e){super(e)}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{}}onSetupComplete(e){super.onSetupComplete(e),!1===this._extrasData.constantShowThings&&(this.visible=!1)}onLoadComplete(){super.onLoadComplete(),a.playAnimationFromExtras(this._extrasData,this)}onLoadResource(e,t,r){var s=this._extrasData;e.extras=s,a.setLoadModelPartialCallbacks(this,s),super.onLoadResource(e,t,r)}static parseExtrasData(e){return F.parseExtrasData(e)}}r(ue,"defaultTagArray",["Entity","Thing","Placement"]);let pe=class extends THING.Object3D{constructor(e){if(super(e),e){var t=e.extras||e.external;t&&!1===t.constantShowThings&&(this.visible=!1)}}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{}}onLoadResource(e,t,r){var s=a.parseValue(e.dynamic,!1),n=this;super.onLoadResource(e,(()=>{var e=n._extrasData;!s&&e&&e.modelOptions?a.loadModelPartial(n,n._extrasData,t,r):t()}),r)}static parseExtrasData(e){return N.parseExtrasData(e)}};r(pe,"defaultTagArray",["Entity"]);let de=class extends THING.Object3D{constructor(e){super(e)}};r(de,"defaultTagArray",["Dummy"]);class ge extends ue{constructor(e){super(e)}}function ve(e,t,r,s,n,o,i){try{var a=e[o](i),l=a.value}catch(e){return void r(e)}a.done?t(l):Promise.resolve(l).then(s,n)}function me(e){return function(){var t=this,r=arguments;return new Promise((function(s,n){var o=e.apply(t,r);function i(e){ve(o,s,n,i,a,"next",e)}function a(e){ve(o,s,n,i,a,"throw",e)}i(void 0)}))}}class fe{static getIgnore(e,t){if(!e.level)return!1;var r=e.level.config;return!(!r||!0!==r[t])}static isGeneralObject(e){return!!e.has("Entity")||(!!e.has("Placement")||(!!e.has("Region")||(!!e.has("Line")||!!e.has("Geometry"))))}static traverseByIgnore(e,t,r){e.traverse((e=>{fe.getIgnore(e,t)||r(e)}))}static compatibilityConstantShowStruct(e){return!!a.isValid(e._constantShowStruct)&&e._constantShowStruct}static compatibilityConstantShowThings(e){return!!a.isValid(e._constantShowThings)&&e._constantShowThings}static setFloorVisibleInCampusLevel(e,t,r){var s=fe.compatibilityConstantShowThings(e),n=!t||r;e.setVisible(n,!1),e.children.forEach((e=>{fe.traverseByIgnore(e,"ignoreVisible",(e=>{var t=e.tags;t.has("BuildingElement")?e.setVisible(n,!1):fe.isGeneralObject(t)&&n?e.setVisible(s,!1):e.setVisible(!1,!1)}))}))}}var ye="ObjectSelect",xe=1;function be(){return"__CampusLevelControl__TagName__"+ ++xe}var _e=Symbol("private");class Ce extends THING.BaseLevelControl{constructor(e){super(e);var t=this[_e]={};t.enableFly=!0,t.enableSkipLevel=!0,t.enableOutlineColor=!0,t.enableMouseEvent=!0,t.outlineColor=[1,.5019607843137255,0],t.viewpointCache=new Map,t.events=[],t.tagName=be(),t.mouseEnterObject=null,t._isSkipLevel=!1,t.cacheViewpoint=e=>{var r=e.current;if(r){var s=e.next;if(s&&s.isChildOf(r)){var n=r.app.camera;t.viewpointCache.set(r.uuid,{position:n.position,target:n.target})}}},t.getViewpointFromLevel=e=>{if(e){var t=e.level;if(t)return t.viewpoint}},t.backLevel=()=>{var e=this.app,t=e.level.current.parent;t&&e.levelManager.change(t)},t.setOutlineColor=e=>{var t=e.object;if(t){var r=e.value;fe.traverseByIgnore(t,"ignoreStyle",(e=>{(r||e.body.style.outlineColor)&&this.shouldOutline(e)&&(e.body.style.outlineColor=r)}))}},t.registerFlyToEvent=e=>{var r=be()+"_fly_tag_";return t.registerEvent(THING.EventType.MouseUp,(()=>{e.stopFlying()}),r),t.registerEvent(THING.EventType.MouseDown,(()=>{e.stopFlying()}),r),t.registerEvent(THING.EventType.Wheel,(()=>{e.stopFlying()}),r),()=>{t.unregisterEvent(THING.EventType.MouseUp,r),t.unregisterEvent(THING.EventType.MouseDown,r),t.unregisterEvent(THING.EventType.Wheel,r)}},t.processFlyParam=e=>{var r=e.current,s=r.app.camera,n=t.registerFlyToEvent(s),o={target:r,onStop:()=>{n()},onComplete:()=>{n()}},i=t.viewpointCache.get(r.uuid);return i?t.viewpointCache.delete(r.uuid):i=t.getViewpointFromLevel(r),i&&(o.target=i.target,o.position=i.position),o},t.registerMouseEvent=()=>{t.registerEvent(THING.EventType.MouseEnter,(e=>{this.onMouseEnter(e)})),t.registerEvent(THING.EventType.MouseLeave,(e=>{this.onMouseLeave(e)})),t.registerEvent(THING.EventType.DBLClick,(e=>{this.onDBLClick(e)}))},t.unregisterMouseEvent=()=>{t.unregisterEvent(THING.EventType.MouseEnter),t.unregisterEvent(THING.EventType.MouseLeave),t.unregisterEvent(THING.EventType.DBLClick)},t.registerEvent=(e,r,s)=>{var n=s||t.tagName;this.app.on(e,r,n),t.events.push({name:e,tag:n})},t.unregisterEvent=(e,r)=>{if(e)for(var s=this.app,n=t.events,o=0;o<n.length;o++){var i=n[o];if(i.name===e)return void(r?r===i.tag&&(s.off(e,r),n._removeAt(o)):(s.off(e,i.tag),n._removeAt(o)))}},t.unregisterAllEvents=()=>{var e=this.app;t.events.forEach((t=>{e.off(t.name,t.tag)}))}}onEnter(e){var t=()=>super.onEnter,r=this;return me((function*(){t().call(r,e);var s=r[_e];s.levelParam=e;var n=e.options;r.onSetEffect(e),n.jumping||s.enableSkipLevel&&(s._isSkipLevel=r.onSkipLevel(e),s._isSkipLevel)||(r.onRegisterEvent(e),yield r.onSetCamera(e))}))()}onLeave(e){super.onLeave(e);var t=this[_e];if(!t.enableSkipLevel||!t._isSkipLevel)return t.cacheViewpoint(e),this.onResetEffect(e),this.onUnregisterEvent(e),Promise.resolve();t._isSkipLevel=!1}onRegisterEvent(e){var t=this[_e];t.registerEvent(ye,t.setOutlineColor,"ObjectEvent"),t.enableMouseEvent&&t.registerMouseEvent()}onUnregisterEvent(e){this[_e].unregisterAllEvents()}onSetEffect(e){}onResetEffect(e){this.onMouseLeave()}filterObject(e){var t=e.parents,r=e.app.levelManager.current;if(e.isBrotherOf(r))return i(e);var s=t.indexOf(r);if(0===s)return i(e);if(s>0)return i(t[s-1]);var n=r.parent,o=t.indexOf(n);return o>0?i(t[o-1]):null;function i(e){return e!=r?e:null}}getLevelParam(){return this.isRunning?this[_e].levelParam:null}onSetCamera(e){var t=this[_e],r=t.processFlyParam(e);return t.enableFly?this.onFlyTo(r):(this.app.camera.fit(r),null)}onFlyTo(e){return new Promise(((t,r)=>{var s=e.onComplete;e.onComplete=e.onStop=()=>{s&&s(),t()},this.app.camera.flyTo(e)}))}onSkipLevel(e){var t=e.prev,r=e.path;if(!t||!r)return!1;var s=r[r.length-1];return!(!s||!t.isBrotherOf(s))}onMouseEnter(e){var t=this[_e],r=e.object;if(r&&!fe.getIgnore(r,"ignoreEvent")){var s=t.mouseEnterObject=this.filterObject(r);if(s)return t.enableOutlineColor&&(r.app.trigger(ye,{object:s,value:t.outlineColor},{tag:"ObjectEvent"}),t.mouseEnterObject.on(THING.EventType.BeforeDestroy,(()=>{t.mouseEnterObject=null}),"__CampusLevelControl__Destroy__")),s}}onMouseLeave(e){var t=this[_e],r=t.mouseEnterObject;if(r)return t.enableOutlineColor&&r.app.trigger(ye,{object:r,value:null},{tag:"ObjectEvent"}),r.off(THING.EventType.BeforeDestroy,"__CampusLevelControl__Destroy__"),t.mouseEnterObject=null,r}onDBLClick(e){var t=this[_e];if(0===e.button){if(t.mouseEnterObject){var r=t.mouseEnterObject;this.onMouseLeave(),r.app.level.change(r)}}else 2===e.button&&(t.mouseEnterObject&&this.onMouseLeave(),t.backLevel())}shouldOutline(e){return!0}get enableFly(){return this[_e].enableFly}set enableFly(e){this[_e].enableFly=e}get enableSkipLevel(){return this[_e].enableSkipLevel}set enableSkipLevel(e){this[_e].enableSkipLevel=e}get enableOutlineColor(){return this[_e].enableOutlineColor}set enableOutlineColor(e){this[_e].enableOutlineColor=e}get enableMouseEvent(){return this[_e].enableMouseEvent}set enableMouseEvent(e){var t=this[_e];t.enableMouseEvent!==e&&(t.enableMouseEvent=e,this.isRunning&&(e?t.registerMouseEvent():t.unregisterMouseEvent()))}get outlineColor(){return this[_e].outlineColor}set outlineColor(e){this[_e].outlineColor=e}get isDefaultLevelControl(){return!0}}var Me=Symbol("private");class Te extends Ce{constructor(e){super(e);var t=this[Me]={},r=null;t.setEnvMap=(e,t)=>{r=t;var s=e.getAutoEnvMap();if(s){var n=s[t];n&&n.waitForComplete().then((()=>{r===t&&(this.app.envMap=n)}))}}}onEnter(e){var t=this[Me],r=e.current;return t.setEnvMap(r,"outer"),super.onEnter(e)}onLeave(e){var t=this[Me],r=e.current,s=e.next;return s&&s.isBuilding&&t.setEnvMap(r,"inner"),super.onLeave(e)}onSetEffect(e){var t=e.current;t&&this.showCampus(t)}filterObject(e){return e.parents.find("tags:or(Misc,Ground)")?null:super.filterObject(e)}showCampus(e){e.children.forEach((e=>{if(e.tags.has("Building")){var t=e;t.setVisible(!0,!1);var r=t.find("tags:or(Facade,Roof)"),s=fe.compatibilityConstantShowStruct(t);t.children.forEach((e=>{var t=e.tags;t.has("Floor")?fe.setFloorVisibleInCampusLevel(e,r,s):t.has("Facade")||t.has("Roof")?fe.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!0,!1)})):fe.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)}))}))}else fe.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!0,!1)}))}))}onFlyTo(e){var t=e.target;if(t&&t.isObject3D){var r=t.boundingBox;e.position=a.getNearestObjectPosition({target:t,boundingBox:r,radius:Math.min(r.radius,300),camera:this.app.camera}),e.target=r.center}return super.onFlyTo(e)}}var Je=Symbol("private");class we extends Ce{constructor(e){super(e);var t=this[Je]={};t.hideObjects=[],t.enableExpandFloors=!1}onEnter(e){var t=this[Je],r=super.onEnter(e),s=e.current;return t.enableExpandFloors&&s.expandFloors(),r}onLeave(e){var t=this[Je];return super.onLeave(e),new Promise((r=>{var s=e.current;t.enableExpandFloors&&s.expanded?s.unexpandFloors({duration:1,onComplete:r}):r()}))}onSetEffect(e){var t=e.current;if(t){var r=this[Je];t.brothers.forEach((e=>{fe.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)}))})),t.children.forEach((e=>{var t=e.tags;t.has("Floor")?(e.setVisible(!0,!1),fe.traverseByIgnore(e,"ignoreVisible",(t=>{if(t!=e){var r=t.tags;r.has("BuildingElement")?t.setVisible(!(r.has("RoomRoof")||r.has("Roof")),!1):t.setVisible(!0,!1)}}))):t.has("Facade")||t.has("Roof")?fe.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)})):fe.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!0,!1)}))})),t.parent.brothers.forEach((e=>{fe.traverseByIgnore(e,"ignoreVisible",(e=>{e.isLight||e.isCamera||(r.hideObjects.push(e),e.setVisible(!1,!1))}))}))}}onResetEffect(e){var t=e.current,r=e.next;if(!r||t.parent==r){var s=this[Je];s.hideObjects.forEach((e=>{e.setVisible(!0,!1)})),s.hideObjects.length=0}}shouldOutline(e){if(e){if(e.isDoor||e.isWindow)return!0;var t=e.tags;if(t.has("Wall"))return!0;if(t.has("BuildingElement"))return!0}return!1}get enableExpandFloors(){return this[Je].enableExpandFloors}set enableExpandFloors(e){this[Je].enableExpandFloors=e}onFlyTo(e){var t=e.target;if(t&&t.isObject3D){var r=t.floors,s=new THING.Selector;r.forEach((e=>{e.walls.forEach((e=>{s.push(e)}))}));var n=s.getBoundingBox();e.position=a.getNearestObjectPosition({target:t,boundingBox:n,camera:this.app.camera}),e.target=n.center}return super.onFlyTo(e)}}class Se extends Ce{constructor(e){super(e)}onSetEffect(e){var t=e.current;t&&(fe.traverseByIgnore(t,"ignoreVisible",(e=>{e.tags.has("RoomRoof")||e.tags.has("Roof")?e.setVisible(!1,!1):e.setVisible(!0,!1)})),t.brothers.forEach((e=>{fe.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)}))})))}filterObject(e){return e.tags.has("Wall")||e.tags.has("Slab")||e.tags.has("Roof")||e.tags.has("Ceiling")||e.parents.find("tags:or(Misc,Wall)")?null:super.filterObject(e)}onFlyTo(e){var t=e.target;if(t&&t.isObject3D){var r=t.boundingBox;e.position=a.getNearestObjectPosition({target:t,boundingBox:r,camera:this.app.camera}),e.target=r.center}return super.onFlyTo(e)}}var Re=Symbol("private");class Ee extends Ce{constructor(e){super(e),(this[Re]={}).transparentObjects=[]}onSetEffect(e){var t=this[Re],r=e.current;if(r){var s=r.brothers;fe.traverseByIgnore(r,"ignoreStyle",(e=>{e.body.style.opacity=null})),s.forEach((e=>{var r=e.find("tags:or(RoomFloor)");r&&fe.traverseByIgnore(r,"ignoreStyle",(e=>{e.body.style.opacity=.25,t.transparentObjects.push(e)}))}))}}onResetEffect(){var e=this[Re];e.transparentObjects.forEach((e=>{e.style.opacity=null})),e.transparentObjects.length=0}filterObject(e){var t=e.tags;return e.tags.has("Wall")||(t.has("RoomFloor")||t.has("RoomCeiling")||t.has("RoomRoof"))&&e.parent==e.app.level.current||e.parents.find("tags:or(Misc,Wall)")?null:super.filterObject(e)}onFlyTo(e){var t=e.target;if(t&&t.isObject3D){var r=t.boundingBox;e.position=a.getNearestObjectPosition({target:t,boundingBox:r,camera:this.app.camera}),e.target=r.center}return super.onFlyTo(e)}}var Ie=Symbol("private");class Pe extends Ce{constructor(e){super(e);var t=this[Ie]={};t.transparentObjects=[],t.filterBuildingElementOfIndoor=e=>{if(e.app.level.current.parents.find("tags:or(Floor)")){var t=e.tags;if(t.has("RoomFloor"))return!0;if(t.has("RoomCeiling"))return!0;if(t.has("RoomRoof"))return!0;if(t.has("Wall"))return!0}return!1}}onSetEffect(e){var t=this[Ie],r=e.current;if(r){var s=r.brothers;fe.traverseByIgnore(r,"ignoreStyle",(e=>{e.body.style.opacity=null})),s.forEach((e=>{e.tags.has("Misc")||fe.traverseByIgnore(e,"ignoreStyle",(e=>{fe.isGeneralObject(e.tags)&&(e.destroyed||(e.body.style.opacity=.25,t.transparentObjects.push(e)))}))}))}}onResetEffect(){var e=this[Ie];e.transparentObjects.forEach((e=>{fe.traverseByIgnore(e,"ignoreStyle",(e=>{e.destroyed||(e.body.style.opacity=null)}))})),e.transparentObjects.length=0}filterObject(e){var t=this[Ie];return e.parents.find("tags:or(Misc,Ground)")||t.filterBuildingElementOfIndoor(e)?null:super.filterObject(e)}}var De=Symbol("private"),Ne=[0,0],Oe=[1,1],Le={textureType:"HTMLElement"};class Fe extends THING.BaseResolver{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e);var t=this[De]={},r=e.data;t.styles=r&&r.styles||[],t.textureResourceMap={},t.textureLoadingMap={},t.materialResources=[],t.materialLoadings=[],t.stylesMap={},t.spliceUniqueKey=function(e){var t=e.map,r=e.uv;return e.aoMap&&(t+="_"+e.aoMap),e.transparent&&(t+="_"+e.transparent),e.sideType&&(t+="_"+e.sideType),e.defineFloorAo&&(t+="_"+e.defineFloorAo),e.defineWallAo&&(t+="_"+e.defineWallAo),e.color&&(t+="_"+e.color),r&&(r.angle&&(t+="_"+r.angle),r.repeat&&(t+="_"+r.repeat[0]+"_"+r.repeat[1]),r.center&&(t+="_"+r.center[0]+"_"+r.center[1]),r.offset&&(t+="_"+r.offset[0]+"_"+r.offset[1])),t+="_"+e.metalness,t+="_"+e.roughness},t.getUvMatrix=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.angle||0,r=e.center||Ne,s=e.repeat||Oe,n=e.offset||Ne,o=THING.MathUtils.degToRad(t),i=Math.cos(o),a=Math.sin(o);return[s[0]*i,-s[1]*a,0,s[0]*a,s[1]*i,0,-s[0]*(i*r[0]+a*r[1])+r[0]+n[0]+l(),-s[1]*(-a*r[0]+i*r[1])+r[1]+n[1],1]},t.createMaterialResourceByIndex=function(e,r,s){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=t.materialResources[e],i=t.materialLoadings[e];if(!o){var l=t.styles[e],h=[],c=l.map&&t.createImageTextureResource(l.map,h),u=l.aoMap&&t.createImageTextureResource(l.aoMap,h),p=t.getUvMatrix(l.uv);t.materialResources[e]=o=a.createObject("MaterialResource",{type:"Standard",map:c,aoMap:u,color:l.color,transparent:a.parseBoolean(l.transparent,!1),side:l.sideType||THING.SideType.Front,uvMatrix:p,defineFloorAo:a.parseBoolean(l.defineFloorAo,!1),defineWallAo:a.parseBoolean(l.defineWallAo,!1),metalness:l.metalness,roughness:l.roughness,defineUsePickId:a.parseBoolean(n.defineUsePickId,!1)}),i=t.materialLoadings[e]=Promise.all(h)}return i.then(r,s),o},t.createImageTextureResource=function(e,r){var s=t.textureResourceMap[e],n=t.textureLoadingMap[e];if(!s){s=a.createObject("ImageTextureResource",Le);var o=a.getCurrentApp().loadImageTexture(e);n=t.textureLoadingMap[e]=new Promise(((e,t)=>{o.waitForComplete().then((()=>{s.setImage(o.resource),s.setWrapS(THING.ImageWrapType.Repeat),s.setWrapT(THING.ImageWrapType.Repeat),e(s)}),t)})),t.textureResourceMap[e]=s}return r.push(n),s},t.addData=function(e){var r=t.spliceUniqueKey(e),s=t.stylesMap[r];return a.isNull(s)&&(s=t.styles.push(e)-1,t.stylesMap[r]=s),s}}getData(){return{styles:this[De].styles}}getMaterialResourceDataByIndex(e){return this[De].styles[e]}createMaterialResourceByIndex(e,t,r){return this[De].createMaterialResourceByIndex(e,t,r)}setMaterialResourceData(e){return this[De].addData(e)}}var Ae=Symbol("private");class ze extends THING.Component{constructor(e){super(e);var t=this[Ae]={};t.materialResourceResolver=null,t.materialResourceIndex=null,t.materialResourceData=null}onImport(e,t){if(e){var r=this[Ae];!r.materialResourceResolver&&t.getResolver&&(r.materialResourceResolver=t.getResolver("MaterialResourceResolver")),r.materialResourceResolver&&a.isNumber(e.materialResource)&&(r.materialResourceIndex=e.materialResource,r.materialResourceData=r.materialResourceResolver.getMaterialResourceDataByIndex(e.materialResource))}}onExport(e){var t=this[Ae],r=e.getResolver("MaterialResourceResolver");return r||(r=new Fe,e.registerResolver("MaterialResourceResolver",r)),t.materialResourceResolver=r,t.materialResourceData?{materialResource:r.setMaterialResourceData(t.materialResourceData)}:null}loadMaterialResource(e,t){var r=this[Ae];return r.materialResourceData?r.materialResourceResolver.createMaterialResourceByIndex(r.materialResourceIndex,(()=>{e&&e()}),(()=>{t&&t()})):(e(),null)}get materialResourceResolver(){return this[Ae].materialResourceResolver}}var je=Symbol("private"),Be="ModelWall",ke="TextureWall",Ge=[0,0,0],Ue=[0,0,0],He=[0,0,0],Ve={};class We extends ze{constructor(e){super(e);var t=this[je]={};t.data=null,t.dataType=null,t.pickIds=null,t.materialResourcesData=[],t.setData=(e,r)=>{e&&(t.toolkit=r,t.data=e,t.dataType=e.type,t.pickIds=e.pickIds,t.walls=e.walls,t.envMap=t.data.envMap,t.materialExtendOptions={defineUsePickId:!!t.pickIds},e.type===Be?t._parseModelWalls(e.walls):t._parseTextureWalls(e.walls))},t.getData=e=>{var r={type:t.dataType};return t.pickIds&&(r.pickIds=t.pickIds),t.walls&&(r.walls=t.walls,t.dataType===ke?t.walls.forEach((e=>{var r=t.materialResourcesData[e.leftMaterial];e.leftMaterial=this.materialResourceResolver.setMaterialResourceData(r);var s=t.materialResourcesData[e.rightMaterial];e.rightMaterial=this.materialResourceResolver.setMaterialResourceData(s);var n=t.materialResourcesData[e.edgeMaterial];e.edgeMaterial=this.materialResourceResolver.setMaterialResourceData(n)})):t.walls.forEach((t=>{var r=e.tsfResolver.getIndexByURI(t.model);t.model=r}))),r},t.load=e=>t.dataType===Be?t._loadModelWall(e):t.dataType===ke?t._loadTextureWall(e):Promise.resolve(),t._resolveModelURL=e=>{if(!t.toolkit)return e;var r=t.toolkit.pathResolver;return r?r.resolveModelURL(e):t.toolkit.resolveModelURL?t.toolkit.resolveModelURL(e):e},t._resolveTextureURL=e=>{if(!t.toolkit||!e)return e;var r=t.toolkit.pathResolver;return r?r.resolveTextureURL(e):t.toolkit.resolveTextureURL?t.toolkit.resolveTextureURL(e):e},t._getParserManager=()=>(t._parserManager||(t._parserManager=a.createObject("ParserManager")),t._parserManager),t._parseTextureWalls=e=>{e.forEach((e=>{e.height=a.parseNumber(e.height,3),e.thickness=a.parseNumber(e.thickness,.25)}))},t._loadTextureWall=e=>{var r={},s=[];return t.walls.forEach((e=>{!1!==e.visible&&((e=Object.assign({},e)).leftMaterial=t._loadMaterialResourceByIndex(e.leftMaterial,r),e.rightMaterial=t._loadMaterialResourceByIndex(e.rightMaterial,r),e.edgeMaterial=t._loadMaterialResourceByIndex(e.edgeMaterial,r),s.push(e))})),Promise.all(Object.values(r)).then((()=>{if(!e.destroyed){var r=t._getParserManager().parseWall(s,{pickIds:t.pickIds});e.body.setNode(r)}}))},t._loadMaterialResourceByIndex=(e,r)=>{if(a.isNull(e))return null;var s=t.materialResourcesData[e]=this.materialResourceResolver.getMaterialResourceDataByIndex(e);s.map=t._resolveTextureURL(s.map),s.aoMap=t._resolveTextureURL(s.aoMap);var n=r[e];if(n)return this.materialResourceResolver.createMaterialResourceByIndex(e);var o=null;return n=new Promise(((r,s)=>{o=this.materialResourceResolver.createMaterialResourceByIndex(e,r,s,t.materialExtendOptions)})),r[e]=n,o},t._parseModelWalls=e=>{e.forEach((e=>{var r=e.model;e.model=t._getModelByIndex(r)}))},t._loadModelWall=function(){var e=me((function*(e){for(var r=t.walls,s={},n={},o=t._getCubeTextureByIndex(t.envMap),i=function*(){var o=r[a],i=o.model,l=i.url;if(!1===o.visible||!l)return"continue";var h=i.size||Ve[l];h||(h=yield t._getModelSize(l,e)),Ve[l]=h;var c=t._generateModelWallTransfrom(o,h);if(t.pickIds){var u=t.pickIds[a],p=[];c.forEach((e=>{p.push(u)})),n[l]=n[l]?n[l].concat(p):p}s[l]=s[l]?s[l].concat(c):c},a=0;a<r.length;a++)yield*i();for(var l=Object.keys(s),h=[],c=0;c<l.length;c++){var u=l[c],p=s[u];h[c]=t._mergeCreate(u,p,n[u],o,e)}return Promise.all(h)}));return function(t){return e.apply(this,arguments)}}(),t._getModelByIndex=e=>t.toolkit.tsfResolver?{url:t.toolkit.tsfResolver.getURIByIndex(e)}:t.toolkit.getModelDataByIndex?t.toolkit.getModelDataByIndex(e):void 0,t._getCubeTextureByIndex=e=>{var r=null;return t.toolkit.getModelDataByIndex&&a.isNumber(t.envMap)&&(r=t.toolkit.getCubeTextureByIndex(e)),r},t._generateModelWallTransfrom=(e,r)=>{for(var s=[],n=e.points,o=[n[0],0,n[1]+l()],i=[n[2]+l(),0,n[3]],h=e.holes,c=e.height,u=e.thickness,p=t._generateLines(o,i,h),d=THING.MathUtils.normalizeVector(THING.MathUtils.subVector(i,o)),g=THING.MathUtils.getQuatFromUnitVectors([-1,0,0],d),v=THING.MathUtils.getEulerFromQuat(g),m=[THING.MathUtils.radToDeg(v[0]),THING.MathUtils.radToDeg(v[1]),THING.MathUtils.radToDeg(v[2])],f=THING.MathUtils.scaleVector(d.concat(),r[0]/2),y=THING.MathUtils.scaleVector(d.concat(),r[0]),x=0==c?.001:c/r[1],b=0==u?.001:u/r[2],_=0;_<p.length;_++){var C=p[_],M=THING.MathUtils.getDistance(C.start,C.end)/r[0],T=M%1;if(M=Math.floor(M),1==(M+=1)){var J=THING.MathUtils.getPointOnLine(C.start,C.end,.5),w=THING.MathUtils.createMat4([J[0],0,J[2]],m,[T,x,b]);s.push(w)}else for(var S=void 0,R=void 0,E=0;E<M;E++){var I=THING.MathUtils.getPointOnLine(C.start,C.end,E),P=[I[0],0,I[2]];0==E?(S=THING.MathUtils.addVector(P,f),R=1):E==M-1?(S=THING.MathUtils.addVector(S,THING.MathUtils.scaleVector(d.concat(),r[0]/2+r[0]*T/2)),R=T):(S=THING.MathUtils.addVector(S,y),R=1);var D=THING.MathUtils.createMat4([S[0],0,S[2]],m,[R,x,b]);s.push(D)}}if(a.parseBoolean(e.fillHole,!1)&&h)for(var N=0;N<h.length;N++){var O=h[N],L=O.size,F=O.loc,A=F[1],z=THING.MathUtils.getPointOnLine(o,i,F[0]),j=L[0]/r[0];if(A>=.001){var B=c*A/r[1],k=THING.MathUtils.createMat4([z[0],0,z[2]],m,[j,B,b]);s.push(k)}if(A<1){var G=(1-A)*c-L[1];if(G>0){var U=G/r[1],H=THING.MathUtils.createMat4([z[0],c-G,z[2]],m,[j,U,b]);s.push(H)}}}return s},t._generateLines=(e,t,r)=>{var s=[],n=THING.MathUtils.getDistance(e,t);if(r&&r.length>0){for(var o=0;o<r.length-1;o++)for(var i=0;i<r.length-1-o;i++)if(r[i].loc[0]>r[i+1].loc[0]){var a=r[i];r[i]=r[i+1],r[i+1]=a}var l=null;r.forEach((r=>{var o,i,a=r.loc,h=r.size[0]/n,c=a[0]-h/2;l?(o=THING.MathUtils.getPointOnLine(e,t,l),i=THING.MathUtils.getPointOnLine(e,t,c)):(o=THING.MathUtils.getPointOnLine(e,t,0),i=THING.MathUtils.getPointOnLine(e,t,c)),s.push({start:o,end:i}),l=c+h})),l<1&&s.push({start:THING.MathUtils.getPointOnLine(e,t,l),end:THING.MathUtils.getPointOnLine(e,t,1)})}else s.push({start:e,end:t});return s},t._mergeCreate=(e,t,r,s,n)=>{var o={matrices:t,lights:!0,pickIds:r};return s&&(o.envMap=s.getTextureResource()),new Promise((function(r,s){t&&t.length&&n.app.resourceManager.loadModel(e,(e=>{n.destroyed||(e.node.setStyle(n.bodyNode.getStyle()),n.bodyNode.add(e.node)),r()}),void 0,(e=>{s(e),console.error(e)}),o)}))},t._getModelSize=function(){var e=me((function*(e,t){return new Promise(((r,s)=>{t.app.resourceManager.loadModel(e,(function(e){var t=e.node.getOBB({center:Ge,halfSize:Ue,rotation:He}).halfSize,s=[2*t[0],2*t[1],2*t[2]];e.node.dispose(),r(s)}),(function(){}),s)}))}));return function(t,r){return e.apply(this,arguments)}}()}onImport(e,t){e&&(super.onImport(e,t),this[je].setData(e,t))}onExport(e){return super.onExport(e),this[je].getData(e)}onLoadResource(){return this[je].load(this.object)}}a.registerClass("WallComponent",We);var qe=Symbol("private"),Qe=[0,0,0,1],Ye={};class Ze extends ze{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ye;super(e);var t=this[qe]={dynamic:e.dynamic,points:null,holes:null};Qe[1]=l(),t.setData=e=>{t.alwaysHide=e.alwaysHide,t.uv=e.uv;var r=this.object.parent.external;t.selfPoints=e.points,!t.selfPoints&&r&&(t.selfPoints=r.points),t.selfHoles=e.holes,!t.selfHoles&&r&&(t.selfHoles=r.holes),t.instanceGroupName=e.instanceGroupName},t.getData=e=>{!0===t.alwaysHide&&(e.alwaysHide=t.alwaysHide);var r=this.object.parent.external;return r&&r.points||(t.selfPoints&&(e.points=t.selfPoints),t.selfHoles&&(e.holes=t.selfHoles)),e},t.create=function(e,r){var s=a.createObject("ExtrudeShape",{materialResource:r});s.setQuaternion(Qe),e.body.setNode(s),s.begin(),s.setPoints(a.cloneObject(this.selfPoints,!1)),this.selfHoles&&s.setHoles(a.cloneObject(this.selfHoles,!1)),s.end(),t.updateVertexUV(e),t.instanceGroupName&&(e.instanceGroupName=t.instanceGroupName,e.makeInstancedDrawing(!0))},t.updateVertexUV=function(e){for(var r,s,n,o,i,a,l,h=e.node._node.geometry.attributes.a_Uv.buffer,c=h.array,u=(r=t.uv,s=r.offset||[0,0],n=r.repeat||[1,1],o=r.center||[0,0],i=(r.rotation||0)*Math.PI/180,a=Math.cos(i),l=Math.sin(i),[n[0]*a,-n[1]*l,0,n[0]*l,n[1]*a,0,-n[0]*(a*o[0]+l*o[1])+o[0]+s[0],-n[1]*(-l*o[0]+a*o[1])+o[1]+s[1],1]),p=0;p<c.length;p+=2){var d=g(c[p],c[p+1],u);c[p]=d[0],c[p+1]=d[1]}function g(e,t,r){return[r[0]*e+r[3]*t+1*r[6],r[1]*e+r[4]*t+1*r[7]]}h.version++}}onImport(e,t){super.onImport(e,t),this[qe].setData(e)}onExport(e){var t=super.onExport(e);return this[qe].getData(t),t}onLoadResource(){var e=this[qe];return new Promise(((t,r)=>{if(e.alwaysHide)t();else var s=this.loadMaterialResource((()=>{e.create(this.object,s),t()}),r)}))}}a.registerClass("PlaneComponent",Ze);var Xe=Symbol("private"),Ke=[0,0,0,1],$e={};class et extends ze{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:$e),this[Xe]={};var e=this[Xe];Ke[1]=l(),e.setData=t=>{e.planes=t.planes,e.vertexData={indices:[],positions:[],normals:[],uvs:[]};for(var r=0;r<e.planes.length;r++)e.getvertexData(e.vertexData,e.planes[r])},e.create=(t,r)=>{var s=a.createObject("GeometryResource"),n=e.buildVertexBuffer(e.vertexData);s.setVertexData(n);var o=a.createObject("CustomNode",{geometryResource:s,materialResource:r});o.setQuaternion(Ke),t.body.setNode(o)},e.buildVertexBuffer=e=>{for(var t=[{name:"positions",stride:3},{name:"normals",stride:3},{name:"uvs",stride:2}],r={vertexBuffer:[],attributes:{},indices:[]},s=0;s<t.length;s++){var n=t[s].name,o=e[n];if(o){var i=t[s].stride;r.vertexBuffer.push({array:o,stride:i}),r.attributes[n]=r.vertexBuffer.length-1}}return e.indices&&(r.indices=e.indices.slice(0)),r},e.getvertexData=function(){var t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1?arguments[1]:void 0,n=s.components[0].external,o=n.points.map((e=>(e[1]=-e[1],e))),i=null===(t=n.holes)||void 0===t?void 0:t.map((e=>e.map((e=>(e[1]=-e[1],e))))),a=THING.PolygonBuilder.getGeometryData({contour:o,holes:i});e.updateVertexUV(s,a.uvs);for(var l=r.positions.length/3,h=0;h<a.indices.length;h++)a.indices[h]+=l;for(var c=[],u=THING.MathUtils.getQuatFromAngles([-90,0,0]),p=0;p<a.positions.length;p+=3)c[0]=a.positions[p],c[1]=a.positions[p+1],c[2]=a.positions[p+2],THING.MathUtils.vec3ApplyQuat(c,u,c),a.positions[p]=c[0],a.positions[p+1]=c[1],a.positions[p+2]=c[2],a.normals[p]=0,a.normals[p+1]=1,a.normals[p+2]=0;r.indices.push(...a.indices),r.positions.push(...a.positions),r.normals.push(...a.normals),r.uvs.push(...a.uvs)},e.updateVertexUV=(e,t)=>{for(var r,s,n,o,i,a,l,h=(r=e.components[0].external.uv,s=r.offset||[0,0],n=r.repeat||[1,1],o=r.center||[0,0],i=(r.rotation||0)*Math.PI/180,a=Math.cos(i),l=Math.sin(i),[n[0]*a,-n[1]*l,0,n[0]*l,n[1]*a,0,-n[0]*(a*o[0]+l*o[1])+o[0]+s[0],-n[1]*(-l*o[0]+a*o[1])+o[1]+s[1],1]),c=0;c<t.length;c+=2){var u=p(t[c],t[c+1],h);t[c]=u[0],t[c+1]=u[1]}function p(e,t,r){return[r[0]*e+r[3]*t+1*r[6],r[1]*e+r[4]*t+1*r[7]]}}}onImport(e,t){super.onImport(e,t),this[Xe].setData(e)}onLoadResource(){var e=this[Xe];return new Promise(((t,r)=>{var s=this.loadMaterialResource((()=>{e.create(this.object,s),t()}),r)}))}}a.registerClass("CombinePlaneComponent",et);var tt=0;class rt extends THING.SceneBundleLoader{constructor(){super(),this._useDefaultTheme=!0}parseOptions(e,t){if(!(t=Object.assign({},t)).owner){var r=Object.assign({},t);r.url=null,r.complete=r.onComplete=null,t.owner=new THING.Object3D(r),t.owner._isTempRoot=!0}var s=t._index_;a.isValid(s)&&(t.progressParam={index:s,progress:0}),this._useDefaultTheme=a.parseBoolean(t.useDefaultTheme,!0),e.info.main&&(t.mainFileUrl=e.url._appendPath(e.info.main)),e.name=e.info.name;var n=t.onUpdateCreateOptions;t.onUpdateCreateOptions=(e,t,r)=>(n&&(r=n(e,t,r)),this.onUpdateCreateOptions(e,t,r));var o=t.onCreateObject;return t.onCreateObject=(e,t,r)=>{this.onCreateObject(e,t,r),o&&o(e,t,r)},t}onLoad(e,t){var r=(t=this.parseOptions(e,t)).owner.app;r.on(x,(e=>{e[_]&&(tt=.9)})),r.trigger(b),this.initLoadingBar(t),this.onLoadSceneFile(e,t).then((r=>{this.onLoadScene(e,t,r)}))}onLoadSceneFile(e,t){var r=a.parseBoolean(t.useCache,!0);return a.loadJSONFile(t.mainFileUrl,(()=>{}),(()=>{}),(()=>{}),{useCache:r})}onLoadScene(e,t,r){(new THING.SceneLoaderOld).parse(THING.SceneResourceType.Object,r,(r=>{this.onLoadComplete(r,e,t)}),(e=>{this.onProgressUpdate(t,e)}),t.onError,t)}onProgressUpdate(e,t){var r=t.progress;e.progressParam&&(e.progressParam.progress=r,r=e.progressParam),e.onProgress(r),e.owner.loadingBar&&(e.owner.loadingBar.value=t.progress)}onLoadComplete(e,t,r){var s=r.owner,n=s.children,o=s.app;if(n.length){var i=n.query(".Campus"),l=i.length?i[0]:null;if(s._isTempRoot||(l=s,i=[s]),0!==i.length)a.parseValue(r.dynamic,!1)&&i.forEach((e=>{e.onNotifyComplete()}));t.objects=e.objects,t.campus=l,t.campuses=i,s._isTempRoot&&s.children.forEach((e=>{o.root.add(e)})),s.loadingBar?s.loadingBar.fadeOut({time:800,delayTime:200}).then((()=>{s._isTempRoot&&s.destroy()})):s._isTempRoot&&s.destroy(),i.forEach((e=>{e.on(THING.EventType.Destroy,(e=>{var r=t.campuses.indexOf(e.object);t.campuses.splice(r,1)}))}));var h=e.envMap;h&&(o.view._compatibleRender&&(h.inner||(h.inner=a.getBlackEnvMap()),i.forEach((e=>{e.setAutoEnvMap(h)}))),h.outer&&h.outer.waitForComplete().then((()=>{o.envMap=h.outer}))),r.onComplete();var c={bundle:t};c.campuses=i,l&&(c.campus=l),o.trigger(THING.EventType.Load,c)}else r.onComplete()}onUpdateCreateOptions(e,t,r){var s=l()||tt;if(this._useDefaultTheme&&this._parseCreateOptionsWithTheme(e,t,r),s){var n=a.parseValue(r.localQuaternion,[0,0,0,1]);r.localQuaternion=[n[0],n[1]+s,n[2],n[3]]}return r}onCreateObject(e,t,r){this._useDefaultTheme&&this._processOnCreateWithTheme(t,r);var s=t.resource;a.isValid(s.instanceId)&&t.makeInstancedDrawing(!0)}initLoadingBar(e){a.parseValue(e.progressBarVisible,!0)&&super.initLoadingBar(e.owner)}_parseCreateOptionsWithTheme(e,t,r){for(var s,n=e;null!==n;){if(n.userData._themeTag){s=n.userData._themeTag;break}n=n.parent}if(s){var o=app.themeManager.getTheme(s),i=o.styles;if(o&&i){var a,l=i.class,h=r.userData||{},c=t.className;if(h._styleTag_&&l[h._styleTag_]?a=h._styleTag_:l[c]&&(a=c),a&&l[a]&&l[a].enable){h._themeTag=s,h._styleTag_=a;var u=r.style||{};r.userData=h,app.themeManager._setStylesConfig(s,l[a],u,a),r.style={default:u}}}}}_processOnCreateWithTheme(e,t){e.userData._themeTag&&e.waitForComplete().then((()=>{var t=e.userData._styleTag_,r=e.userData._themeTag;if(t&&r){var s=app.themeManager.getTheme(r),n=s.styles;if(s&&n){var o=n.class;e.style.beginDefaultValues(),app.themeManager._updateScrollMapUv(r,o[t],e,t),e.style.endDefaultValues()}}}))}}class st extends Ce{onSetCamera(e){var t=e.path;if(t&&t[t.length-1].isRootObject)return super.onSetCamera(e);return null}}var nt=Symbol("private");class ot{constructor(e){this.app=e,(this[nt]={}).controlsMap=new Map}setControlOption(e,t){this[nt].controlsMap.forEach((r=>{r.control[e]=t}))}addControl(e,t,r){if(r&&r.isDefaultLevelControl){var s=this[nt],n={control:r,condition:e,tag:"_"+t+"_Level_Control_Inside_"};this.removeControl(t),this.app.level.register(e,r,{tag:n.tag,priority:0}),s.controlsMap.set(t,n),Object.defineProperty(this,t,{get:()=>r,set:e=>{var r=s.controlsMap.get(t);r&&this.addControl(r.condition,t,e)},configurable:!0})}}removeControl(e){var t=this[nt],r=t.controlsMap.get(e);r&&(this.app.level.unregisterByControl(r.control),t.controlsMap.delete(e),delete this[e])}}var it=".RootObject",at="tags:or(Campus)",lt="tags:or(Building)",ht="tags:or(Floor)",ct="tags:or(Room)",ut="tags:or(Placement,Entity,Line,Geometry,Region,Window,Door)";function pt(e,t){var r=t.onComplete||t.complete;t.onComplete=t.complete=e=>{var t=e.objects;if(t){for(var s=[],n=0;n<t.length;n++){var o=t[n];o&&o.isCampus&&s.push(o)}e.campuses=s,e.campus=s[0]||null,r&&r(e)}else r&&r(e)}}class dt extends THING.MixLoader{onLoadModelScene(e,t){pt(0,t),super.onLoadModelScene(e,t)}onLoadTSFScene(e,t){pt(0,t),super.onLoadTSFScene(e,t)}}THING.App.addCompleteCallback((e=>{e.on(x,g),e.trigger(b),e.registerBundleLoader("scene",new rt),e.resourcePool.registerLoader("mix",dt),function(e){var t=e.level,r=new ot(e);r.addControl(it,"root",new st),r.addControl(at,"campus",new Te),r.addControl(lt,"building",new we),r.addControl(ht,"floor",new Se),r.addControl(ct,"room",new Ee),r.addControl(ut,"placement",new Pe),t.controls=r,t.setControlOption=(e,r)=>{a.warn("Please call 'app.level.controls.setControlOption()' instead"),t.controls.setControlOption(e,r)}}(e),setTimeout(v,100),d&&(o=.5),e.on(THING.EventType.AppQuit,(()=>{a.disposeBlackEnvMap()}),"_Campus_External_")}),-2);var gt=Object.freeze({__proto__:null,Building:D,BuildingLevelControl:we,Campus:M,CampusBundleLoader:rt,CampusLevelControl:Te,Ceiling:ee,CombinePlaneComponent:et,DefaultLevelControl:Ce,Door:k,EmptyObject:de,ExpandObjectsComponent:P,Facade:j,Floor:G,FloorLevelControl:Se,Ground:w,Group:pe,LevelControlOptions:{EnableFly:"enableFly",EnableSkipLevel:"enableSkipLevel",EnableOutlineColor:"enableOutlineColor",EnableMouseEvent:"enableMouseEvent",OutlineColor:"outlineColor"},MaterialResourceResolver:Fe,Misc:J,PlacementLevelControl:Pe,PlaneComponent:Ze,Roof:$,Room:H,RoomLevelControl:Ee,Slab:se,Thing:ue,VideoProbe:ge,Wall:le,WallComponent:We,Window:ce});THING.Utils.registerClasses(gt,THING);void 0!==M&&(M.className="Campus"),void 0!==T&&(T.className="BaseParser"),void 0!==J&&(J.className="Misc"),void 0!==w&&(w.className="Ground"),void 0!==P&&(P.className="ExpandObjectsComponent"),void 0!==D&&(D.className="Building"),void 0!==N&&(N.className="PartialModelParser"),void 0!==L&&(L.className="InstanceParser"),void 0!==F&&(F.className="MaterialParser"),void 0!==j&&(j.className="Facade"),void 0!==k&&(k.className="Door"),void 0!==G&&(G.className="Floor"),void 0!==U&&(U.className="SpaceComponent"),void 0!==H&&(H.className="Room"),void 0!==V&&(V.className="MaterialResourceManager"),void 0!==W&&(W.className="PlaneTextureParser"),void 0!==Q&&(Q.className="PlaneParser"),void 0!==X&&(X.className="BasePlane"),void 0!==$&&($.className="Roof"),void 0!==ee&&(ee.className="Ceiling"),void 0!==te&&(te.className="RoomParse"),void 0!==se&&(se.className="Slab"),void 0!==ne&&(ne.className="WallParser"),void 0!==le&&(le.className="Wall"),void 0!==he&&(he.className="WallExtend"),void 0!==ce&&(ce.className="Window"),void 0!==pe&&(pe.className="Group"),void 0!==de&&(de.className="EmptyObject"),void 0!==ge&&(ge.className="VideoProbe"),void 0!==fe&&(fe.className="LevelControlHelper"),void 0!==Ce&&(Ce.className="DefaultLevelControl"),void 0!==Te&&(Te.className="CampusLevelControl"),void 0!==we&&(we.className="BuildingLevelControl"),void 0!==Se&&(Se.className="FloorLevelControl"),void 0!==Ee&&(Ee.className="RoomLevelControl"),void 0!==Pe&&(Pe.className="PlacementLevelControl"),void 0!==Fe&&(Fe.className="MaterialResourceResolver"),void 0!==ze&&(ze.className="MaterialResourceComponent"),void 0!==We&&(We.className="WallComponent"),void 0!==Ze&&(Ze.className="PlaneComponent"),void 0!==et&&(et.className="CombinePlaneComponent"),void 0!==rt&&(rt.className="CampusBundleLoader"),void 0!==st&&(st.className="RootLevelControl"),void 0!==ot&&(ot.className="LevelControls"),void 0!==dt&&(dt.className="CampusMixLoader");var vt=Object.freeze({__proto__:null,Building:D,BuildingLevelControl:we,COMPILETIME:"Fri, 10 Nov 2023 08:01:18 GMT",Campus:M,CampusBundleLoader:rt,CampusLevelControl:Te,Ceiling:ee,CombinePlaneComponent:et,DefaultLevelControl:Ce,Door:k,EmptyObject:de,ExpandObjectsComponent:P,Facade:j,Floor:G,FloorLevelControl:Se,Ground:w,Group:pe,MaterialResourceResolver:Fe,Misc:J,PlacementLevelControl:Pe,PlaneComponent:Ze,Roof:$,Room:H,RoomLevelControl:Ee,Slab:se,Thing:ue,Utils:a,VERSION:"1.0.304",VideoProbe:ge,Wall:le,WallComponent:We,Window:ce}),mt=["Entity","Facade","Placement","RoomFloor","RoomRoof","RoomCeiling","BuildingElement","Ground","Dummy","Wall","Group","Misc","Slab","Roof","Ceiling"],ft=0,yt=1,xt=2,bt="https://model.3dmomoda.com/models/",_t="https://static.3dmomoda.com/textures/",Ct="FacadeMain",Mt="Ground",Tt="Thing",Jt="Tree",wt="Objects",St="FloorFloor",Rt="FloorRoof",Et="FloorCeiling",It="FloorManualWall",Pt="Door",Dt={BC4ACD398A9640859A6B386E1BF9231D:{id:"BC4ACD398A9640859A6B386E1BF9231D",type:"Wall",size:[.8,2.999,.8],version:"5"},"25DFE916055244849463F89A03DA97CD":{id:"25DFE916055244849463F89A03DA97CD",type:"Wall",size:[.845,3.099,.849],version:"5"}},Nt={"3629A959F80C4D0EA31D1E26524735B8":{id:"3629A959F80C4D0EA31D1E26524735B8",type:"Placement",size:[8.1,9.60776,8.7],version:"7"},BB23ED379CFB4A0AB14BD124EC2995BE:{id:"BB23ED379CFB4A0AB14BD124EC2995BE",type:"Placement",size:[.64347,1.34912,.8],version:"7"},A7D96546FA744C38A949DFC6FEE43B6A:{id:"A7D96546FA744C38A949DFC6FEE43B6A",type:"Placement",size:[.6,1.1,.6],version:"7"},FA5766D2AA074128ABB5D4CA3FF45B36:{id:"FA5766D2AA074128ABB5D4CA3FF45B36",type:"Placement",size:[.4,.61599,.39999],version:"6"},"8EC4FF7178E64C538B215D69684E4F92":{id:"8EC4FF7178E64C538B215D69684E4F92",type:"Placement",size:[.4,.5,.4],version:"6"},"449c02c5e8f84a2aa32f58ed53aa24b9":{id:"449c02c5e8f84a2aa32f58ed53aa24b9",type:"Placement",size:[.23118,.5986,.24155],version:"1"},c26acc8a9f804d8da2f49aba46283ac3:{id:"c26acc8a9f804d8da2f49aba46283ac3",type:"Placement",size:[7.85544,7.80654,7.44832],version:"2"},"07b2d180e1ea42de98723fe147f6750a":{id:"07b2d180e1ea42de98723fe147f6750a",type:"Placement",size:[10.3207,9.84333,10.0598],version:"3"},"2c969242db5f4da58442182ccbda7471":{id:"2c969242db5f4da58442182ccbda7471",type:"Placement",size:[7.20139,25.1363,6.56474],version:"4"},D26DB25C34C94CAABF24FED40F1A9719:{id:"D26DB25C34C94CAABF24FED40F1A9719",type:"Placement",size:[8.24071,19.2,7.6],version:"6"},"ebafecf0-cc89-42dc-b847-0f841a31bdca":{id:"ebafecf0-cc89-42dc-b847-0f841a31bdca",type:"Placement",size:[4.94077,5.83847,4.78861],version:"9"},"4EF86FC4FFA44013AC4F45E8CD0D343F":{id:"4EF86FC4FFA44013AC4F45E8CD0D343F",type:"Placement",size:[5.66699,7.4,6.233],version:"6"},"9C27FD900C4443FBA1151C9DF767D19A":{id:"9C27FD900C4443FBA1151C9DF767D19A",type:"Placement",size:[7.50716,8.2,7.87936],version:"6"},"6b768c2d-3c2f-4954-a625-ef4b57f72a47":{id:"6b768c2d-3c2f-4954-a625-ef4b57f72a47",type:"Placement",size:[6.32989,7.49752,5.72546],version:"8"},"9fc66d5b-a213-4fc6-9fc6-f759aa88716a":{id:"9fc66d5b-a213-4fc6-9fc6-f759aa88716a",type:"Placement",size:[4.5,9.4,4.4],version:"4"},"963de658-70b6-49e7-bb0e-504ad603fe27":{id:"963de658-70b6-49e7-bb0e-504ad603fe27",type:"Placement",size:[1.4073,4.03187,1.37224],version:"5"},"d5b06cf7-2a31-4252-8d7c-02d48815ed18":{id:"d5b06cf7-2a31-4252-8d7c-02d48815ed18",type:"Placement",size:[7.3,7.4,6.1],version:"4"},"f9058709-ee84-41f6-8260-fbb734dc9483":{id:"f9058709-ee84-41f6-8260-fbb734dc9483",type:"Placement",size:[4.3,7.2,4],version:"4"},"be7d0bfc-ce60-4132-8a88-afd1301c82b3":{id:"be7d0bfc-ce60-4132-8a88-afd1301c82b3",type:"Placement",size:[4.41539,7.57112,4.49063],version:"5"},"95bd04fe237f42e0adeabb78028c8ee7":{id:"95bd04fe237f42e0adeabb78028c8ee7",type:"Placement",size:[4.41539,7.57112,4.49063],version:"1"},"1d2827ffd12b4ac1a2035fa81646a450":{id:"1d2827ffd12b4ac1a2035fa81646a450",type:"Placement",size:[12.63521,15.81749,13.21056],version:"3"}};function Ot(e,t,r,s,n,o,i){try{var a=e[o](i),l=a.value}catch(e){return void r(e)}a.done?t(l):Promise.resolve(l).then(s,n)}function Lt(e){return function(){var t=this,r=arguments;return new Promise((function(s,n){var o=e.apply(t,r);function i(e){Ot(o,s,n,i,a,"next",e)}function a(e){Ot(o,s,n,i,a,"throw",e)}i(void 0)}))}}function Ft(e){return Ft="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ft(e)}function At(e){var t=function(e,t){if("object"!==Ft(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var s=r.call(e,t||"default");if("object"!==Ft(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===Ft(t)?t:String(t)}function zt(e,t,r){return(t=At(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class jt{constructor(e){if(this._mode=3,this._bigVersion=null,this._smallVersion=null,this._version=e,e)if(isNaN(e)){var t=e.split(".");this._mode=parseInt(t[0]),t[1]&&(this._bigVersion=parseInt(t[1])),t[2]&&(this._smallVersion=parseInt(t[2]))}else this._mode=e}get versionText(){return this._version}get mode(){return this._mode}get bigVersion(){return this._bigVersion}get smallVersion(){return this._smallVersion}}class Bt extends THING.Utils{static vec3ApplyQuat(e,t,r){var s=e[0],n=e[1],o=e[2],i=t[0],a=t[1],l=t[2],h=t[3],c=h*s+a*o-l*n,u=h*n+l*s-i*o,p=h*o+i*n-a*s,d=-i*s-a*n-l*o;return void 0===r&&(r=[0,0,0]),r[0]=c*h+d*-i+u*-l-p*-a,r[1]=u*h+d*-a+p*-i-c*-l,r[2]=p*h+d*-l+c*-a-u*-i,r}static multiplyQuat(e,t){var r=e[0],s=e[1],n=e[2],o=e[3],i=t[0],a=t[1],l=t[2],h=t[3];return[r*h+o*i+s*l-n*a,s*h+o*a+n*i-r*l,n*h+o*l+r*a-s*i,o*h-r*i-s*a-n*l]}static saveDecimal(e,t){if("number"==typeof e)return o(e,t);if(e.length>0){for(var r=[],s=0;s<e.length;s++){var n=o(e[s],t);r.push(n)}return r}return e;function o(e,t){t=null==t?3:t;for(var r=1;t>0;r*=10,t--);for(;t<0;r/=10,t++);return Math.round(e*r)/r}}static floatEquals(e,t,r){if(void 0===e||void 0===t)return!1;if(void 0!==r&&0!=r||(r=.002),"number"==typeof e&&"number"==typeof t)return Math.abs(e-t)<=r;if(e.length>0&&t.length>0&&e.length==t.length){for(var s=0;s<e.length;s++){var n=e[s],o=t[s];if(Math.abs(n-o)>r)return!1}return!0}return!1}static parseModel(e,t,r,s){e.loadversion&&(t=new jt(e.loadversion));var n=1===t.bigVersion?yt:xt;e.localurl||(n=ft);var o=null;switch(n){case yt:o="https://www.thingjs.com/"+e.localurl;break;case xt:switch(s.bundleInfo={main:"index.json",type:"model"},o=r+e.localurl,delete e.version,delete e.resourceType,delete e.hasanimation,e.applyTransposeToMesh=!1,e.applyTransposeToVertices=!1,t.smallVersion){case 0:case 1:case 2:break;case 3:case 4:case 5:!0!==e.keeprootrotation&&(e.applyTransposeToMesh=!0);break;default:!0!==e.keeprootrotation&&(e.applyTransposeToVertices=!0)}delete e.keeprootrotation;break;default:o=e.id}e.url=o,delete e.id,delete e.localurl}static parseTexture(e,t){return{url:e.id+"."+e.ext,flipY:t||!1}}static versionControl(e,t){switch(e.bigVersion+"_"+e.smallVersion){case"0_0":case"0_1":case"1_0":case"1_1":return null}return ir.getIdOnesPlaceNumber(t)}static getParseCorners(e,t,r,s){var n=Bt.versionControl(s,r);if(t.corners&&t.corners[0][2]){e.corners=JSON.parse(JSON.stringify(t.corners));for(var o=0;o<e.corners.length;o++)e.corners[o][2]*=-1,n&&ir.decodeArray(0,e.corners[o],n,3)}}static getParseTransform(e,t,r,s){var n=Bt.versionControl(s,r);t.position&&(e.realPosition=[t.position[0],t.position[1],t.position[2]],e.realPosition[2]*=-1),t.rotation&&(e.realRotation=[t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]],e.realRotation[2]*=-1,e.realRotation[3]*=-1),t.scale&&(e.realScale=[t.scale[0],t.scale[1],t.scale[2]]),n&&(t.position&&ir.decodeArray(0,e.realPosition,n,3),t.rotation&&ir.decodeArray(0,e.realRotation,n,3),t.scale&&ir.decodeArray(1,e.realScale,n,3))}static loadFile(e,t){t.url=e;var r=new Promise(((r,s)=>{fetch(e+"index.json").then((e=>e.text())).then((e=>{t.index=JSON.parse(e),r()})).catch((e=>{console.error(e),s()}))})),s=new Promise(((r,s)=>{fetch(e+"scene.json").then((e=>e.text())).then((e=>{t.scene=JSON.parse(e),r()})).catch((e=>{console.error(e),s()}))}));return Promise.all([r,s])}static getBaseUrl(e){var t=e+"/";return"/"!==e.charAt(e.length-1)&&"\\"!==e.slice(e.length-1,e.length-2)||(t=e),t}}for(var kt=[],Gt=0;Gt<256;Gt++)kt[Gt]=(Gt<16?"0":"")+Gt.toString(16);var Ut=1234567,Ht={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(kt[255&e]+kt[e>>8&255]+kt[e>>16&255]+kt[e>>24&255]+"-"+kt[255&t]+kt[t>>8&255]+"-"+kt[t>>16&15|64]+kt[t>>24&255]+"-"+kt[63&r|128]+kt[r>>8&255]+"-"+kt[r>>16&255]+kt[r>>24&255]+kt[255&s]+kt[s>>8&255]+kt[s>>16&255]+kt[s>>24&255]).toUpperCase()},clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,r,s,n){return s+(e-t)*(n-s)/(r-t)},lerp:function(e,t,r){return(1-r)*e+r*t},smoothstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*(3-2*e)},smootherstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){return void 0!==e&&(Ut=e%2147483647),((Ut=16807*Ut%2147483647)-1)/2147483646},degToRad:function(e){return e*Ht.DEG2RAD},radToDeg:function(e){return e*Ht.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,r,s,n){var o=Math.cos,i=Math.sin,a=o(r/2),l=i(r/2),h=o((t+s)/2),c=i((t+s)/2),u=o((t-s)/2),p=i((t-s)/2),d=o((s-t)/2),g=i((s-t)/2);switch(n){case"XYX":e.set(a*c,l*u,l*p,a*h);break;case"YZY":e.set(l*p,a*c,l*u,a*h);break;case"ZXZ":e.set(l*u,l*p,a*c,a*h);break;case"XZX":e.set(a*c,l*g,l*d,a*h);break;case"YXY":e.set(l*d,a*c,l*g,a*h);break;case"ZYZ":e.set(l*g,l*d,a*c,a*h);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+n)}}};class Vt{constructor(e,t,r,s){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===s&&(s=1),Object.defineProperty(this,"isQuaternion",{value:!0}),this._x=e,this._y=t,this._z=r,this._w=s}static slerp(e,t,r,s){return r.copy(e).slerp(t,s)}static slerpFlat(e,t,r,s,n,o,i){var a=r[s+0],l=r[s+1],h=r[s+2],c=r[s+3],u=n[o+0],p=n[o+1],d=n[o+2],g=n[o+3];if(c!==g||a!==u||l!==p||h!==d){var v=1-i,m=a*u+l*p+h*d+c*g,f=m>=0?1:-1,y=1-m*m;if(y>Number.EPSILON){var x=Math.sqrt(y),b=Math.atan2(x,m*f);v=Math.sin(v*b)/x,i=Math.sin(i*b)/x}var _=i*f;if(a=a*v+u*_,l=l*v+p*_,h=h*v+d*_,c=c*v+g*_,v===1-i){var C=1/Math.sqrt(a*a+l*l+h*h+c*c);a*=C,l*=C,h*=C,c*=C}}e[t]=a,e[t+1]=l,e[t+2]=h,e[t+3]=c}static multiplyQuaternionsFlat(e,t,r,s,n,o){var i=r[s],a=r[s+1],l=r[s+2],h=r[s+3],c=n[o],u=n[o+1],p=n[o+2],d=n[o+3];return e[t]=i*d+h*c+a*p-l*u,e[t+1]=a*d+h*u+l*c-i*p,e[t+2]=l*d+h*p+i*u-a*c,e[t+3]=h*d-i*c-a*u-l*p,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,r,s){return this._x=e,this._y=t,this._z=r,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var r=e._x,s=e._y,n=e._z,o=e._order,i=Math.cos,a=Math.sin,l=i(r/2),h=i(s/2),c=i(n/2),u=a(r/2),p=a(s/2),d=a(n/2);switch(o){case"XYZ":this._x=u*h*c+l*p*d,this._y=l*p*c-u*h*d,this._z=l*h*d+u*p*c,this._w=l*h*c-u*p*d;break;case"YXZ":this._x=u*h*c+l*p*d,this._y=l*p*c-u*h*d,this._z=l*h*d-u*p*c,this._w=l*h*c+u*p*d;break;case"ZXY":this._x=u*h*c-l*p*d,this._y=l*p*c+u*h*d,this._z=l*h*d+u*p*c,this._w=l*h*c-u*p*d;break;case"ZYX":this._x=u*h*c-l*p*d,this._y=l*p*c+u*h*d,this._z=l*h*d-u*p*c,this._w=l*h*c+u*p*d;break;case"YZX":this._x=u*h*c+l*p*d,this._y=l*p*c+u*h*d,this._z=l*h*d-u*p*c,this._w=l*h*c-u*p*d;break;case"XZY":this._x=u*h*c-l*p*d,this._y=l*p*c-u*h*d,this._z=l*h*d+u*p*c,this._w=l*h*c+u*p*d;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+o)}return!1!==t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){var r=t/2,s=Math.sin(r);return this._x=e.x*s,this._y=e.y*s,this._z=e.z*s,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(e){var t=e.elements,r=t[0],s=t[4],n=t[8],o=t[1],i=t[5],a=t[9],l=t[2],h=t[6],c=t[10],u=r+i+c;if(u>0){var p=.5/Math.sqrt(u+1);this._w=.25/p,this._x=(h-a)*p,this._y=(n-l)*p,this._z=(o-s)*p}else if(r>i&&r>c){var d=2*Math.sqrt(1+r-i-c);this._w=(h-a)/d,this._x=.25*d,this._y=(s+o)/d,this._z=(n+l)/d}else if(i>c){var g=2*Math.sqrt(1+i-r-c);this._w=(n-l)/g,this._x=(s+o)/g,this._y=.25*g,this._z=(a+h)/g}else{var v=2*Math.sqrt(1+c-r-i);this._w=(o-s)/v,this._x=(n+l)/v,this._y=(a+h)/v,this._z=.25*v}return this._onChangeCallback(),this}setFromUnitVectors(e,t){var r=e.dot(t)+1;return r<1e-6?(r=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=r):(this._x=0,this._y=-e.z,this._z=e.y,this._w=r)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=r),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Ht.clamp(this.dot(e),-1,1)))}rotateTowards(e,t){var r=this.angleTo(e);if(0===r)return this;var s=Math.min(1,t/r);return this.slerp(e,s),this}identity(){return this.set(0,0,0,1)}inverse(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){var r=e._x,s=e._y,n=e._z,o=e._w,i=t._x,a=t._y,l=t._z,h=t._w;return this._x=r*h+o*i+s*l-n*a,this._y=s*h+o*a+n*i-r*l,this._z=n*h+o*l+r*a-s*i,this._w=o*h-r*i-s*a-n*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);var r=this._x,s=this._y,n=this._z,o=this._w,i=o*e._w+r*e._x+s*e._y+n*e._z;if(i<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,i=-i):this.copy(e),i>=1)return this._w=o,this._x=r,this._y=s,this._z=n,this;var a=1-i*i;if(a<=Number.EPSILON){var l=1-t;return this._w=l*o+t*this._w,this._x=l*r+t*this._x,this._y=l*s+t*this._y,this._z=l*n+t*this._z,this.normalize(),this._onChangeCallback(),this}var h=Math.sqrt(a),c=Math.atan2(h,i),u=Math.sin((1-t)*c)/h,p=Math.sin(t*c)/h;return this._w=o*u+this._w*p,this._x=r*u+this._x*p,this._y=s*u+this._y*p,this._z=n*u+this._z*p,this._onChangeCallback(),this}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}class Wt{constructor(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),Object.defineProperty(this,"isVector3",{value:!0}),this.x=e,this.y=t,this.z=r}set(e,t,r){return void 0===r&&(r=this.z),this.x=e,this.y=t,this.z=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Qt.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Qt.setFromAxisAngle(e,t))}applyMatrix3(e){var t=this.x,r=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[3]*r+n[6]*s,this.y=n[1]*t+n[4]*r+n[7]*s,this.z=n[2]*t+n[5]*r+n[8]*s,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){var t=this.x,r=this.y,s=this.z,n=e.elements,o=1/(n[3]*t+n[7]*r+n[11]*s+n[15]);return this.x=(n[0]*t+n[4]*r+n[8]*s+n[12])*o,this.y=(n[1]*t+n[5]*r+n[9]*s+n[13])*o,this.z=(n[2]*t+n[6]*r+n[10]*s+n[14])*o,this}applyQuaternion(e){var t=this.x,r=this.y,s=this.z,n=e.x,o=e.y,i=e.z,a=e.w,l=a*t+o*s-i*r,h=a*r+i*t-n*s,c=a*s+n*r-o*t,u=-n*t-o*r-i*s;return this.x=l*a+u*-n+h*-i-c*-o,this.y=h*a+u*-o+c*-n-l*-i,this.z=c*a+u*-i+l*-o-h*-n,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){var t=this.x,r=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[4]*r+n[8]*s,this.y=n[1]*t+n[5]*r+n[9]*s,this.z=n[2]*t+n[6]*r+n[10]*s,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this}cross(e,t){return void 0!==t?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)}crossVectors(e,t){var r=e.x,s=e.y,n=e.z,o=t.x,i=t.y,a=t.z;return this.x=s*a-n*i,this.y=n*o-r*a,this.z=r*i-s*o,this}projectOnVector(e){var t=e.lengthSq();if(0===t)return this.set(0,0,0);var r=e.dot(this)/t;return this.copy(e).multiplyScalar(r)}projectOnPlane(e){return qt.copy(this).projectOnVector(e),this.sub(qt)}reflect(e){return this.sub(qt.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){var t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;var r=this.dot(e)/t;return Math.acos(Ht.clamp(r,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){var t=this.x-e.x,r=this.y-e.y,s=this.z-e.z;return t*t+r*r+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,r){var s=Math.sin(t)*e;return this.x=s*Math.sin(r),this.y=Math.cos(t)*e,this.z=s*Math.cos(r),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,r){return this.x=e*Math.sin(t),this.y=r,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){var t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){var t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),s=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=s,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t,r){return void 0!==r&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}var qt=new Wt,Qt=new Vt;class Yt{constructor(){Object.defineProperty(this,"isMatrix4",{value:!0}),this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(e,t,r,s,n,o,i,a,l,h,c,u,p,d,g,v){var m=this.elements;return m[0]=e,m[4]=t,m[8]=r,m[12]=s,m[1]=n,m[5]=o,m[9]=i,m[13]=a,m[2]=l,m[6]=h,m[10]=c,m[14]=u,m[3]=p,m[7]=d,m[11]=g,m[15]=v,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Yt).fromArray(this.elements)}copy(e){var t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],this}copyPosition(e){var t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this}extractBasis(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this}extractRotation(e){var t=this.elements,r=e.elements,s=1/Zt.setFromMatrixColumn(e,0).length(),n=1/Zt.setFromMatrixColumn(e,1).length(),o=1/Zt.setFromMatrixColumn(e,2).length();return t[0]=r[0]*s,t[1]=r[1]*s,t[2]=r[2]*s,t[3]=0,t[4]=r[4]*n,t[5]=r[5]*n,t[6]=r[6]*n,t[7]=0,t[8]=r[8]*o,t[9]=r[9]*o,t[10]=r[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,r=e.x,s=e.y,n=e.z,o=Math.cos(r),i=Math.sin(r),a=Math.cos(s),l=Math.sin(s),h=Math.cos(n),c=Math.sin(n);if("XYZ"===e.order){var u=o*h,p=o*c,d=i*h,g=i*c;t[0]=a*h,t[4]=-a*c,t[8]=l,t[1]=p+d*l,t[5]=u-g*l,t[9]=-i*a,t[2]=g-u*l,t[6]=d+p*l,t[10]=o*a}else if("YXZ"===e.order){var v=a*h,m=a*c,f=l*h,y=l*c;t[0]=v+y*i,t[4]=f*i-m,t[8]=o*l,t[1]=o*c,t[5]=o*h,t[9]=-i,t[2]=m*i-f,t[6]=y+v*i,t[10]=o*a}else if("ZXY"===e.order){var x=a*h,b=a*c,_=l*h,C=l*c;t[0]=x-C*i,t[4]=-o*c,t[8]=_+b*i,t[1]=b+_*i,t[5]=o*h,t[9]=C-x*i,t[2]=-o*l,t[6]=i,t[10]=o*a}else if("ZYX"===e.order){var M=o*h,T=o*c,J=i*h,w=i*c;t[0]=a*h,t[4]=J*l-T,t[8]=M*l+w,t[1]=a*c,t[5]=w*l+M,t[9]=T*l-J,t[2]=-l,t[6]=i*a,t[10]=o*a}else if("YZX"===e.order){var S=o*a,R=o*l,E=i*a,I=i*l;t[0]=a*h,t[4]=I-S*c,t[8]=E*c+R,t[1]=c,t[5]=o*h,t[9]=-i*h,t[2]=-l*h,t[6]=R*c+E,t[10]=S-I*c}else if("XZY"===e.order){var P=o*a,D=o*l,N=i*a,O=i*l;t[0]=a*h,t[4]=-c,t[8]=l*h,t[1]=P*c+O,t[5]=o*h,t[9]=D*c-N,t[2]=N*c-D,t[6]=i*h,t[10]=O*c+P}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Kt,e,$t)}lookAt(e,t,r){var s=this.elements;return rr.subVectors(e,t),0===rr.lengthSq()&&(rr.z=1),rr.normalize(),er.crossVectors(r,rr),0===er.lengthSq()&&(1===Math.abs(r.z)?rr.x+=1e-4:rr.z+=1e-4,rr.normalize(),er.crossVectors(r,rr)),er.normalize(),tr.crossVectors(rr,er),s[0]=er.x,s[4]=tr.x,s[8]=rr.x,s[1]=er.y,s[5]=tr.y,s[9]=rr.y,s[2]=er.z,s[6]=tr.z,s[10]=rr.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){var r=e.elements,s=t.elements,n=this.elements,o=r[0],i=r[4],a=r[8],l=r[12],h=r[1],c=r[5],u=r[9],p=r[13],d=r[2],g=r[6],v=r[10],m=r[14],f=r[3],y=r[7],x=r[11],b=r[15],_=s[0],C=s[4],M=s[8],T=s[12],J=s[1],w=s[5],S=s[9],R=s[13],E=s[2],I=s[6],P=s[10],D=s[14],N=s[3],O=s[7],L=s[11],F=s[15];return n[0]=o*_+i*J+a*E+l*N,n[4]=o*C+i*w+a*I+l*O,n[8]=o*M+i*S+a*P+l*L,n[12]=o*T+i*R+a*D+l*F,n[1]=h*_+c*J+u*E+p*N,n[5]=h*C+c*w+u*I+p*O,n[9]=h*M+c*S+u*P+p*L,n[13]=h*T+c*R+u*D+p*F,n[2]=d*_+g*J+v*E+m*N,n[6]=d*C+g*w+v*I+m*O,n[10]=d*M+g*S+v*P+m*L,n[14]=d*T+g*R+v*D+m*F,n[3]=f*_+y*J+x*E+b*N,n[7]=f*C+y*w+x*I+b*O,n[11]=f*M+y*S+x*P+b*L,n[15]=f*T+y*R+x*D+b*F,this}multiplyScalar(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){var e=this.elements,t=e[0],r=e[4],s=e[8],n=e[12],o=e[1],i=e[5],a=e[9],l=e[13],h=e[2],c=e[6],u=e[10],p=e[14];return e[3]*(+n*a*c-s*l*c-n*i*u+r*l*u+s*i*p-r*a*p)+e[7]*(+t*a*p-t*l*u+n*o*u-s*o*p+s*l*h-n*a*h)+e[11]*(+t*l*c-t*i*p-n*o*c+r*o*p+n*i*h-r*l*h)+e[15]*(-s*i*h-t*a*c+t*i*u+s*o*c-r*o*u+r*a*h)}transpose(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(e,t,r){var s=this.elements;return e.isVector3?(s[12]=e.x,s[13]=e.y,s[14]=e.z):(s[12]=e,s[13]=t,s[14]=r),this}getInverse(e,t){void 0!==t&&console.warn("THREE.Matrix4: .getInverse() can no longer be configured to throw on degenerate.");var r=this.elements,s=e.elements,n=s[0],o=s[1],i=s[2],a=s[3],l=s[4],h=s[5],c=s[6],u=s[7],p=s[8],d=s[9],g=s[10],v=s[11],m=s[12],f=s[13],y=s[14],x=s[15],b=d*y*u-f*g*u+f*c*v-h*y*v-d*c*x+h*g*x,_=m*g*u-p*y*u-m*c*v+l*y*v+p*c*x-l*g*x,C=p*f*u-m*d*u+m*h*v-l*f*v-p*h*x+l*d*x,M=m*d*c-p*f*c-m*h*g+l*f*g+p*h*y-l*d*y,T=n*b+o*_+i*C+a*M;if(0===T)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var J=1/T;return r[0]=b*J,r[1]=(f*g*a-d*y*a-f*i*v+o*y*v+d*i*x-o*g*x)*J,r[2]=(h*y*a-f*c*a+f*i*u-o*y*u-h*i*x+o*c*x)*J,r[3]=(d*c*a-h*g*a-d*i*u+o*g*u+h*i*v-o*c*v)*J,r[4]=_*J,r[5]=(p*y*a-m*g*a+m*i*v-n*y*v-p*i*x+n*g*x)*J,r[6]=(m*c*a-l*y*a-m*i*u+n*y*u+l*i*x-n*c*x)*J,r[7]=(l*g*a-p*c*a+p*i*u-n*g*u-l*i*v+n*c*v)*J,r[8]=C*J,r[9]=(m*d*a-p*f*a-m*o*v+n*f*v+p*o*x-n*d*x)*J,r[10]=(l*f*a-m*h*a+m*o*u-n*f*u-l*o*x+n*h*x)*J,r[11]=(p*h*a-l*d*a-p*o*u+n*d*u+l*o*v-n*h*v)*J,r[12]=M*J,r[13]=(p*f*i-m*d*i+m*o*g-n*f*g-p*o*y+n*d*y)*J,r[14]=(m*h*i-l*f*i-m*o*c+n*f*c+l*o*y-n*h*y)*J,r[15]=(l*d*i-p*h*i+p*o*c-n*d*c-l*o*g+n*h*g)*J,this}scale(e){var t=this.elements,r=e.x,s=e.y,n=e.z;return t[0]*=r,t[4]*=s,t[8]*=n,t[1]*=r,t[5]*=s,t[9]*=n,t[2]*=r,t[6]*=s,t[10]*=n,t[3]*=r,t[7]*=s,t[11]*=n,this}getMaxScaleOnAxis(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],s=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,s))}makeTranslation(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this}makeRotationX(e){var t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this}makeRotationY(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this}makeRotationZ(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){var r=Math.cos(t),s=Math.sin(t),n=1-r,o=e.x,i=e.y,a=e.z,l=n*o,h=n*i;return this.set(l*o+r,l*i-s*a,l*a+s*i,0,l*i+s*a,h*i+r,h*a-s*o,0,l*a-s*i,h*a+s*o,n*a*a+r,0,0,0,0,1),this}makeScale(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this}makeShear(e,t,r){return this.set(1,t,r,0,e,1,r,0,e,t,1,0,0,0,0,1),this}compose(e,t,r){var s=this.elements,n=t._x,o=t._y,i=t._z,a=t._w,l=n+n,h=o+o,c=i+i,u=n*l,p=n*h,d=n*c,g=o*h,v=o*c,m=i*c,f=a*l,y=a*h,x=a*c,b=r.x,_=r.y,C=r.z;return s[0]=(1-(g+m))*b,s[1]=(p+x)*b,s[2]=(d-y)*b,s[3]=0,s[4]=(p-x)*_,s[5]=(1-(u+m))*_,s[6]=(v+f)*_,s[7]=0,s[8]=(d+y)*C,s[9]=(v-f)*C,s[10]=(1-(u+g))*C,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}decompose(e,t,r){var s=this.elements,n=Zt.set(s[0],s[1],s[2]).length(),o=Zt.set(s[4],s[5],s[6]).length(),i=Zt.set(s[8],s[9],s[10]).length();this.determinant()<0&&(n=-n),e.x=s[12],e.y=s[13],e.z=s[14],Xt.copy(this);var a=1/n,l=1/o,h=1/i;return Xt.elements[0]*=a,Xt.elements[1]*=a,Xt.elements[2]*=a,Xt.elements[4]*=l,Xt.elements[5]*=l,Xt.elements[6]*=l,Xt.elements[8]*=h,Xt.elements[9]*=h,Xt.elements[10]*=h,t.setFromRotationMatrix(Xt),r.x=n,r.y=o,r.z=i,this}makePerspective(e,t,r,s,n,o){void 0===o&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var i=this.elements,a=2*n/(t-e),l=2*n/(r-s),h=(t+e)/(t-e),c=(r+s)/(r-s),u=-(o+n)/(o-n),p=-2*o*n/(o-n);return i[0]=a,i[4]=0,i[8]=h,i[12]=0,i[1]=0,i[5]=l,i[9]=c,i[13]=0,i[2]=0,i[6]=0,i[10]=u,i[14]=p,i[3]=0,i[7]=0,i[11]=-1,i[15]=0,this}makeOrthographic(e,t,r,s,n,o){var i=this.elements,a=1/(t-e),l=1/(r-s),h=1/(o-n),c=(t+e)*a,u=(r+s)*l,p=(o+n)*h;return i[0]=2*a,i[4]=0,i[8]=0,i[12]=-c,i[1]=0,i[5]=2*l,i[9]=0,i[13]=-u,i[2]=0,i[6]=0,i[10]=-2*h,i[14]=-p,i[3]=0,i[7]=0,i[11]=0,i[15]=1,this}equals(e){for(var t=this.elements,r=e.elements,s=0;s<16;s++)if(t[s]!==r[s])return!1;return!0}fromArray(e,t){void 0===t&&(t=0);for(var r=0;r<16;r++)this.elements[r]=e[r+t];return this}toArray(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}}for(var Zt=new Wt,Xt=new Yt,Kt=new Wt(0,0,0),$t=new Wt(1,1,1),er=new Wt,tr=new Wt,rr=new Wt,sr=[],nr=0;nr<256;nr++)sr[nr]=(nr<16?"0":"")+nr.toString(16).toUpperCase();class or{static pointInsidePolygon(e,t){var r,s,n,o,i=0;for(e.push(e[0]),r=0;r<e.length-1;r++)n=e[r],o=e[r+1],t[0]>Math.min(n[0],o[0])&&t[0]<=Math.max(n[0],o[0])&&t[1]<=Math.max(n[1],o[1])&&n[0]!=o[0]&&(s=(t[0]-n[0])*(o[1]-n[1])/(o[0]-n[0])+n[1],(n[1]==o[1]||t[1]<=s)&&i++);return!!i%2}static processPosition(e){return e&&e.length>2?[Bt.saveDecimal(e[0],3),Bt.saveDecimal(e[1],3),Bt.saveDecimal(e[2],3)]:[0,0,0]}static processAngles(e){if(e&&e.length>2&&(0!=e[0]||0!=e[1]||0!=e[2])){var t=THING.Utils.parseQuaternion(e).toArray();return[Bt.saveDecimal(t[0],8),Bt.saveDecimal(t[1],8),Bt.saveDecimal(t[2],8),Bt.saveDecimal(t[3],8)]}return null}static processQuaternion(e){var t=new Vt(e[0],e[1],e[2],e[3]);if(or.getDecimalLength(e[0])<=7||or.getDecimalLength(e[1])<=7||or.getDecimalLength(e[2])<=7||or.getDecimalLength(e[3])<=7){var r=new Yt;r.compose(new Wt(0,0,0),t,new Wt(1,1,1)),r.decompose(new Wt,t,new Wt)}return THING.MathUtils.getAnglesFromQuat([t.x,t.y,t.z,t.w])}static processScale(e){return e&&e.length>2&&(1!=e[0]||1!=e[1]||1!=e[2])?[Bt.saveDecimal(e[0],3),Bt.saveDecimal(e[1],3),Bt.saveDecimal(e[2],3)]:null}static addResourceToArray(e,t){for(var r=0;r<e.length;r++){if(e[r].url==t.url)return r}return e.push(t)-1}static addTextureToArray(e,t){for(var r=0;r<e.length;r++){var s=e[r];if(s.url==t.url&&s.flipY===t.flipY)return r}return e.push(t)-1}static addStringToArray(e,t){for(var r=0;r<e.length;r++){if(e[r]==t)return r}return e.push(t)-1}static getIdOnesPlaceNumber(e){var t=-1,r=Number(e);if(isNaN(r)){if(t=0,or.isUUID(e)){var s=e.slice(e.length-2);if(s){var n=parseInt(s,16);isNaN(n)||(t=n)}}}else"number"==typeof e&&(e+=""),t=(r=parseInt(e.substring(e.length-1)))%10;return 1^t}static decodeArray(e,t,r,s){if(void 0===s&&(s=3),t)for(var n=0;n<s;n++){var o=t[n];or.isTwoDoublesEqual(e,o)||(t[n]=or.decodeNumber(o,r))}return t}static encodeArray(e,t,r,s){if(void 0===s&&(s=3),t)for(var n=0;n<s;n++){var o=t[n];or.isTwoDoublesEqual(e,o)||(t[n]=or.encodeNumber(o,r))}return t}static decodeNumber(e,t){return e>0?e-t:e+t}static encodeNumber(e,t){return e>0?e+t:e-t}static isUUID(e){var t=""+e;return null!==(t=t.match("^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"))}static isTwoDoublesEqual(e,t){return e===t}static getDecimalLength(e){if(e){var t=e.toString().split(".")[1];if(t)return t.length}return 0}static isDefaultVector3(e,t){return void 0===t&&(t=0),e&&e.length>2&&e[0]===t&&e[1]===t&&e[2]===t}static isDefaultQuat(e){return e&&e.length>3&&0===e[0]&&0===e[1]&&0===e[2]&&1===e[3]}static generateUUID(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return sr[255&e]+sr[e>>8&255]+sr[e>>16&255]+sr[e>>24&255]+"-"+sr[255&t]+sr[t>>8&255]+"-"+sr[t>>16&15|64]+sr[t>>24&255]+"-"+sr[63&r|128]+sr[r>>8&255]+"-"+sr[r>>16&255]+sr[r>>24&255]+sr[255&s]+sr[s>>8&255]+sr[s>>16&255]+sr[s>>24&255]}}var ir=or;class ar{constructor(e){void 0===e&&(e={}),this.app=e.app,this.baseUrl=e.url}parse(e,t){e?(this.parseCamera(e.camera),!1!==t.useDefaultRenderSettings&&(this.parseEffectConfig(e.effectConfig),this.parseSkybox(e.skybox))):this.setMainLightRefresh(t)}parseLight(e,t){if(e&&e.light&&!1!==t.useDefaultRenderSettings){var r=e.light,s=r.ambientLight;s&&Object.assign(this.app.scene.ambientLight,s);var n=r.mainLight;if(n){var o=this.app.scene.mainLight;void 0!==n.shadow&&(o.castShadow=n.shadow),void 0!==n.intensity&&(o.intensity=n.intensity),void 0!==n.color&&(o.color=n.color);var i=o.adapter;void 0!==n.beta&&(i.horzAngle=n.beta),void 0!==n.alpha&&(i.vertAngle=n.alpha)}var a=r.secondaryLight;if(a&&a.intensity>0){var l=app.queryByName("secondaryLight").objects[0];l||(l=new THING.DirectionalLight({parent:this.app.root,name:"secondaryLight"})),void 0!==a.shadow&&(l.castShadow=a.shadow),void 0!==a.intensity&&(l.intensity=a.intensity),a.color&&(l.color=a.color);var h=l.adapter;void 0!==a.beta&&(h.horzAngle=a.beta),void 0!==a.alpha&&(h.vertAngle=a.alpha)}var c=r.hemisphereLight;if(c&&c.intensity>0){var u=app.query(".HemisphereLight").objects[0];u||(u=new THING.HemisphereLight({parent:this.app.root,name:"hemisphereLight"})),u.intensity=c.intensity,u.color=c.color,u.groundColor=c.groundColor}}else this.setMainLightRefresh(t)}setMainLightRefresh(e){Bt.parseBoolean(e.refreshShadow,!0)&&(this.app.scene.mainLight.adapter.needRefresh=!0)}parseEffectConfig(e){if(e){var t=this.app.camera.postEffect;for(var r in e)if("vignette"===r){var s=e[r];if(s&&s.enable){s.enable=!1;var n=s.type;"blur"===n?(t.blurEdge.enable=!0,t.blurEdge.offset=s.offset):"color"===n&&(t.vignetting.enable=!0,t.vignetting.offset=s.offset,t.vignetting.color=s.color)}}else t[r]||(t[r]={}),Object.assign(t[r],e[r])}}parseCamera(e){if(e){var t=this.app.camera;if(e.fov&&(t.fov=e.fov),e.far&&(t.far=e.far),e.xAngleLimitRange){var r=[90-e.xAngleLimitRange[0],90-e.xAngleLimitRange[1]];t.vertAngleLimit=r}e.distanceLimited&&(t.distanceLimited=e.distanceLimited)}}parseSkybox(e){e&&!this.app.options.background&&(this.app.background=new THING.CubeTexture({url:ar.parseCubeTextureUrls(this.baseUrl,e)}))}static parseCubeTextureUrls(e,t){return{negx:e._appendPath(t.lf),negy:e._appendPath(t.dn),negz:e._appendPath(t.bk),posx:e._appendPath(t.rt),posy:e._appendPath(t.up),posz:e._appendPath(t.fr)}}static parseEnvTextureUrls(e,t){return{negx:e._appendPath(t.rt),negy:e._appendPath(t.dn),negz:e._appendPath(t.fr),posx:e._appendPath(t.lf),posy:e._appendPath(t.up),posz:e._appendPath(t.bk)}}}function lr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function hr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?lr(Object(r),!0).forEach((function(t){zt(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):lr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class cr{constructor(e){this.app=e.app,this.combineRoom=e.combineRoom,this.baseLocalUrl=e.baseLocalUrl._appendURL("/"),this.importModels=e.models||[],this.importTextures=e.textures||[],this.exportModels=[],this.exportTextures=[],this.exportUuids=[],this.modelUseCount=[],this.exportInstanceCount=[],this.instancePlanes=new Map,this.matrixData={},this.renderOrderData={},this.matrixNode=null,this.cubeTextures=[];var t=e.thingjsconfig;t&&(t.environment&&(this.outerEnvMap=ar.parseEnvTextureUrls(e.baseLocalUrl,t.environment),this.cubeTextures.push(this.outerEnvMap),this.outerEnvMapIndex=0),5===e.version.mode&&t.environmentInside&&(this.innerEnvMap=ar.parseEnvTextureUrls(e.baseLocalUrl,t.environmentInside),this.cubeTextures.push(this.innerEnvMap),this.innerEnvMapIndex=this.cubeTextures.length-1)),this.materialResourceResolver=new Fe,this.setWallLightMap(e.wallMaterial)}setWallLightMap(e){e?e.straightmanualwall&&e.straightmanualwall.lightingtexture&&(this.wallLightMap=e.straightmanualwall.lightingtexture,this.useDefaultWallLightMap=!1):(this.wallLightMap={id:"18091219l1g1hnjt",ext:"png"},this.useDefaultWallLightMap=!0),this.wallLightMapIndex=this.addTexture(Bt.parseTexture(this.wallLightMap,!1))}getMatrixData(e,t){return new Promise(((r,s)=>{var n=null;switch(t){case 0:case 1:case 2:break;case 3:case 4:case 5:n="InverseRotationToMesh";break;default:n="InverseRotationToVertices"}this.app.resourceManager.loadModel(this.baseLocalUrl+e.localurl,(e=>{this.matrixData=hr({},this.matrixData,e.node.getSubNodesMatrixInfo()),this.renderOrderData=hr({},this.renderOrderData,e.node.getSubNodesRenderOrderInfo()),this.matrixNode=e.node,r()}),void 0,void 0,{lights:!0,inverseRotationMode:n})}))}getTransform(e){var t=this.matrixData[e];if(t){var r=[],s=[],n=[];return THING.MathUtils.decomposeFromMat4(t,r,s,n),{position:r,quaternion:s,scale:n}}}getRenderOrder(e){return this.renderOrderData[e]}addInstancePlanes(e){this.instancePlanes.has(e)?this.instancePlanes.get(e).value++:this.instancePlanes.set(e,{value:1,instanceCountIndex:null})}getInstancePlanes(e){return this.exportInstanceCount.push(Array(e))-1}getModelByIndex(e){var t=this.importModels[e];return t.id?t:null}getModelById(e){for(var t=0;t<this.importModels.length;t++)if(e===this.importModels[t].id)return this.importModels[t];return null}getTextureByIndex(e){var t=this.importTextures[e];return t||null}getTextureById(e){for(var t=0;t<this.importTextures.length;t++)if(e===this.importTextures[t].id)return this.importTextures[t];return null}addModel(e){return ir.addResourceToArray(this.exportModels,e)}addModelUseCount(e){this.modelUseCount[e]?this.modelUseCount[e]++:this.modelUseCount[e]=1}getInstance(e){for(var t=0;t<this.exportInstanceCount.length;t++){if(e===this.exportInstanceCount[t][0])return this.exportInstanceCount[t].push(e),t}return this.exportInstanceCount[this.exportInstanceCount.length]=[e],this.exportInstanceCount.length-1}addTexture(e){return ir.addTextureToArray(this.exportTextures,e)}addUUID(e){return this.exportUuids.push(e)-1}}class ur{constructor(e){this.param=e,this.version=e.version,this.app=e.app,this.combineRoom=e.combineRoom,this._versionMap={},this._smallVersionLibs=[],this._bigVersions=[]}import(e){return this.resourceManager=new cr({app:this.app,version:this.version,combineRoom:this.combineRoom,baseLocalUrl:e.url,models:e.scene.models,textures:e.scene.textures,wallMaterial:e.scene.materialsetting,thingjsconfig:e.scene.thingjsconfig}),new Promise(((t,r)=>{if(e.scene&&e.scene.models){for(var s=[],n=0;n<e.scene.models.length;n++){var o=e.scene.models[n];if(!0!==o.keeprootrotation)if(5===this.version.mode)s.push(this.resourceManager.getMatrixData(o,this.version.smallVersion));else if(7===this.version.mode&&o.loadversion){var i=new jt(o.loadversion);5===i.mode&&o.localurl&&s.push(this.resourceManager.getMatrixData(o,i.smallVersion))}}window.promises=s,Promise.all(s).then((()=>{t()}))}else t()}))}_getCreatorConfig(e,t){if(null==e){var r=this._smallVersionLibs[this._bigVersions.length-1];return t=r[r.length-1],this._versionMap[this._bigVersions.length-1][t]}if(null==t){var s=this._smallVersionLibs[e];return t=s[s.length-1],this._versionMap[e][t]}var n=this._smallVersionLibs[e];if(!(e>this._bigVersions[this._bigVersions.length-1])){var o=n[n.length-1];return t>o||!this._versionMap[e][t]?this._versionMap[e][o]:this._versionMap[e][t]}console.error("ubuilderLoader not support version "+e+"."+t)}_currentDate(e){var t=new Date,r=" ",s="/",n=":",o=t.getMonth()+1,i=t.getDate();return e&&(r=s=n=e),o>=1&&o<=9&&(o="0"+o),i>=0&&i<=9&&(i="0"+i),t.getFullYear()+s+o+s+i+r+t.getHours()+n+t.getMinutes()+n+t.getSeconds()}}class pr{static getStyleTag(e){var t=e.originalType,r=null;switch(t){case"Facade":r=Ct;break;case"Placement":r=pr.placementStyleTag(e);break;case"Window":case"Door":r=pr.doorOrWindowStyleTag(e);break;case"VideoProbe":r=Tt;break;case"Room":r=pr.roomStyleTag(e);break;case"RoomSlab":r=St;break;case"RoomRoof":r=Rt;break;case"RoomCeiling":r=Et;break;case"CombineWall":case"PlacementWall":r="Outdoors"===e.parent.originalType?Mt:It;break;default:-1!==t.indexOf("Combine")&&(r=pr.combinedStyleTag(e,t))}return r}static placementStyleTag(e){var t=e.baseModel.url;return pr.isTree(t)?Jt:pr.isWall(t)?"Outdoors"===("Misc"===e.parent.thing2Type?e.parent.parent:e.parent).originalType?Mt:It:"Misc"===e.parent.thing2Type?wt:Tt}static doorOrWindowStyleTag(e){return e.originalJson.iswindow?"Outdoors"===e.parent.originalType?wt:Tt:"Outdoors"===e.parent.originalType?wt:Pt}static roomStyleTag(e){if(!e.isFloorRoom)return Mt}static combinedStyleTag(e,t){var r=wt;switch(t){case"CombineFloor":r=St;break;case"CombineCeiling":r=Et;break;case"CombineRoof":r=Rt;break;case"CombinePlacement":if(e.baseModel){var s=e.baseModel.id;if(pr.isTree(s))r=Jt;else if(pr.isWall(s)){r="Outdoors"===("Misc"===e.parent.thing2Type?e.parent.parent:e.parent).originalType?Mt:It}r=wt}}return r}static isWall(e){return!!e&&!!Dt[e]}static isTree(e){return!!e&&!!Nt[e]}}class dr{constructor(e,t,r){void 0===e&&(e={}),this.options=e,this.resourceManager=e.resourceManager,this.creatorMap=e.creatorMap,this.parent=r,this.originalJson=t,this.children=[],this.baseModel={},this.convertJson={external:{material:{}},userData:{},body:{},style:{uv:{}},children:[]},!1===t.visible&&(this.convertJson.visible=!1)}_parseChildren(){}_generateChildrenCreators(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{r=r||this,!1===this.originalJson.visible&&(e.visible=!1);var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}convert(e){return this._convertSelf(e),this._convertChildren(e),this._cutEmptyJson(),this.convertJson}_convertStyleTag(){var e=this.originalJson.properties;e||(e=this.originalJson.properties={}),e._styleTag_||(e._styleTag_=pr.getStyleTag(this)),e._styleTag_||delete e._styleTag_,this.originalJson.properties&&(this.convertJson.userData=this.originalJson.properties)}_convertSelf(e){this._convertStyleTag(),e&&!1===e.queryable&&(this.convertJson.queryable=!1),this.convertJson.type=this.thing2Type,this.originalJson.id&&(this.convertJson.uuid=this.resourceManager.addUUID(this.originalJson.id)),this.originalJson.name&&(this.convertJson.name=this.originalJson.name),this.originalJson.userid&&(this.convertJson.id=this.originalJson.userid),this._convertTags(),this._convertTransform(),this._convertCamInfo()}_convertTags(){}_convertTransform(){}_convertCamInfo(){var e,t,r=!1;if(this.originalJson.caminfo&&(e=this.originalJson.caminfo.eye,t=this.originalJson.caminfo.target),this.originalJson.camInfo&&(e=o(this.originalJson.camInfo.eye),t=o(this.originalJson.camInfo.target),r=!0),e&&t){var s=this._getWorldPosition(),n={position:[e[0]-s[0],e[1]-s[1],-e[2]-s[2]],target:[t[0]-s[0],t[1]-s[1],-t[2]-s[2]]};this.convertJson.components=[{name:"level",type:"LevelComponent",external:{viewpoint:n}}],r&&(this.resourceManager.viewpoint=n)}function o(e,t){t=e.split(" ");for(var r=0;r<t.length;r++)t[r]=parseFloat(t[r]);return t}}_getWorldPosition(){return[0,0,0]}_to2DPoints(e,t){return void 0===t&&(t=!1),e.map((e=>{var r,s,n=t?(r=e,s=this.realPosition,[r[0]-s[0],r[1]-s[1],r[2]-s[2]]):e;return[n[0],n[2]]}))}_to2DHoles(e,t){return void 0===t&&(t=!1),e.map((e=>this._to2DPoints(e,t)))}_convertChildren(e){var t=[];this.children.forEach((r=>{t.push(r.convert(e))})),t.length&&this.convertJson.children.push(...t)}_cutEmptyJson(){this.convertJson.external&&!Object.keys(this.convertJson.external.corners||{}).length&&delete this.convertJson.external.corners,this.convertJson.external&&!Object.keys(this.convertJson.external.material||{}).length&&delete this.convertJson.external.material,Object.keys(this.convertJson.external||{}).length||delete this.convertJson.external,Object.keys(this.convertJson.userData||{}).length||delete this.convertJson.userData,Object.keys(this.convertJson.body||{}).length||delete this.convertJson.body,this.convertJson.style&&!Object.keys(this.convertJson.style.uv||{}).length&&delete this.convertJson.style.uv,Object.keys(this.convertJson.style||{}).length||delete this.convertJson.style,Object.keys(this.convertJson.body||{}).length||delete this.convertJson.body,this.convertJson.children&&!this.convertJson.children.length&&delete this.convertJson.children}_isShouldCombine(e){return!!(t(e.originalJson.userid)&&t(e.originalJson.name)&&t(e.originalJson.isshow)&&(t(e.originalJson.properties)||!t(e.originalJson.properties._styleTag_)&&1===Object.keys(e.originalJson.properties).length));function t(e){return null==e}}addCorners(e){for(var t=0;t<this.originalJson.corners.length;t++){var r=this.originalJson.corners[t];if(Bt.floatEquals(r,e))return t}return this.originalJson.corners.push(e)-1}}class gr extends dr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.version=e.version,this._parseSelf(),e.noCreateChildren||this._parseChildren()}_parseSelf(){this._parseDecodeNumber(),Bt.getParseTransform(this,this.originalJson,this.decodeNumber,this.version)}_parseDecodeNumber(){this.decodeNumber=this.originalJson.id}_convertSelf(e){if(super._convertSelf(e),"number"==typeof this.originalJson.texture){var t=this._convertTextureByType(this.originalJson.texture,this);"number"==typeof t&&(this.convertJson.style.map=t)}if("number"==typeof this.convertJson.body.id){var r=this.resourceManager.getModelByIndex(this.originalJson.model);if(this.resourceManager.modelUseCount[r.id]>1&&this.enableInstance){this.convertJson.external.instance=this.resourceManager.getInstance(r.id),this.convertJson.external.instanceId=1e4+this.convertJson.external.instance,this.convertJson.external.instanceCount=this.resourceManager.modelUseCount[r.id];var s=Object.keys(this.convertJson.style||{}).length;s&&(1!==s||Object.keys(this.convertJson.style.uv||{}).length)&&(this.convertJson.external.instanceStyle=this.convertJson.style,delete this.convertJson.style)}}}_convertTexture(e,t){void 0===t&&(t=!1);var r={};return Object.assign(r,this.resourceManager.getTextureByIndex(e)),Object.keys(r).length?this.resourceManager.addTexture(Bt.parseTexture(r,t)):null}_convertTransform(){this.realPosition&&(this.convertJson.position=this.realPosition),this.realScale&&(this.convertJson.scale=this.realScale),this.parent&&this.parent.useInverseRotation&&(this.convertJson.quaternion=[-this.parent.useInverseRotation[0],-this.parent.useInverseRotation[1],-this.parent.useInverseRotation[2],this.parent.useInverseRotation[3]],this.convertJson.position=Bt.vec3ApplyQuat(this.convertJson.position,this.convertJson.quaternion)),this.realRotation&&(this.convertJson.quaternion?this.convertJson.quaternion=Bt.multiplyQuat(this.realRotation,this.convertJson.quaternion):this.convertJson.quaternion=this.realRotation)}_convertTextureByType(e,t){return"Placement"===t.originalType||"GeneralRouteLine"===t.originalType?this._convertTexture(e):this._convertTexture(e,!0)}get thing2Type(){}_convertPlane(e){var t="custom",r={materialResource:{}},s={};if(!this.isRoom){var n=this.resourceManager.instancePlanes.get(this.instanceString);(null==n?void 0:n.value)>1&&("number"!=typeof n.instanceCountIndex&&(n.instanceCountIndex=this.resourceManager.getInstancePlanes(n.value)),r.instanceGroupName=this.instanceString)}r.materialResource.sideType=this.sideType,r.materialResource.defineFloorAo=this.defineFloorAo;var o=null;"number"==typeof this.originalJson[e+t+"texture"]?(o=this.resourceManager.getTextureByIndex(this.originalJson[e+t+"texture"]))&&(r.materialResource.map=_t+(o.texture||o.id)+"."+o.ext,o.color&&(r.materialResource.color=o.color)):(o=this.resourceManager.getTextureByIndex(this.originalJson[e+"texture"]))&&(r.materialResource.map=_t+o.id+"."+o.ext);var i="roof"===e?[2,2]:[.6,.6],a=this.originalJson[e+"blocksize"]||i;s.repeat=[1/a[0],1/a[1]],this.originalJson[e+"blockangle"]&&(s.angle=-this.originalJson[e+"blockangle"]),!1===this.originalJson["isshow"+e]&&(r.alwaysHide=!0,this.convertJson.layerMask=0),this.isRoom&&!this.isFloorRoom&&(r.materialResource.sideType="Double",r.materialResource.defineFloorAo=!0),r.uv=s,r.materialResource=this.resourceManager.materialResourceResolver.setMaterialResourceData(r.materialResource),this.convertJson.components=[{name:"PlaneComponent",type:"PlaneComponent",external:r}]}}let vr=class extends gr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.misc=this.misc||null,this.rooms=this.rooms||[],this.combinePlanes=new Map,this.parent&&this.parent.hideStruct&&(this.convertJson.visible=!1)}get thing2Type(){return"Floor"}get originalType(){return"Floorplan"}get isFloor(){return!0}_convertSelf(e){super._convertSelf(e),this.isFloor&&(this.convertJson.external.constantShowThings=!!this.originalJson.alwaysshowinsideobjs),this.corners.length&&(this.convertJson.external.corners=this.corners),this.originalJson.height&&(this.convertJson.height=this.originalJson.height)}_getWorldPosition(){if(this.isFloor){return e=this.convertJson.position,t=this.parent.convertJson.position,[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}var e,t;return[0,0,0]}_parseSelf(){super._parseSelf(),Bt.getParseCorners(this,this.originalJson,this.decodeNumber,this.version),this.originalJson.corners||(this.corners=[])}_parseChildren(){var e=this.originalJson.walls;if(e){var t=[],r=[],s=[];if(e.forEach((e=>{0===e.type?r.push(e):1===e.type?t.push(e):2===e.type&&s.push(e)})),t.length){var n=new this.creatorMap.wall(this.options,{},this,"ModelWall");this.children.push(n),this._generateChildrenCreators(t,"modelWall",n)}if(r.length){var o=new this.creatorMap.wall(this.options,{},this,"TextureWall");this.children.push(o),this._generateChildrenCreators(r,"textureWall",o)}this._generateChildrenCreators(s,"placementWall")}this._generateChildrenCreators(this.originalJson.curvelines,"curveLine"),this._generateChildrenCreators(this.originalJson.routelines,"routeLine"),this._generateChildrenCreators(this.originalJson.leakwaterlines,"leakWaterLine"),this._generateChildrenCreators(this.originalJson.arrowlines,"arrowLine"),this._generateChildrenCreators(this.originalJson.arrowdatalines,"arrowDataLine"),this._generateChildrenCreators(this.originalJson.pipelines,"pipeLine"),this._generateChildrenCreators(this.originalJson.grounds,"ground"),this._generateChildrenCreators(this.originalJson.generalpolygonlines,"generalPolygonLine"),this._generateChildrenCreators(this.originalJson.generalroutelines,"generalRouteLine"),this.rooms=this._generateChildrenCreators(this.originalJson.rooms,"room"),this.__generateChildrenCreators(this.originalJson.placements,"placement"),this.__generateChildrenCreators(this.originalJson.videoprobes,"placement"),this.__generateChildrenCreators(this.originalJson.groups,"group")}_generateChildrenCreators(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible?e.visible=!1:this.isFloor&&!this.originalJson.alwaysshowinsideobjs&&("room"===t||t.includes("Wall")||(e.visible=!1)),r&&r.isWall&&!1===e.visible&&(r.convertJson.visible=!1),r=r||this;var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}__generateChildrenCreators(e,t,r){void 0===r&&(r=this),e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{if((!1===this.originalJson.visible||this.isFloor&&!this.originalJson.alwaysshowinsideobjs)&&(e.visible=!1),e.properties&&"Ground"===e.properties._tjsType_){var s=new this.creatorMap[t](this.options,e,this);this.children.push(s)}else{var n=r,o=!1===e.isshow?"emptyObject":t,i=new this.creatorMap[o](this.options,e,this);if(this._isShouldCombine(i))this.misc||(this.misc=new this.creatorMap.misc(this.options,{visible:e.visible},r),r.children.push(this.misc)),n=this.misc;else if(this.isFloor&&i.originalJson._temp_belongroom)for(var a=0;a<this.rooms.length;a++){var l=this.rooms[a];if(l.originalJson.userid&&l.originalJson.userid===i.originalJson._temp_belongroom){i.realPosition&&(i.realPosition=[i.realPosition[0]-l.realPosition[0],i.realPosition[1]-l.realPosition[1],i.realPosition[2]-l.realPosition[2]]),n=l;break}}i.parent=n,n.children.push(i),n=r}})))}_convertChildren(e){var t=[],r=[];this.children.forEach((s=>{var n=s.convert(e);s.isRoom&&s.combineRoom?r.push(n):t.push(n)})),t.length&&this.convertJson.children.push(...t),this._convertCombinePlanes(r)}_convertCombinePlanes(e){var t=[];e.forEach((e=>{e.children.forEach((r=>{if(0!==r.layerMask){var s=this._getCombinePlaneKey(r);r.components[0].external.points=Bt.cloneObject(e.external.points,!1),e.external.holes&&(r.components[0].external.holes=Bt.cloneObject(e.external.holes,!1)),this._makeCombinePlane(t,s,r)}}))})),this._setCombinePlaneData(t)}_getCombinePlaneKey(e){var t=e.components[0].external.materialResource,r=this.resourceManager.materialResourceResolver.getData().styles[t],s="";return s+="_"+this.convertJson.uuid,s+="_"+r.sideType,s+="_"+r.map,r.color&&(s+="_"+r.color),s}_makeCombinePlane(e,t,r){var s=this.combinePlanes;s.has(t)||(s.set(t,[]),e.push(t)),s.get(t).push(r)}_setCombinePlaneData(e){e.forEach((e=>{var t,r,s,n=this.combinePlanes.get(e),o={type:"Object3D",tags:[6],queryable:!1,position:[0,n[0].position[1],0],components:[{name:"CombinePlaneComponent",type:"CombinePlaneComponent",external:{planes:n,materialResource:n[0].components[0].external.materialResource}}]};null!=(t=n[0].tags)&&t.includes(3)?o.tags.push(12):null!=(r=n[0].tags)&&r.includes(4)?o.tags.push(13):null!=(s=n[0].tags)&&s.includes(5)&&o.tags.push(14),this.convertJson.children.push(o)}))}};class mr extends gr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.doororwindows=this.doororwindows||[]}_convertTags(){this.parent.isFloor&&(this.convertJson.tags=[6])}_parseChildren(){this.doororwindows=this.__generateChildrenCreators(this.originalJson.doororwindows,"doororwindow",this.parent.parent)}__generateChildrenCreators(e,t,r){var s=[];if(e){this.convertJson.holes=[];var n=this.parent.parent.corners[this.originalJson.corners[0]],o=this.parent.parent.corners[this.originalJson.corners[1]];Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible&&(e.visible=!1),r=r||this;var l=new this.creatorMap[t](this.options,e,r);r.children.push(l),s.push(l);var h,c,u,p=l.realPosition,d=a(n,p),g=a(n,o);this.convertJson.holes.push({loc:[d/g,l.originalJson.suspendpercent||0],size:i(l.baseModel.size,l.realScale)}),l.originalJson.suspendpercent&&this.convertJson.height&&(l.realPosition=[l.realPosition[0],l.realPosition[1]+this.convertJson.height*l.originalJson.suspendpercent,l.realPosition[2]]),l.realRotation=(h=[o[0]-n[0],o[1]-n[1],o[2]-n[2]],c=new Wt(...h).normalize(),(u=new Vt).setFromUnitVectors(new Wt(1,0,0),c),u.toArray())}))}function i(e,t,r){return t=t||[1,1,1],(r=r||[])[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r}function a(e,t){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])+(e[2]-t[2])*(e[2]-t[2]))}return s}_convertSelf(e){super._convertSelf(e),this.parent&&!1===this.parent.convertJson.visible&&delete this.convertJson.visible,!1===this.originalJson.isshow&&(this.convertJson.visible=!1),this._convertPoint()}_convertPoint(){var e=this.parent.parent;if(this.originalJson.corners){var t=e.corners[this.originalJson.corners[0]],r=e.corners[this.originalJson.corners[1]];this.convertJson.points=[t[0],t[2],r[0],r[2]]}}}let fr=class extends gr{get thing2Type(){return"Entity"}get originalType(){return"Placement"}_convertTags(){this.convertJson.tags=[2]}_parseSelf(){super._parseSelf(),this._convertModel()}_convertModel(){if("number"==typeof this.originalJson.model){var e=this.resourceManager.getModelByIndex(this.originalJson.model);if(e){if("number"==typeof e.texture){var t=this._convertTextureByType(e.texture,this);"number"==typeof t&&(this.convertJson.style.map=t)}e.color&&(this.convertJson.style.color=[e.color[0],e.color[1],e.color[2]]);var r=e.rendermode;r&&1!==r&&(this.convertJson.style.opacity=1,this.convertJson.style.transparent=!0),e.color&&"number"==typeof e.color[3]&&(this.convertJson.style.opacity=e.color[3],this.convertJson.style.transparent=!0),"number"==typeof e.opacity&&(this.convertJson.style.opacity=e.opacity);var s=this.baseModel={};if(Object.assign(s,e.model?this.resourceManager.getModelById(e.model):e),this.originalJson.animinfo&&this.originalJson.animinfo.isplay){var n=this.originalJson.animinfo.clip;this.convertJson.external.animInfo={name:n},"_defaultAnim_"===n&&(this.convertJson.external.animInfo.loopType="Repeat"),delete s.hasanimation}Bt.parseModel(s,this.version,this.resourceManager.baseLocalUrl,this.convertJson),delete s.type,this.convertJson.body.id=this.resourceManager.addModel(s),this.addModelUseCount(e)}}}addModelUseCount(e){this.originalJson.animinfo&&this.originalJson.animinfo.clip.length&&this.originalJson.animinfo.isplay||this.realScale&&!(this.realScale[0]>0&&this.realScale[1]>0&&this.realScale[2]>0)||(this.resourceManager.addModelUseCount(e.id),this.enableInstance=!0)}_getWorldPosition(){var e=[0,0,0],t=function t(r){if(e=i(e,r.convertJson.position),r.parent.isGroup)return t(r.parent);return r}(this);if(t.parent.isWorld||t.parent.isOutdoor||t.parent.isMisc&&t.parent.parent.isWorld)return e;if(t.parent.isFloor){var r=i(e,t.parent.convertJson.position);return i(r,t.parent.parent.convertJson.position)}if(t.parent.isRoom){var s=i(e,t.parent.convertJson.position),n=i(s,t.parent.parent.convertJson.position);return i(n,t.parent.parent.parent.convertJson.position)}var o=i(e,t.parent.parent.convertJson.position);return i(o,t.parent.parent.parent.convertJson.position);function i(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}}};class yr extends gr{_convertSelf(e){super._convertSelf(e),this.originalJson.color&&(this.convertJson.style.color=[this.originalJson.color[0],this.originalJson.color[1],this.originalJson.color[2]]),!1===this.originalJson.isshow&&(this.convertJson.layerMask=0),this.convertJson.external.selfPoints=this.originalJson.path;for(var t=0;t<this.convertJson.external.selfPoints.length;t++)this.convertJson.external.selfPoints[t][2]*=-1;if(this.originalJson.pointuserids&&this.originalJson.pointproperteis){for(var r=[],s=0;s<this.originalJson.pointuserids.length;s++)r[s]={},r[s].id=this.originalJson.pointuserids[s],r[s].userData=this.originalJson.pointproperteis[s];this.convertJson.userData._NODEPROPERTY_=r}}}let xr=class extends yr{get thing2Type(){return"RouteLine"}get originalType(){return"CurveLine"}_convertSelf(e){super._convertSelf(e);var t=this.convertJson.external.width=this.originalJson.width||2*parseFloat(this.originalJson.radius),r=[1,-t];this.originalJson.textiling&&(r=[this.originalJson.textiling[0],-t*this.originalJson.textiling[1]]),this.originalJson.blocksize&&(r=[t/this.originalJson.blocksize[0],-t/this.originalJson.blocksize[1]]),this.convertJson.style.uv.repeat=r;var s=[0,0];this.originalJson.texoffset&&(s=[this.originalJson.texoffset[0]*r[0]/t,this.originalJson.texoffset[1]*r[1]/t]),this.originalJson.blockoffset&&(s=[this.originalJson.blockoffset[0]*r[0]/t,this.originalJson.blockoffset[1]*r[1]/t]),this.convertJson.style.uv.offset=s;var n=90;this.originalJson.blockangle&&(n+=this.originalJson.blockangle),this.convertJson.style.uv.rotation=n;var o=[0,-1];this.originalJson.matanimdirection&&(o=this.originalJson.matanimdirection),this.originalJson.enableanim&&(this.convertJson.components=[{name:"lerp",type:"LerpComponent",external:{uv:{map:{value:{offset:[s[0]-o[0],s[1]+o[1]]},options:{time:1/(this.originalJson.matanimspeed||1)*1e3,loopType:"Repeat"}}}}}])}},br=class extends yr{get thing2Type(){return"PolygonLine"}get originalType(){return"PipeLine"}_convertSelf(e){super._convertSelf(e),this.convertJson.external.radius=parseFloat(this.originalJson.radius),"Square"===this.originalJson.sectiontype?(this.convertJson.external.radialSegments=4,this.convertJson.external.startDegree=45):"Triangle"===this.originalJson.sectiontype?this.convertJson.external.radialSegments=3:this.convertJson.external.radialSegments=8,this.convertJson.style.color=this.convertJson.style.color||[0,0,1];var t=2*this.convertJson.external.radius,r=[1,1],s=1.1*t*2*Math.PI/(this.originalJson.textiling?this.originalJson.textiling[0]:1);r=[s,-s],this.originalJson.blocksize&&(r=[t/this.originalJson.blocksize[0],-t/this.originalJson.blocksize[1]]),this.convertJson.style.uv.repeat=r;var n=[0,0];this.originalJson.texoffset&&(n=[this.originalJson.texoffset[0]*r[0]/t,this.originalJson.texoffset[1]*r[1]/t]),this.originalJson.blockoffset&&(n=[this.originalJson.blockoffset[0]*r[0]/t,this.originalJson.blockoffset[1]*r[1]/t]),this.convertJson.style.uv.offset=n;var o=0;this.originalJson.blockangle&&(o+=this.originalJson.blockangle),this.convertJson.style.uv.rotation=o;var i=[1,0];this.originalJson.matanimdirection&&(i=this.originalJson.matanimdirection),this.originalJson.enableanim&&(this.convertJson.components=[{name:"lerp",type:"LerpComponent",external:{uv:{map:{value:{offset:[n[0]-i[0],n[1]+i[1]]},options:{time:1/(this.originalJson.matanimspeed||1)*1e3,loopType:"Repeat"}}}}}])}},_r=class extends br{get originalType(){return"LeakWaterLine"}},Cr=class extends xr{get originalType(){return"ArrowLine"}_convertSelf(e){super._convertSelf(e),this.convertJson.external.arrow=!0}};class Mr extends dr{get thing2Type(){return"Object3D"}get isMisc(){return!0}_convertTags(){this.convertJson.tags=[11]}_convertSelf(e){this.convertJson={children:[]},!1===this.originalJson.visible&&(this.convertJson.visible=!1),this.convertJson.type=this.thing2Type,this._convertTags()}_convertChildren(e){void 0===e&&(e={}),e.queryable=!1,super._convertChildren(e)}}class Tr extends dr{constructor(e,t,r,s){super({},t,r),this.wallType=s,this.resourceManager=this.parent.resourceManager}get thing2Type(){return"Object3D"}get originalType(){return"CombineWall"}get isWall(){return!0}_convertSelf(e){this._convertStyleTag(),this._convertTags(),this.convertJson.components=[{external:{type:this.wallType,walls:[]},name:"wallComponent",type:"WallComponent"}],this.convertJson.renderOrder=-9,this.convertJson.type=this.thing2Type}_convertTags(){this.convertJson.tags=[6,9]}_convertChildren(e){var t=this,r=this.convertJson.components[0].external.walls;this.children.forEach((s=>{var n=s.convert(e);"TextureWall"===t.wallType&&t._convertWallMaterial(n),r.push(n)})),this.convertJson.components[0].external.walls=r}_convertWallMaterial(e){var t,r=this.resourceManager,s=r.materialResourceResolver,n=e.uvrepeat;t=this.getWallMaterialResource(r.getTextureByIndex(e.lefttexture),n),e.leftMaterial=s.setMaterialResourceData(t),t=this.getWallMaterialResource(r.getTextureByIndex(e.righttexture),n),e.rightMaterial=s.setMaterialResourceData(t),t=this.getWallMaterialResource(r.getTextureByIndex(e.edgetexture),n),e.edgeMaterial=s.setMaterialResourceData(t),delete e.lefttexture,delete e.righttexture,delete e.edgetexture}getWallMaterialResource(e,t){var r=this.resourceManager,s={color:[1,1,1],metalness:.5,roughness:.5,map:_t+e.id+"."+e.ext,uv:{repeat:[t[0],t[1]]}};return e.isDefault?(s.aoMap=_t+r.wallLightMap.id+"."+r.wallLightMap.ext,r.useDefaultWallLightMap&&(s.metalness=.2,s.roughness=.8,s.defineWallAo=!0)):(s.metalness=0,s.roughness=1),s}}class Jr extends gr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.combineRoom=r.combineRoom,this._addInstancePlanes()}get sideType(){return"Double"}get defineFloorAo(){return!1}_parseSelf(){}_convertTags(){this.convertJson.tags=[6]}_addInstancePlanes(){if(!1!==this.originalJson.isshow&&!this.combineRoom){var e=this.thing2Type.toLowerCase();"slab"===e&&(e="floor");var t=this.parent.convertJson.external.points;if(this.parent.convertJson.external.holes)for(var r=0;r<this.parent.convertJson.external.holes.length;r++)t=t.concat(this.parent.convertJson.external.holes[r]);var s=e;if(s+=t.length,s+=this.sideType,s+=this.originalJson[e+"texture"],s+=this.originalJson[e+"blockangle"],s+=this.originalJson[e+"blocksize"],"number"==typeof this.originalJson[e+"customtexture"]){var n=this.resourceManager.getTextureByIndex(this.originalJson[e+"customtexture"]);n&&n.color&&(s+=n.color)}for(var o=0;o<t.length;o++){for(var i=t[o],a="",l=0;l<2;l++)a+=i[l].toFixed(3);s+=a}this.instanceString=s,this.resourceManager.addInstancePlanes(s)}}_convertSelf(e){super._convertSelf(e)}}var wr={world:class extends gr{get thing2Type(){return"Campus"}get originalType(){return"World"}get isWorld(){return!0}_parseChildren(){this._generateChildrenCreators(this.originalJson.buildings,"building"),this._generateChildrenCreators(this.originalJson.outdoors,"outdoors")}},building:class extends gr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.facades=this.facades||[],this.facadegroups=this.facadegroups||[]}get thing2Type(){return"Building"}get originalType(){return"Building"}get isBuilding(){return!0}get hideStruct(){if(this.originalJson.structshow)return!1;var e=this.originalJson.facades||[],t=this.originalJson.facadegroups||[];return!(!e.length&&!t.length)}_parseChildren(){this.facades=this._generateChildrenCreators(this.originalJson.facades,"facade"),this.facadegroups=this._generateChildrenCreators(this.originalJson.facadegroups,"facadeGroup"),this._generateChildrenCreators(this.originalJson.plans,"floorplan")}_convertSelf(e){super._convertSelf(e),this.hideStruct||(this.convertJson.external.constantShowStruct=!0)}_getWorldPosition(){return this.convertJson.position}},floorplan:vr,modelWall:class extends mr{get thing2Type(){return"PrefabWall"}get originalType(){return"ModelWall"}_parseSelf(){super._parseSelf(),void 0===this.originalJson.height||null===this.originalJson.height?this.convertJson.height=3:this.convertJson.height=this.originalJson.height}_convertSelf(e){if(super._convertSelf(e),this.originalJson.thick&&(this.convertJson.thickness=this.originalJson.thick),"number"==typeof this.originalJson.model){var t=this.resourceManager.getModelByIndex(this.originalJson.model);if("C9FB3F9A29C842F79F02CECC4037FEA1"===t.id&&(this.convertJson.fillHole=!0),t){var r={};Object.assign(r,t),Bt.parseModel(r,this.version,this.resourceManager.baseLocalUrl,this.convertJson),delete r.type,this.convertJson.model=this.resourceManager.addModel(r),this.convertJson.modelSize=r.size}}}},textureWall:class extends mr{get thing2Type(){return"StraightManualWall"}get originalType(){return"TextureWall"}_parseSelf(){super._parseSelf(),void 0===this.originalJson.height||null===this.originalJson.height?this.convertJson.height=3:this.convertJson.height=this.originalJson.height}_convertSelf(e){if(super._convertSelf(e),this.convertJson.thickness=this.originalJson.thick||.25,this.convertJson.uvrepeat=[1,1],this.originalJson.uvmultiple){var t=[parseFloat(this.originalJson.uvmultiple[0]),parseFloat(this.originalJson.uvmultiple[1])];this.convertJson.uvrepeat=[t[0],t[1]]}this.convertJson.lefttexture=this.originalJson.lefttexture,this.convertJson.righttexture=this.originalJson.righttexture,this.convertJson.edgetexture=this.originalJson.edgetexture}},placement:fr,group:class extends gr{get thing2Type(){return"Object3D"}get originalType(){return"Group"}get isGroup(){return!0}_convertTags(){this.convertJson.tags=[11]}_parseChildren(){this._generateChildrenCreators(this.originalJson.groups,"group"),this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.videoprobes,"placement")}},doororwindow:class extends fr{get thing2Type(){return this.originalJson.iswindow?"Window":"Door"}get originalType(){return"DoorOrWindow"}_convertTags(){this.parent.isFloor&&(this.convertJson.tags=[6])}addModelUseCount(e){this.originalJson.isopen||this.originalJson.diridx||this.realScale&&!(this.realScale[0]>0&&this.realScale[1]>0&&this.realScale[2]>0)||(this.resourceManager.addModelUseCount(e.id),this.enableInstance=!0)}_convertSelf(e){return super._convertSelf(e),this.convertJson.external.isOpen=this.originalJson.isopen||!1,this.convertJson.external.transformCorrection=!0,"number"==typeof this.originalJson.diridx&&(this.convertJson.external.dirIdx=this.originalJson.diridx),this.convertJson}},room:class extends gr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r)}get thing2Type(){return this.parent.isFloor?"Room":"Object3D"}_canCombine(){var e=this.originalJson;return t(e.name)&&t(e.userid)&&t(e.visible)&&t(e.layerMask)&&(t(e.properties)||1===Object.keys(e.properties).length&&"_styleTag_"===Object.keys(e.properties)[0]);function t(e){return null==e}}_convertTags(){this.parent.isFloor||(this.convertJson.tags=[3,6])}get originalType(){return"Room"}get isRoom(){return!0}_parseChildren(){if(this.parent.isFloor){var e=JSON.parse(JSON.stringify(this.originalJson));e.name=null,e.userid=null,e.properties={},this._generateChildrenCreators(e,"roomslab"),this._generateChildrenCreators(e,"roomceiling"),this._generateChildrenCreators(e,"roomroof")}}getPolygons(){var e=this.parent.corners,t=[];return this.originalJson.corners&&this.originalJson.corners.forEach((r=>{var s=e[r];t.push([s[0],s[2]])})),this.originalJson.holescorners&&this.originalJson.holescorners.forEach((r=>{r.forEach((r=>{var s=e[r];t.push([s[0],s[2]])}))})),t}_parseSelf(){this.combineRoom=this.resourceManager.combineRoom&&this._canCombine(),super._parseSelf();var e=this.parent.corners,t=[],r=[];if(this.originalJson.corners)for(var s=0;s<this.originalJson.corners.length;s++){var n=this.originalJson.corners[s];t.push(e[n])}if(this.originalJson.holescorners)for(var o=0;o<this.originalJson.holescorners.length;o++){for(var i=[],a=0;a<this.originalJson.holescorners[o].length;a++){var l=this.originalJson.holescorners[o][a];i.push(e[l])}r.push(i)}if(this.originalJson.points)for(var h=0;h<this.originalJson.points.length;h++){var c=this.originalJson.points[h];t.push([c[0],c[1],-c[2]])}if(this.originalJson.holespoints)for(var u=0;u<this.originalJson.holespoints.length;u++){for(var p=[],d=0;d<this.originalJson.holespoints[u].length;d++){var g=this.originalJson.holespoints[u][d];p.push([g[0],g[1],-g[2]])}r.push(p)}t.length&&(this.realPosition=THING.MathUtils.getLabelPosition(t)),this.parent.isFloor||"number"==typeof this.originalJson.floorheight&&(this.realPosition=[this.realPosition[0],this.realPosition[1]+(this.originalJson.floorheight||0),this.realPosition[2]]),t.length&&(this.convertJson.external.points=this._to2DPoints(t,!this.combineRoom)),r.length&&(this.convertJson.external.holes=this._to2DHoles(r,!this.combineRoom))}_convertSelf(e){super._convertSelf(e),this.parent.isFloor||(this._convertPlane("floor"),this.convertJson.components[0].external.points=this.convertJson.external.points,this.convertJson.components[0].external.holes=this.convertJson.external.holes,delete this.convertJson.external.points,delete this.convertJson.external.holes)}},outdoors:class extends vr{get thing2Type(){return"Object3D"}get originalType(){return"Outdoors"}get isFloor(){return!1}get isOutdoor(){return!0}_convertTags(){this.convertJson.tags=[7]}_parseDecodeNumber(){this.decodeNumber="3"}_generateChildrenCreators(e,t,r){super._generateChildrenCreators(e,t,r)}__generateChildrenCreators(e,t,r){void 0===r&&(r=this.parent),super.__generateChildrenCreators(e,t,r)}_convertCombinePlanes(e){var t=[];e.forEach((e=>{if(0!==e.layerMask){var r=this._getCombinePlaneKey(e);this._makeCombinePlane(t,r,e)}})),this._setCombinePlaneData(t)}},facade:class extends fr{get thing2Type(){return"BaseEntity"}_convertTags(){this.convertJson.tags=[1]}get originalType(){return"Facade"}},facadeGroup:class extends gr{get thing2Type(){return"Group"}get originalType(){return"FacadeGroup"}_parseChildren(){this._generateChildrenCreators(this.originalJson.facades,"facade"),this._generateChildrenCreators(this.originalJson.groups,"facadeGroup")}_convertSelf(e){super._convertSelf(e),this.convertJson.external.tags="Facade"}},curveLine:xr,leakWaterLine:_r,arrowLine:Cr,arrowDataLine:class extends Cr{get originalType(){return"ArrowDataLine"}},pipeLine:br,routeLine:class extends xr{_convertSelf(e){super._convertSelf(e),this.convertJson.style.color=this.convertJson.style.color||[0,0,1]}get originalType(){return"RouteLine"}},placementWall:class extends fr{get thing2Type(){return"Object3D"}get originalType(){return"PlacementWall"}_convertTags(){this.convertJson.tags=[6,9]}_convertSelf(e){super._convertSelf(e),this.convertJson.renderOrder=-9}},ground:class extends fr{get originalType(){return"Ground"}_convertTags(){}},generalPolygonLine:class extends _r{_convertSelf(e){super._convertSelf(e),this.originalJson.color||delete this.convertJson.style.color}get originalType(){return"GeneralPolygonLine"}},generalRouteLine:class extends xr{_convertSelf(e){super._convertSelf(e),this.originalJson.arrowVisible&&(this.convertJson.external.arrow=!0)}get originalType(){return"GeneralRouteLine"}},misc:Mr,wall:Tr,roomslab:class extends Jr{get defineFloorAo(){return!0}get thing2Type(){return"Object3D"}get originalType(){return"RoomSlab"}_convertTags(){super._convertTags(),this.convertJson.tags.push(3)}_parseSelf(){}_convertSelf(e){super._convertSelf(e),this.convertJson.uuid=this.resourceManager.addUUID(ir.generateUUID()),"number"==typeof this.originalJson.floorheight?this.convertJson.position=[0,this.originalJson.floorheight,0]:this.convertJson.position=[0,.01,0],this.convertJson.renderOrder=-10,this._convertPlane("floor")}},roomroof:class extends Jr{get sideType(){return"Back"}get thing2Type(){return"Object3D"}get originalType(){return"RoomCeiling"}_convertTags(){super._convertTags(),this.convertJson.tags.push(5)}_parseSelf(){}_convertSelf(e){super._convertSelf(e),this.convertJson.uuid=this.resourceManager.addUUID(ir.generateUUID()),this.convertJson.position=[0,(this.originalJson.ceilingheight||this.parent.parent.convertJson.height||3)-.1,0],this.convertJson.castShadow=!1,this._convertPlane("ceiling")}},roomceiling:class extends Jr{get thing2Type(){return"Object3D"}get originalType(){return"RoomRoof"}get sideType(){return"Front"}_convertTags(){super._convertTags(),this.convertJson.tags.push(4)}_parseSelf(){}_convertSelf(e){super._convertSelf(e),this.convertJson.uuid=this.resourceManager.addUUID(ir.generateUUID()),this.convertJson.position=[0,(this.originalJson.roofheight||this.parent.parent.convertJson.height||3)+.005,0],this._convertPlane("roof")}},emptyObject:class extends fr{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[8]}_convertSelf(e){super._convertSelf(e),this.convertJson.layerMask=0,this.convertJson.external.oriType="Thing",this.convertJson.body&&"number"==typeof this.convertJson.body.id&&(this.convertJson.external.body={},this.convertJson.external.body.id=this.convertJson.body.id,delete this.convertJson.body)}}};class Sr{static getMap(){return wr}}class Rr extends ur{import(e,t){return new Promise(((r,s)=>{var n=super.import(e,t),o=Sr.getMap(),i=new o.world({creatorMap:o,version:this.version,resourceManager:this.resourceManager},e.scene);n.then((()=>{r(i)}))}))}getCreatorConfig(){return Sr}}class Er extends dr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.version=e.version,this.useInverseRotation=null,this._parseSelf(),e.noCreateChildren||this._parseChildren()}_parseSelf(){this._convertModel()}_convertSelf(e){if(super._convertSelf(e),this._convertExcludeNodeNames(),"number"==typeof this.convertJson.body.id&&this.resourceManager.modelUseCount[this.convertJson.body.id]>1){this.convertJson.external.instance=this.resourceManager.getInstance(this.convertJson.body.id),this.convertJson.external.instanceId=1e4+this.convertJson.external.instance,this.convertJson.external.instanceCount=this.resourceManager.modelUseCount[this.convertJson.body.id];var t=Object.keys(this.convertJson.style||{}).length;if(t){if(1===t&&this.convertJson.style.uv&&!Object.keys(this.convertJson.style.uv).length)return;this.convertJson.external.instanceStyle=this.convertJson.style,delete this.convertJson.style}}var r=this.resourceManager.getRenderOrder(this.convertJson.body.node);r&&(this.convertJson.renderOrder=r)}_convertExcludeNodeNames(){if("number"==typeof this.convertJson.body.id){for(var e=[],t=0;t<this.children.length;t++){var r=this.children[t];r.convertJson.body&&r.convertJson.body.node&&e.push(r.convertJson.body.node)}e.length&&(this.convertJson.body.excludeNodeNames=e)}}_convertTransform(){var e=this.resourceManager.getTransform(this.convertJson.body.node),t=this.originalJson.position;!t||0===t[0]&&0===t[1]&&0===t[2]?e&&(this.convertJson.position=this.realPosition=e.position):this.convertJson.position=this.realPosition=[t[0],t[1],t[2]];var r=this.originalJson.rotation;!r||0===r[0]&&0===r[1]&&0===r[2]&&1===r[3]?e&&(this.convertJson.quaternion=this.useInverseRotation=this.realRotation=e.quaternion):this.convertJson.quaternion=this.realRotation=[r[0],r[1],r[2],r[3]];var s=this.originalJson.scale;!s||1===s[0]&&1===s[1]&&1===s[2]?e&&(this.convertJson.scale=this.realScale=e.scale):this.convertJson.scale=this.realScale=[s[0],s[1],s[2]]}_convertModel(){if("number"==typeof this.originalJson.model){var e=this.resourceManager.getModelByIndex(this.originalJson.model);if(e){var t={};Object.assign(t,e),Bt.parseModel(t,this.version,this.resourceManager.baseLocalUrl,this.convertJson),t.applyTransposeToMesh&&(this.convertJson.body.inverseRotationMode="InverseRotationToMesh"),t.applyTransposeToVertices&&(this.convertJson.body.inverseRotationMode="InverseRotationToVertices"),delete t.applyTransposeToMesh,delete t.applyTransposeToVertices,delete t.type,this.convertJson.body.id=this.resourceManager.addModel(t),this.originalJson.node?this.convertJson.body.node=this.originalJson.node:this.resourceManager.addModelUseCount(this.convertJson.body.id)}}}}let Ir=class extends Er{get thing2Type(){return"Entity"}_convertTags(){this.convertJson.tags=[2]}get originalType(){return"Placement"}_convertSelf(e){super._convertSelf(e),this.originalJson.animinfo&&this.originalJson.animinfo.clip.length&&this.originalJson.animinfo.isplay&&(this.convertJson.external.animInfo={},this.convertJson.external.animInfo.clips=[this.originalJson.animinfo.clip])}},Pr=class extends Er{get thing2Type(){return"Floor"}get originalType(){return"Floorplan"}get isFloor(){return!0}_parseSelf(){super._parseSelf(),this.originalJson.corners||(this.originalJson.corners=[])}_parseChildren(){this._generateChildrenCreators(this.originalJson.walls,"placementWall"),this._generateChildrenCreators(this.originalJson.rooms,"room"),this._generateChildrenCreators(this.originalJson.doororwindows,"doororwindow"),this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.groups,"group"),this.__generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement")}_generateChildrenCreators(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible?e.visible=!1:this.isFloor&&!this.originalJson.alwaysshowinsideobjs&&("room"===t||t.includes("Wall")||(e.visible=!1)),r=r||this,!1===this.originalJson.visible&&(e.visible=!1);var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}__generateChildrenCreators(e,t,r){void 0===r&&(r=this),e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{(!1===this.originalJson.visible||this.isFloor&&!this.originalJson.alwaysshowinsideobjs)&&(e.visible=!1),this.misc||(this.misc=new this.creatorMap.misc(this.options,{visible:e.visible},r),r.children.push(this.misc));var s=new this.creatorMap[t](this.options,e,this.misc);this.misc.children.push(s)})))}_convertExcludeNodeNames(){this.isFloor&&"number"==typeof this.convertJson.body.id&&(this.convertJson.body.excludeNodeNames="All")}_convertSelf(e){super._convertSelf(e),this.originalJson.height&&(this.convertJson.height=this.originalJson.height),this.originalJson.corners&&(this.convertJson.external.corners=this.originalJson.corners),"Building"===this.parent.thing2Type&&this.parent.hideStruct&&(this.convertJson.visible=!1),this.isFloor&&(this.convertJson.external.constantShowThings=!!this.originalJson.alwaysshowinsideobjs)}},Dr=class extends Pr{get thing2Type(){return"Object3D"}get originalType(){return"Outdoors"}get isFloor(){return!1}_convertTags(){this.convertJson.tags=[7]}_parseChildren(){this._generateChildrenCreators(this.originalJson.walls,"placementWall"),this._generateChildrenCreators(this.originalJson.rooms,"room"),this._generateChildrenCreators(this.originalJson.doororwindows,"doororwindow"),this._generateChildrenCreatorsByTjsType(this.originalJson.placements,"placement"),this._generateChildrenCreatorsByTjsType(this.originalJson.groups,"group"),this.__generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement")}_generateChildrenCreatorsByTjsType(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible&&(e.visible=!1),r=e.properties&&"Ground"===e.properties._tjsType_?this:this.parent;var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}_convertSelf(e){super._convertSelf(e),this.convertJson.name=""}_generateChildrenCreators(e,t,r){super._generateChildrenCreators(e,t,r)}__generateChildrenCreators(e,t,r){void 0===r&&(r=this.parent),super.__generateChildrenCreators(e,t,r)}},Nr=class extends Er{get thing2Type(){return"Room"}get originalType(){return"Room"}_convertExcludeNodeNames(){}_convertSelf(e){if(super._convertSelf(e),this.originalJson.points&&this.originalJson.points.length){for(var t=0;t<this.originalJson.points[0].length;t++)this.convertJson.external.points=this._to2DPoints(this.originalJson.points[0],!0);if(this.originalJson.points.length>1){this.convertJson.external.holes=[];for(var r=1;r<this.originalJson.points.length;r++)this.convertJson.external.holes.push(this._to2DPoints(this.originalJson.points[r],!0))}}var s={uuid:this.resourceManager.addUUID(ir.generateUUID()),type:"Object3D",name:"slab",tags:[3],body:this.convertJson.body,external:this.convertJson.external,quaternion:this.convertJson.quaternion,renderOrder:this.convertJson.renderOrder||-10,userData:{_styleTag_:St}};return this.parent.isFloor&&s.tags.push(6),this.convertJson.children.push(s),delete this.convertJson.body,delete this.convertJson.quaternion,delete this.convertJson.renderOrder,this.convertJson}_parseSelf(){super._parseSelf()}};var Or={world:class extends Er{_parseChildren(){this._generateChildrenCreators(this.originalJson.outdoors,"outdoors"),this._generateChildrenCreators(this.originalJson.buildings,"building")}_convertExcludeNodeNames(){}get thing2Type(){return"Campus"}get originalType(){return"World"}},building:class extends Er{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.facades=[],this.facadegroups=[]}_parseChildren(){this.facades=this._generateChildrenCreators(this.originalJson.facades,"facade"),this.facadegroups=this._generateChildrenCreators(this.originalJson.facadegroups,"facadeGroup"),this._generateChildrenCreators(this.originalJson.plans,"floorplan")}get thing2Type(){return"Building"}get originalType(){return"Building"}get isBuilding(){return!0}get hideStruct(){if(this.originalJson.structshow)return!1;var e=this.originalJson.facades||[],t=this.originalJson.facadegroups||[];return!(!e.length&&!t.length)}_convertExcludeNodeNames(){"number"==typeof this.convertJson.body.id&&(this.convertJson.body.excludeNodeNames="All")}_convertSelf(e){super._convertSelf(e),this.hideStruct||(this.convertJson.external.constantShowStruct=!0)}},combinePlacement:class extends Er{get thing2Type(){return"Entity"}_convertTags(){this.convertJson.tags=[2]}get originalType(){return"CombinePlacement"}},doororwindow:class extends Er{get thing2Type(){return this.originalJson.iswindow?"Window":"Door"}get originalType(){return"DoorOrWindow"}_convertTags(){this.parent.isFloor&&(this.convertJson.tags=[6])}},facadeGroup:class extends Er{_parseChildren(){this._generateChildrenCreators(this.originalJson.facades,"facade"),this._generateChildrenCreators(this.originalJson.groups,"facadeGroup")}get thing2Type(){return"Group"}get originalType(){return"FacadeGroup"}_convertSelf(e){super._convertSelf(e),this.convertJson.external.tags="Facade"}},facade:class extends Ir{get thing2Type(){return"BaseEntity"}_convertTags(){this.convertJson.tags=[1]}get originalType(){return"Facade"}},floorplan:Pr,group:class extends Er{_parseChildren(){this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.groups,"group")}_convertTags(){this.convertJson.tags=[11]}get thing2Type(){return"Object3D"}get originalType(){return"Group"}},outdoors:Dr,placementWall:class extends Er{get thing2Type(){return"Wall"}get originalType(){return"PlacementWall"}_convertSelf(e){this.convertJson.renderOrder=-9,super._convertSelf(e)}_convertTags(){this.parent.isFloor&&(this.convertJson.tags=[6])}},placement:Ir,room:Nr,misc:Mr};class Lr{static getMap(){return Or}}let Fr=class extends Pr{};var Ar=Lr.getMap();Ar.floorplan=Fr;class zr{static getMap(){return Ar}}let jr=class extends Er{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[3],this.parent.isFloor&&this.convertJson.tags.push(6)}_convertSelf(e){this.convertJson.renderOrder=-10,super._convertSelf(e)}};var Br=zr.getMap();Br.floorplan=class extends Fr{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.combinefloors,"combineFloor"),this._generateChildrenCreators(this.originalJson.combineroofs,"combineRoof"),this._generateChildrenCreators(this.originalJson.combineceilings,"combineCeiling")}},Br.outdoors=class extends Dr{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.combinefloors,"combineFloor"),this._generateChildrenCreators(this.originalJson.combineroofs,"combineRoof"),this._generateChildrenCreators(this.originalJson.combineceilings,"combineCeiling")}},Br.combineFloor=jr,Br.combineCeiling=class extends jr{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[5],this.parent.isFloor&&this.convertJson.tags.push(6)}},Br.combineRoof=class extends jr{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[4],this.parent.isFloor&&this.convertJson.tags.push(6)}};class kr{static getMap(){return Br}}var Gr=kr.getMap();Gr.room=class extends Nr{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.placements,"placement",this),this._generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement",this),this._generateChildrenCreators(this.originalJson.groups,"group",this)}};class Ur{static getMap(){return Gr}}var Hr=Ur.getMap();Hr.placement=class extends Ir{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.placements,"placement",this)}};class Vr{static getMap(){return Hr}}class Wr extends ur{constructor(e){super(e),this._versionMap={0:{0:Lr,1:zr,2:zr,3:kr,4:Ur,5:Ur,6:Vr}},this._smallVersionLibs=[[0,1,2,3,4,5,6]],this._bigVersions=[0]}import(e,t){return new Promise(((r,s)=>{var n=super.import(e,t),o=this._getCreatorConfig(this.version.bigVersion,this.version.smallVersion).getMap(),i=new o.world({creatorMap:o,version:this.version,resourceManager:this.resourceManager},e.scene);n.then((()=>{r(i)}))}))}getCreatorConfig(e,t){return this._getCreatorConfig(e,t)}}class qr extends dr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.dataHandleMap=e.dataHandleMap,this._parseLoadVersion(),this._parseSelf(),this._parseChildren()}_parseLoadVersion(){this.originalJson.loadversion?this.loadVersion=new jt(this.originalJson.loadversion):this.parent&&this.parent.loadVersion?this.loadVersion=new jt(this.parent.loadVersion.mode):this.loadVersion=new jt(3)}_parseSelf(){var e,t=this.dataHandleMap[this.loadVersion.mode].getCreatorConfig(this.loadVersion.bigVersion,this.loadVersion.smallVersion).getMap(),r=t[this.creatorType];this.parent&&(e=this.parent.creator||this.parent),this.creator=new r({creatorMap:t,noCreateChildren:this.noCreateChildren,version:this.loadVersion,resourceManager:this.resourceManager},this.originalJson,e)}convert(e){return this.convertJson=this.creator.convert(e),this.convertJson.children||(this.convertJson.children=[]),this._convertChildren(e),this._cutEmptyJson(),this.convertJson}get noCreateChildren(){return!0}}class Qr extends qr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.rooms=this.rooms||[]}_parseSelf(){super._parseSelf(),this.corners=this.creator.corners}_parseChildren(){var e=this.originalJson.walls;if(e){var t=[],r=[],s=[];if(e.forEach((e=>{0===e.type?r.push(e):1===e.type?t.push(e):s.push(e)})),t.length){var n=new this.creatorMap.wall(this.options,{},this,"ModelWall");this.children.push(n),this._generateChildrenCreators(t,"modelWall",n)}if(r.length){var o=new this.creatorMap.wall(this.options,{},this,"TextureWall");this.children.push(o),this._generateChildrenCreators(r,"textureWall",o)}this._generateChildrenCreators(s,"placementWall")}this.rooms=this._generateChildrenCreators(this.originalJson.rooms,"room"),this._generateChildrenCreators(this.originalJson.grounds,"ground"),this._generateChildrenCreators(this.originalJson.doororwindows,"doororwindow"),this._generateChildrenCreators(this.originalJson.combinefloors,"combineFloor"),this._generateChildrenCreators(this.originalJson.combineroofs,"combineRoof"),this._generateChildrenCreators(this.originalJson.combineceilings,"combineCeiling"),this._generateChildrenCreators(this.originalJson.curvelines,"curveLine"),this._generateChildrenCreators(this.originalJson.routelines,"routeLine"),this._generateChildrenCreators(this.originalJson.leakwaterlines,"leakWaterLine"),this._generateChildrenCreators(this.originalJson.arrowlines,"arrowLine"),this._generateChildrenCreators(this.originalJson.arrowdatalines,"arrowDataLine"),this._generateChildrenCreators(this.originalJson.pipelines,"pipeLine"),this._generateChildrenCreators(this.originalJson.generalpolygonlines,"generalPolygonLine"),this._generateChildrenCreators(this.originalJson.generalroutelines,"generalRouteLine"),this.__generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement"),this.__generateChildrenCreators(this.originalJson.placements,"placement"),this.__generateChildrenCreators(this.originalJson.groups,"group"),this.__generateChildrenCreators(this.originalJson.videoprobes,"placement")}__generateChildrenCreators(e,t,r){if(void 0===r&&(r=this),e){Array.isArray(e)||(e=[e]);var s=this,n=r;function o(){s.misc||(s.misc=new s.creatorMap.misc(s.options,{},r),r.children.push(s.misc)),n=s.misc}e.forEach((e=>{var s=new this.creatorMap[t](this.options,e,this);if(s.isShouldCombine)o();else if(3===s.loadVersion.mode){this._isShouldCombine(s)&&o()}if(s.originalJson._temp_belongroom)for(var i=0;i<this.rooms.length;i++)if(3===this.rooms[i].loadVersion.mode){var a=this.rooms[i].creator,l=s.creator;if(a.originalJson.userid&&a.originalJson.userid===l.originalJson._temp_belongroom){l.realPosition&&(l.realPosition=[l.realPosition[0]-a.realPosition[0],l.realPosition[1]-a.realPosition[1],l.realPosition[2]-a.realPosition[2]]),n=a;break}}s.parent=n,n.children.push(s),n=r}))}}get creatorType(){return"floorplan"}get isFloor(){return!0}}var Yr={world:class extends qr{_parseChildren(){this._generateChildrenCreators(this.originalJson.buildings,"building"),this._generateChildrenCreators(this.originalJson.outdoors,"outdoors")}get creatorType(){return"world"}},building:class extends qr{_parseChildren(){this._generateChildrenCreators(this.originalJson.facades,"facade"),this._generateChildrenCreators(this.originalJson.facadegroups,"facadeGroup"),this._generateChildrenCreators(this.originalJson.plans,"floorplan")}get creatorType(){return"building"}},facadeGroup:class extends qr{get creatorType(){return"facadeGroup"}get noCreateChildren(){return!1}},facade:class extends qr{get creatorType(){return"facade"}},floorplan:Qr,outdoors:class extends Qr{get creatorType(){return"outdoors"}__generateChildrenCreators(e,t,r){void 0===r&&(r=this.parent),super.__generateChildrenCreators(e,t,r)}get isFloor(){return!1}},group:class extends qr{get creatorType(){return"group"}get noCreateChildren(){return!1}},room:class extends qr{_parseChildren(){this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement"),this._generateChildrenCreators(this.originalJson.groups,"group")}get creatorType(){return"room"}get noCreateChildren(){return!1}},placement:class extends qr{get creatorType(){return"placement"}},combinePlacement:class extends qr{get creatorType(){return"combinePlacement"}get isShouldCombine(){return!0}},doororwindow:class extends qr{get creatorType(){return"doororwindow"}},ground:class extends qr{get creatorType(){return"ground"}},modelWall:class extends qr{get creatorType(){return"modelWall"}get noCreateChildren(){return!1}},textureWall:class extends qr{get creatorType(){return"textureWall"}get noCreateChildren(){return!1}},placementWall:class extends qr{get creatorType(){return"placementWall"}},arrowLine:class extends qr{get creatorType(){return"arrowLine"}},arrowDataLine:class extends qr{get creatorType(){return"arrowDataLine"}},curveLine:class extends qr{get creatorType(){return"curveLine"}},leakWaterLine:class extends qr{get creatorType(){return"leakWaterLine"}},pipeLine:class extends qr{get creatorType(){return"pipeLine"}},routeLine:class extends qr{get creatorType(){return"routeLine"}},generalPolygonLine:class extends qr{get creatorType(){return"generalPolygonLine"}},generalRouteLine:class extends qr{get creatorType(){return"generalRouteLine"}},combineCeiling:class extends qr{get creatorType(){return"combineCeiling"}},combineFloor:class extends qr{get creatorType(){return"combineFloor"}},combineRoof:class extends qr{get creatorType(){return"combineRoof"}},misc:Mr,wall:Tr};class Zr{static getMap(){return Yr}}class Xr extends ur{import(e,t){return new Promise(((r,s)=>{var n=super.import(e,t),o=new Rr(this.param),i=new Wr(this.param),a=Zr.getMap(),l=new a.world({creatorMap:a,dataHandleMap:{3:o,5:i},resourceManager:this.resourceManager},e.scene);n.then((()=>{r(l)}))}))}getCreatorConfig(){return Zr}}class Kr{static getDataHandler(e){var t,r=e.index,s=new jt(r.version);if(e.version=s,3===s.mode?t=Rr:5===s.mode?t=Wr:7===s.mode&&(t=Xr),t)return new t(e)}}var $r=Symbol("private");class es{constructor(e){this[$r]={};var t=this[$r];t.app=e.app,t.combineRoom=e.combineRoom||!1,t.dataHandle=null}convert(e){var t=this;return Lt((function*(){var r=yield t.parseTjs(e);return t.convertToThing2(r)}))()}parseTjs(e){var t=this;return Lt((function*(){var r=t[$r];return e.app=r.app,e.combineRoom=r.combineRoom,r.dataHandle=Kr.getDataHandler(e),yield r.dataHandle.import(e)}))()}convertToThing2(e){for(var t=this[$r],r=e.convert(),s=t.dataHandle.resourceManager,n=[],o=0;o<s.exportInstanceCount.length;o++)n[o]=s.exportInstanceCount[o].length;var i={version:"1.0.0",objects:[r],resources:{rootPath:{model:bt,texture:_t},models:s.exportModels,images:s.exportTextures,cubeTextures:s.cubeTextures,uuids:s.exportUuids,tags:mt,instanceCount:n}},a=s.materialResourceResolver.getData().styles;return a.length&&(i.resources.resolvers=[{type:"MaterialResourceResolver",data:{styles:a}}]),s.viewpoint&&(i.viewpoint=s.viewpoint),i.envMap={outer:s.outerEnvMapIndex,inner:s.innerEnvMapIndex},s.outEnvMap,i}get matrixNode(){return this[$r].dataHandle.resourceManager.matrixNode}set matrixNode(e){this[$r].dataHandle.resourceManager.matrixNode=e}}class ts extends rt{constructor(){super(),this._restructureData=(e,t,r)=>{var s=t.objects[0];!e.uuid&&s.uuid&&(r.uuid=s.uuid),!e.id&&s.id&&(r.id=s.id),!e.name&&s.name&&(r.name=s.name);var n=s.extras||s.external;if(n){var o=r.external||{};for(var i in n)o[i]||(o[i]=n[i]);r.external=n}t.objects=s.children},this._thingjsConfigParse=null,this._thingjsconfig=null}parseOptions(e,t){return e.info.main="scene.json",super.parseOptions(e,t)}onLoadSceneFile(e,t){var r=t.owner.app;return new Promise(((s,n)=>{super.onLoadSceneFile(e,t).then((n=>{var o={url:e.url,index:e.info,scene:n};this._thingjsConfigParse=new ar({app:r,url:o.url}),this._thingjsconfig=o.scene.thingjsconfig,this._thingjsConfigParse.parse(this._thingjsconfig,t),(this._convertManager=new es({app:r,combineRoom:t.combineRoom})).convert(o).then((e=>{t.owner._isTempRoot||this._restructureData(t,e,t.owner),s(e)}))}))}))}onLoadComplete(e,t,r){this._thingjsConfigParse.parseLight(this._thingjsconfig,r),this._convertManager.matrixNode&&(this._convertManager.matrixNode.dispose(),this._convertManager.matrixNode=null),t.renderSettings=this._thingjsconfig,super.onLoadComplete(e,t,r)}}THING.App.addCompleteCallback((e=>{e.registerBundleLoader("scene",new ts)}),-4);var rs=Object.freeze({__proto__:null,COMPILETIME:"Fri, 10 Nov 2023 08:01:18 GMT",VERSION:"1.0.0"});for(var ss in vt){var ns=vt[ss];"VERSION"!=ss&&"COMPILETIME"!=ss&&window.THING.Utils.registerClass(ss,ns)}window.THING.CAMPUS=vt,window.THING.SCENE_CONVERT=rs}));
