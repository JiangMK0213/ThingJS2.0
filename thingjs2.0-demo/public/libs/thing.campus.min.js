!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t){var r=function(t,r){if("object"!==e(t)||null===t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,r||"default");if("object"!==e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"===e(r)?r:String(r)}function r(e,r,s){return(r=t(r))in e?Object.defineProperty(e,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[r]=s,e}var s=[0,0,0],n={},o=0;o=THING.MathUtils.randomFloat(.1,1),THING.Utils.getFileSize(THING.Utils._scriptLoader.getCurrentScriptUrl(),(e=>{o=e?Math.abs((1904366729^parseInt(0x71801ca3))-e)<=10?0:o:0}));let i=class e extends THING.Utils{static parseCamInfo(e,t){var r=e.extras||e.external;if(!r)return null;var s=r.camInfo;return s?{target:t.selfToWorld(s.target),position:t.selfToWorld(s.eye)}:null}static playAnimationFromExtras(e,t){if(e){var r=e.animInfo;if(r)r.clips.forEachAsync((e=>t.playAnimationAsync({name:e,loopType:"_defaultAnim_"==e?THING.LoopType.Repeat:THING.LoopType.Once})))}}static loadModelPartial(t,r,s,o){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:n;e.setLoadModelPartialCallbacks(t,r,i);var a=t.model;a||(a=new THING.ModelResourceComponent,t.addComponent(a,"model")),a.load({extras:r},s,o)}static setLoadModelPartialCallbacks(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n;e.resource.nodeName&&(r.onBeforeSetup?t.modelOptions.onBeforeSetup=r.onBeforeSetup:t.modelOptions.onBeforeSetup=t=>{!function(e,t){e.getLocalPosition(l),e.getLocalQuaternion(h),e.getLocalScale(c);var r=t.getPosition(),s=t.getScale(),n=t.getQuaternion();u(l,r)||(e.localPosition=r);u(c,s)||(e.localScale=s);u(h,n)||(e.localQuaternion=n);t.setPosition(i.DefaultPosition),t.setQuaternion(i.DefaultQuaternion),t.setScale(i.DefaultScale)}(e,t.node)})}static toSelfPoints(e,t){return t.map((t=>{var r=e.localToSelf(t,!1,s);return[r[0],r[2]]}))}static toSelfHoles(t,r){return r.map((r=>e.toSelfPoints(t,r)))}};function a(){return o||0}r(i,"DefaultPosition",[0,0,0]),r(i,"DefaultScale",[1,1,1]),r(i,"DefaultQuaternion",[0,0,0,1]);var l=[0,0,0],h=[0,0,0,1],c=[1,1,1];function u(e,t){for(var r=0;r<e.length;r++){var s=e[r],n=t[r];if(void 0===n)return!1;if(s!==n)return!1}return!0}class d extends THING.Object3D{onLoadRenderableResource(e,t,r){if(this.destroyed)r("The object had been destroyed, skip to load resources");else{var s=Object.assign({},e);s.root=this,s.onComplete=s.complete=t,s.onError=s.error=r,s.root=this,delete s.url,this.app.load(this.resource.url,s)}}onSetupComplete(e){super.onSetupComplete(e);var t=this.level.viewpoint;if(t){var r=(e=e||{}).extras||e.external||{};this.trigger("aftersetup",e),this._useCamInfo=i.parseValue(r.useCamInfo,!0),this._useCamInfo&&(this.app.camera.position=t.position,this.app.camera.target=t.target)}this.children.waitForComplete().then((()=>{this.app.camera.control.processAdjustNear()}))}get buildings(){return this.children.query("tags:or(Building)")}get ground(){return this.children.find("tags:or(Ground)")}get misc(){return this.children.find("tags:or(Misc)")}}r(d,"defaultTagArray",["Campus"]);class p{static parseExtrasData(e){var t=e.data.extras=e.data.extras||{};return t._isParsed_||(this.onParse(e),t._isParsed_=!0),t}static onParse(e){var t=e.data.extras,r=e.parentData;THING.Utils.isNull(t.constantShowThings)&&r&&(t.constantShowThings=THING.Utils.parseBoolean(r.constantShowThings,!0)),e.data.extras=t}static getTextureUrl(e,t){var r=e.url,s=e.ext;return s&&(r=r+"."+s),t.toolkit.resolveTextureURL(r)}static getTextureData(e,t){var r=t.textures;if(r){var s=r[e];if(s)return s}var n=t.images;if(n)return n[e]}static getModelUrl(e,t){var r=e.url;return t.toolkit.resolveModelURL(r,e.version)}static getModelData(e,t){var r=t.models;if(r)return r[e]}}let g=class extends THING.Object3D{constructor(e){if(super(e),e){var t=e.extras||e.external;t&&!1===t.constantShowThings&&(this.visible=!1)}}static parseExtrasData(e){return p.parseExtrasData(e)}};r(g,"defaultTagArray",["Misc"]);let v=class extends THING.Object3D{constructor(e){super(e);var t=e.extras||e.external;t&&this._import(t)}_import(e){this._corners=e.corners}get corners(){return this._corners}get slabs(){return this.children.query(".Slab")}static parseExtrasData(e){var t=p.parseExtrasData(e);return t.isGround=!0,t}};r(v,"defaultTagArray",["Ground"]);var m=0,f=1,y=2,x=3;class _ extends THING.BaseComponent{constructor(){super(),this.expandingCount=0,this.expandState=m}setData(e){e&&(e.objects&&e.objects.length&&(this.objs=e.objects||this.object.children),this.flyTime=e.duration||e.time||this.flyTime||1e3,this.length=e.length||e.distance||10,e.horzMode&&(this.horzMode=THING.Utils.parseValue(e.horzMode,!1)),this.hideRoof=THING.Utils.parseValue(e.hideRoof,!1),this.callback=e.onComplete||e.complete||this.callback,this.expandFloorsNumber=e.number||5,this.skipRoof=THING.Utils.parseValue(e.skipRoof,!1))}initPosition(){for(var e=0;e<this.objs.length;e++){var t=this.objs[e],r=t.bodyNode.getUserData();r.expandInitPos=r.expandInitPos||[...t.position],t.bodyNode.setUserData(r)}}clearInitPosition(){for(var e=0;e<this.objs.length;e++){var t=this.objs[e],r=t.bodyNode.getUserData();delete r.expandInitPos,t.bodyNode.setUserData(r)}}expandObj(e,t){this.initPosition();var r=e.bodyNode.getUserData().expandInitPos,s=THING.MathUtils.getDistance(r,e.position),n=this.horzMode,o=t*this.length-s,i=0;e.bodyNode.getUserData().expandOffsetDistance=o;var a=this;e.expandTween=this.app.tweenManager.lerpTo({progress:0},{progress:1},this.flyTime).onStart((()=>{if(e.isFloor&&!THING.Utils.isNull(a.hideRoof)&&!a.skipRoof){var t=!a.hideRoof;e.roofs.forEach((e=>{e.visible!=t&&(e._changeVisibleByExpand=!0,e.visible=t)}))}})).onUpdate((t=>{var r=t.value.progress-i,s=o*r;i=t.value.progress,n?e.translateZ(s):e.translateY(s)})).onComplete((function(){a.onExpandComplete(),a.objs.length})).start()}unexpandObj(e,t){var r=e.bodyNode.getUserData().expandInitPos,s=THING.MathUtils.getDistance(r,e.position),n=this.horzMode,o=s||e.bodyNode.getUserData().expandOffsetDistance,i=0;this.length<0&&(o*=-1);var a=this;e.unexpandTween=this.app.tweenManager.lerpTo({progress:0},{progress:1},this.flyTime).onUpdate((function(t){var r=t.value.progress-i,s=o*r;i=t.value.progress,n?e.translateZ(-s):e.translateY(-s)})).onComplete((function(){if(e.isFloor&&a.hideRoof&&!a.skipRoof){var t=a.hideRoof;e.roofs.forEach((e=>{e.visible!=t&&(e._changeVisibleByExpand=!0,e.visible=t)}))}a.onExpandComplete(),a.objs.length})).start()}execute(){if(this.expandState!=f&&this.expandState!=y){this.expandState==x&&this.stopExpanding(),this.expandingCount=0,this.expandState=f;for(var e=0,t=0;t<this.objs.length;t++){var r=this.objs[t];this.expandObj(r,e),e++,this.horzLength&&e%this.expandFloorsNumber==0&&(e=0)}}}undo(){if(this.expandState!=x&&this.expandState!=m){this.expandState==f&&this.stopExpanding(),this.expandingCount=0,this.expandState=x;for(var e=0;e<this.objs.length;e++){var t=this.objs[e];this.unexpandObj(t,e)}}}stopExpanding(){if(this.expandState!=m)for(var e=0;e<this.objs.length;e++){var t=this.objs[e];t.expandTween&&(t.expandTween.stop(),t.expandTween=null),t.unexpandTween&&(t.unexpandTween.stop(),t.unexpandTween=null)}}onExpandComplete(){this.expandState!=m?(this.expandingCount++,this.expandingCount<this.objs.length||(this.expandState==f?(this.expandState=y,this.callback&&(this.callback(this.expandState),this.callback=null)):this.expandState==x&&(this.clearInitPosition(),this.expandState=m,this.callback&&(this.callback(this.expandState),this.callback=null)))):THING.Utils.error("onExpandComplete should not come here!")}}let b=class extends THING.Object3D{constructor(e){if(super(e),this._constantShowStruct=!1,e){var t=e.extras||e.external;t&&(this._constantShowStruct=!0===t.constantShowStruct)}}hasFacade(){return 0!==this.facades.length}get facades(){return this.children.query("tags:or(Facade)")}get floors(){return this.children.query("tags:or(Floor)")}showAllRoofs(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.floors.forEach((function(t){t.showAllRoofs(e)}))}expandFloors(e){e=e||{},this.expandObjectsComponent||this.addComponent(_,"expandObjectsComponent"),e.objects=this.floors.objects,e.hideRoof=i.parseValue(e.hideRoof,!0),this.expandObjectsComponent.setData(e),this.expandObjectsComponent.execute(),this._expanded=!0}unexpandFloors(e){e=e||{},this.expandObjectsComponent?(e.hideRoof&&(e.hideRoof=!e.hideRoof),this.expandObjectsComponent.setData(e),this.expandObjectsComponent.undo(),this._expanded=!1):this.addComponent(_,"expandObjectsComponent")}get expanded(){return this._expanded}};r(b,"defaultTagArray",["Building"]);class C extends p{static onParse(e){super.onParse(e),C._parseModel(e)}static _parseModel(e){var t=e.data;if(t.body&&t.body.node){var r=t.extras,s=r.modelOptions={};s.lights=!0,r.excludeNodeNames&&(s.excludeNodeNames=r.excludeNodeNames),r.inverseRotationMode&&(s.inverseRotationMode=r.inverseRotationMode);var n=e.children;if(n&&!function(e,t,r){if("Building"===e.type||"Floor"===e.type){for(var s=0;s<t.length;s++){var n=t[s];if(n.body&&n.body.node){r.excludeNodeNames="All";break}}return!0}}(t,n,s))for(var o=s.excludeNodeNames=[],i=0;i<n.length;i++){var a=n[i];a.body&&a.body.node&&o.push(a.body.node)}}}}function T(e){var t=e.modelOptions;return t||(t=e.modelOptions={}),t.useInstance=!0,t}class M extends C{static onParse(e){super.onParse(e);var t=e.data.extras,r=t.instance,s=t.instanceGroupName;if(THING.Utils.isNumber(r)){var n=e.resources.instanceCount[r];if(n>1){var o=T(t);o.id=1e3+r,o.instanceCount=n}}else(!0===r||s)&&T(t)}}class J extends M{static onParse(e){super.onParse(e),J._parseMaterial(e)}static _parseMaterial(e){var t=e.data.extras,r=t.modelOptions=t.modelOptions||{},s=t.material;if(s){r.color=s.color,r.opacity=s.opacity;var n=J.getTextureData(s.texture,e.resources);if(n){var o=r.texture=J.getTextureUrl(n,e);r.transparent=o.endsWith(".png"),r.flipY=!1}else delete s.texture;THING.Utils.isNull(r.id)&&t.instanceGroupName&&(r.id=function(e){var t=w[e];t||(w[e]=t=S++);return t}(t.instanceGroupName)),s.opacity<1&&(r.transparent=!0)}}}var w={},S=1e3;let I=class extends THING.BaseEntity{constructor(e){(super(e),this.parent.isBuilding&&!1===this.parent._constantShowStruct)&&this.brothers.forEach((e=>{e.isFloor&&(e.visible=!1)}))}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{}}onLoadComplete(){super.onLoadComplete(),i.playAnimationFromExtras(this._extrasData,this)}onLoadResource(e,t,r){var s=this._extrasData,n=this;i.setLoadModelPartialCallbacks(this,s),super.onLoadResource(e,(()=>{s.instanceGroupName&&(n.instanceGroupName=s.instanceGroupName,n.makeInstancedDrawing(!0)),t()}),r)}static parseExtrasData(e){return J.parseExtrasData(e)}};r(I,"defaultTagArray",["Facade"]);class N extends THING.BaseEntity{constructor(e){super(e),this._isOpen=i.parseBoolean(this.external.isOpen,!1),this._transformCorrection=i.parseBoolean(this.external.transformCorrection,!1),delete this.external.transformCorrection}onLoadComplete(){if(super.onLoadComplete(),this._transformCorrection){var e=this.external.dirIdx||0,t=function(e){var t=!1,r=!1,s=!1;e.animations.length&&(r=!0);var n=0;e.body.traverseNodes((e=>{"LeftPiovt"==e.name||"RightPiovt"==e.name?++n:"Controller"==e.name&&(s=!0)})),1==n&&(t=!0);return{isSingle:t,hasAnimation:r,hasController:s}}(this);if(t.isSingle||t.hasAnimation||t.hasController||(this.body.localAngles=[0,180,0]),t.isSingle?1==e?this.body.localScale=[-1,1,1]:2==e?this.body.localScale=[1,1,-1]:3==e&&(this.body.localScale=[-1,1,-1]):1==e&&(this.body.localScale=[-1,1,-1]),this._isOpen){var r=this.animationNames;-1!=r.indexOf("Auto_Open")?this.playAnimation("Auto_Open"):-1!=r.indexOf("_defaultAnim_")&&this.playAnimation({name:"_defaultAnim_",loopType:THING.LoopType.Repeat})}}}get isOpen(){return this._isOpen}}r(N,"defaultTagArray",["BuildingElement","Door"]);class E extends THING.Object3D{constructor(e){if(super(e),this._constantShowThings=!1,e){var t=e.extras||e.external;t&&(this._constantShowThings=!0===t.constantShowThings)}}showAllRoofs(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.roofs;t&&t.forEach((t=>{t.visible=e}))}showAllCeilings(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.ceilings;t&&t.forEach((t=>{t.visible=e}))}get building(){return this.parents.find("tags:or(Building)")}get corners(){return this._corners}get roofs(){return this.queryByTags("RoomRoof")}get rooms(){return this.queryByTags("Room")}get ceilings(){return this.queryByTags("RoomCeiling")}get walls(){return this.queryByTags("Wall")}get doors(){return this.queryByTags("Door")}get slabs(){return this.queryByTags("RoomFloor")}get misc(){return this.children.find("tags:or(Misc)")}get levelNumber(){return this.parent.children.indexOf(this)+1}}r(E,"defaultTagArray",["Floor"]);class P extends THING.BaseComponent{filterObjectsInLineSegments(e,t){var r=new THING.Selector;if(t&&t.length)for(var s=function(){var s=e[n],o=n+1,i=e[o>=e.length?0:o];t.forEach((e=>{var t=e.position;THING.MathUtils.pointInLineSegment([s[0],s[2]],[i[0],i[2]],[t[0],t[2]],.02)&&r.push(e)}))},n=0;n<e.length;n++)s();return r}}class R extends C{static onParse(e){super.onParse(e),R._parseTexture(e)}static _parseTexture(e){var t=e.data.extras,r=C.getTextureData(t.texture,e.resources);r&&(t.texture=C.getTextureUrl(r,e))}}class D extends R{static onParse(e){super.onParse(e),D._parseCorners(e)}static _parseCorners(e){var t=e.parentData.corners;if(t){var r=e.data.extras;O(r.corners,t);var s=r.holes;s&&s.forEach((e=>{O(e,t)}))}}}function O(e,t){if(e&&e.length&&"number"==typeof e[0])for(var r=0;r<e.length;r++)e[r]=t[e[r]]}let L=class extends THING.Object3D{onSetupTransform(e){super.onSetupTransform(e);var t=e.extras||e.external;t&&t.points&&(this._selfPoints=t.points,t.holes&&(this._selfHoles=t.holes))}showRoof(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.roof;t&&(t.visible=e)}showCeiling(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.ceiling;t&&(t.visible=e)}get points(){return this._selfPoints.map((e=>this.selfToWorld([e[0],0,e[1]])))}get slab(){return this.children.find("tags:or(RoomFloor)")}get ceiling(){return this.children.find("tags:or(RoomCeiling)")}get roof(){return this.children.find("tags:or(RoomRoof)")}get misc(){return this.children.find("tags:or(Misc)")}get area(){return i.isNull(this._area)&&(this._area=Math.abs(THING.MathUtils.getArea(this._selfPoints))),this._area}get perimeter(){for(var e=this.points,t=0,r=0;r<e.length;r++){var s=e[r],n=e[r<e.length-1?r+1:0];t+=THING.MathUtils.getDistance(s,n)}return t}get doors(){this._spatial||(this._spatial=new P,this.addComponent(this._spatial,"_internalSpatial"));var e=this.points,t=this.floor.doors;return this._spatial.filterObjectsInLineSegments(e,t)}};r(L,"defaultTagArray",["Room"]);class F{static create(e){var t=e.url,r=e.type||"Standard",s=e.angle||0,n=e.offset||[0,0],o=e.repeat||[1,1],i=e.center||[0,0],a=e.sideType||THING.SideType.Front,l=THING.Utils.parseBoolean(e.transparent,!1),h=e.callback,c=F.createImageTextureResource(t,h),u=t;s&&(u=u+"_"+s),o&&(u=u+"_"+o[0]+"_"+o[1]),a&&(u=u+"_"+a);var d=F.materialResourceMap[u];if(!d){var p=THING.MathUtils.degToRad(s),g=Math.cos(p),v=Math.sin(p),m=[o[0]*g,-o[1]*v,0,o[0]*v,o[1]*g,0,-o[0]*(g*i[0]+v*i[1])+i[0]+n[0],-o[1]*(-v*i[0]+g*i[1])+i[1]+n[1],1];F.materialResourceMap[u]=d=THING.Utils.createObject("MaterialResource",{type:r,transparent:l,side:a,map:c,uvMatrix:m})}return d}static createImageTextureResource(e,t){var r=F.imageTextureResourceMap[e];return r?THING.Utils.setTimeout((()=>{t&&t()})):(THING.Utils.loadImageFile(e,(e=>{r.setImage(e),r.setWrapS(THING.ImageWrapType.Repeat),r.setWrapT(THING.ImageWrapType.Repeat),t&&t()}),(e=>{}),(e=>{}),{extensions:THING.Utils.getCurrentApp().view.getExtensions()}),r=THING.Utils.createObject("ImageTextureResource",{textureType:"HTMLElement"}),F.imageTextureResourceMap[e]=r),r}}r(F,"loadingMap",{}),r(F,"imageMap",{}),r(F,"imageTextureResourceMap",{}),r(F,"materialResourceMap",{});var G=[];class z extends R{static onParse(e){super.onParse(e);var t=e.data.extras,r=t.instance;if(i.isNumber(r)){var s=G[r];s||(G[r]=s="__PlaneInstanceGroupName__"+r),t.instanceGroupName=s}z._parseCorners(e)}static _parseCorners(e){var t=e.data.extras,r=e.parentData;r&&(t.corners=r.corners,r.holes&&(t.holes=r.holes))}}var H=[0,0,0,1],U=[.6,.6];class j extends THING.Object3D{constructor(e){super(e)}onBeforeSetup(e){this._extrasData=e.extras||e.external||{},this._alwaysHide=i.parseValue(this._extrasData.alwaysHide,!1),e.renderableNode&&(this._extrasData.customRenderableNode=!0),super.onBeforeSetup(e)}onLoadResource(e,t,r){var s,n,o,a,l=this;if(i.parseValue(e.dynamic,!1)||this._alwaysHide||this._extrasData.customRenderableNode)t(),this.onNotifyComplete();else if(this._extrasData.modelOptions)i.loadModelPartial(this,this._extrasData,t,r);else if(e.url)t();else{var h=i.createObject("ExtrudeShape",{materialResource:(s=this._extrasData,n=s.texture,o=s.blockAngle||0,a=s.blockSize||U,F.create({type:"Standard",url:n,angle:o,repeat:[1/a[0],1/a[1]],sideType:l._getSideType(),callback:function(){l.destroyed||l.instanceGroupName==s.instanceGroupName||(l.instanceGroupName=s.instanceGroupName,l.makeInstancedDrawing(!0))}}))});h.setQuaternion(H),this.body.setNode(h),i.setTimeout((()=>{if(l._extrasData.corners){h.begin();var e=l.parent.isRoom?l.parent:l,r=i.toSelfPoints(e,l._extrasData.corners);if(h.setPoints(r),l._extrasData.holes){var s=i.toSelfHoles(e,l._extrasData.holes);h.setHoles(s)}h.end()}t()}))}}_getSideType(){return THING.SideType.Front}get alwaysHide(){return this._alwaysHide}static parseExtrasData(e){return z.parseExtrasData(e)}}var k=[2,2];class B extends j{constructor(e){super(e)}_getdefaultRepeat(){return k}}r(B,"defaultTagArray",["BuildingElement","RoomRoof"]);class A extends j{constructor(e){super(e)}_getSideType(){return THING.SideType.Back}}r(A,"defaultTagArray",["BuildingElement","RoomCeiling"]);class V extends j{constructor(e){super(e)}_getSideType(){return THING.SideType.Double}static parseExtrasData(e){var t=e.parentData;return t&&t.isGround?D.parseExtrasData(e):super.parseExtrasData(e)}}r(V,"defaultTagArray",["BuildingElement","RoomFloor"]);class W extends C{static onParse(e){super.onParse(e);var t=e.data.extras;if(!t.modelOptions){var r=t.walls;if(r&&r.length>0){var s=e.parentData.corners,n=r[0],o=i.isValid(n.model)?Y:q,a=t.aoMap,l="18091219l1g1hnjt.png";t._wallao=!0,a&&(l=a.id+"."+a.ext,t._wallao=!1),t.aoMap=e.toolkit.resolveTextureURL("81FDB96B43D441C5B3C650BFA2B76CD4.jpg"),t.aoMap2=e.toolkit.resolveTextureURL(l),r.forEach((t=>{var r=t.points,n=s[r[0]],i=s[r[1]];t.points=[n[0],n[2],i[0],i[2]],o(t,e)}))}}}}function q(e,t){Q(e,"lefttexture",t),Q(e,"righttexture",t),Q(e,"edgetexture",t)}function Q(e,t,r){var s=W.getTextureData(e[t],r.resources);s?e[t]=W.getTextureUrl(s,r):delete e[t]}function Y(e,t){var r=W.getModelData(e.model,t.resources);if(r){var s=W.getModelUrl(r,t);e.model=s,r.size&&(e.modelSize=r.size)}}let Z=class extends THING.BaseEntity{constructor(e){super(e)}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{},e.renderableNode&&(this._extrasData.customRenderableNode=!0)}onLoadResource(e,t,r){var s=i.parseValue(e.dynamic,!1),n=this._extrasData,o=this;i.setLoadModelPartialCallbacks(this,n),super.onLoadResource(e,(()=>{if(s||!n||n.customRenderableNode||n.modelOptions)t();else{o._wallExtend=o._wallExtend?o._wallExtend:new X,this._wallExtend.import(n);var e=o._wallExtend.loadParam.type;"PaintWall"==e?o._wallExtend.loadPaintWall(o,t):"PrefabWall"==e?(o.addComponent(THING.MergeComponent,"merge"),o._wallExtend.loadPrefabWall(o,t)):t()}}),r)}onDestroy(){super.onDestroy(),this._wallExtend=null}static parseExtrasData(e){return W.parseExtrasData(e)}};r(Z,"defaultTagArray",["BuildingElement","Wall"]);class X{constructor(){this.defaultPrefab="C9FB3F9A29C842F79F02CECC4037FEA1",this.app=i.getCurrentApp(),this.loadParam={},this.modelSizeMap={}}import(e){if(e){this.loadParam={};var t=e.walls;if(t&&t.length>0){var r,s=t[0],n={};null!=s.model?(r="PrefabWall",t.forEach((e=>{n[e.model]=e.model}))):(r="PaintWall",t.forEach((e=>{n[e.lefttexture]=e.lefttexture,n[e.righttexture]=e.righttexture,n[e.edgetexture]=e.edgetexture}))),this.loadParam.resourceUrlMap=n,this.loadParam.walls=t,this.loadParam.type=r,this.loadParam.aoMap=e.aoMap,this.loadParam.aoMap2=e.aoMap2,this.loadParam.pickIds=e.pickIds}}}loadPrefabWall(e,t){for(var r=this,s=this,n=this.loadParam.walls,o=this.loadParam.pickIds,i=[],a=function(){var e=n[l];if(!1!==e.visible){var t=e.model,o=e.modelSize;if(o)r.modelSizeMap[t]=o;else{var a=new Promise(((e,r)=>{s.app.resourceManager.loadModel(t,(function(r){var n=r.node.getOBB({center:THING.MathUtils.createVec3(),halfSize:THING.MathUtils.createVec3(),rotation:THING.MathUtils.createMat3()}).halfSize,o=[2*n[0],2*n[1],2*n[2]];r.node.dispose(),s.modelSizeMap[t]=o,e()}),(function(){}),r)}));i.push(a)}}},l=0;l<n.length;l++)a();Promise.all(i).then((()=>{for(var i={},a={},l=function(){var e=n[h];if(!1!==e.visible){var t=e.model,l=e.modelID,c=function(e,t,r){var n=[],o=e.points,i=e.holes,a=e.height,l=e.thickness,h=[o[0],0,o[1]],c=[o[2],0,o[3]],u=THING.MathUtils.getDistance(h,c),d=[];if(i&&i.length>0){for(var p=0;p<i.length-1;p++)for(var g=0;g<i.length-1-p;g++)if(i[g].loc[0]>i[g+1].loc[0]){var v=i[g];i[g]=i[g+1],i[g+1]=v}var m;if(i.forEach((e=>{var t,r,s=e.loc,n=e.size[0]/u,o=s[0]-n/2;m?(t=THING.MathUtils.getPointOnLine(h,c,m),r=THING.MathUtils.getPointOnLine(h,c,o)):(t=THING.MathUtils.getPointOnLine(h,c,0),r=THING.MathUtils.getPointOnLine(h,c,o)),d.push({start:t,end:r}),m=o+n})),m<1){var f=THING.MathUtils.getPointOnLine(h,c,m),y=THING.MathUtils.getPointOnLine(h,c,1);d.push({start:f,end:y})}}else d.push({start:h,end:c});for(var x=THING.MathUtils.normalizeVector(THING.MathUtils.subVector(c,h)),_=THING.MathUtils.getQuatFromUnitVectors([-1,0,0],x),b=THING.MathUtils.getEulerFromQuat(_),C=[THING.MathUtils.radToDeg(b[0]),THING.MathUtils.radToDeg(b[1]),THING.MathUtils.radToDeg(b[2])],T=THING.MathUtils.scaleVector(x.concat(),t[0]/2),M=THING.MathUtils.scaleVector(x.concat(),t[0]),J=0==a?.001:a/t[1],w=0==l?.001:l/t[2],S=0;S<d.length;S++){var I=d[S],N=THING.MathUtils.getDistance(I.start,I.end)/t[0],E=N%1;if(N=Math.floor(N),1==(N+=1)){var P=THING.MathUtils.getPointOnLine(I.start,I.end,.5);n.push({position:[P[0],0,P[2]],angles:C,scale:[E,J,w]})}else for(var R=void 0,D=void 0,O=0;O<N;O++){var L=THING.MathUtils.getPointOnLine(I.start,I.end,O),F=[L[0],0,L[2]];0==O?(R=THING.MathUtils.addVector(F,T),D=1):O==N-1?(R=THING.MathUtils.addVector(R,THING.MathUtils.scaleVector(x.concat(),t[0]/2+t[0]*E/2)),D=E):(R=THING.MathUtils.addVector(R,M),D=1),n.push({position:R.concat(),angles:C,scale:[D,J,w]})}}if(r===s.defaultPrefab&&i)for(var G=0;G<i.length;G++){var z=i[G],H=z.size,U=z.loc,j=U[1],k=THING.MathUtils.getPointOnLine(h,c,U[0]),B=H[0]/t[0];if(j>=.001){var A=a*j/t[1];n.push({position:[k[0],0,k[2]],angles:C,scale:[B,A,w]})}if(j<1){var V=(1-j)*a-H[1];if(V>0){var W=V/t[1];n.push({position:[k[0],a-V,k[2]],angles:C,scale:[B,W,w]})}}}return n}(e,r.modelSizeMap[t],l);if(o){var u=o[h],d=[];c.forEach((e=>{d.push(u)})),a[t]=a[t]?a[t].concat(d):d}i[t]=i[t]?i[t].concat(c):c}},h=0;h<n.length;h++)l();for(var c=Object.keys(i),u=[],d=0;d<c.length;d++){var p=c[d],g=i[p];u[d]=e.merge.mergeCreate({url:p,data:g,pickIds:a[p],parent:e})}Promise.all(u).then(t)}))}loadPaintWall(e,t){X.parseManager||(X.parseManager=i.createObject("ParserManager"));var r=this.loadParam.walls,s=[];r.forEach((e=>{!1!==e.visible&&s.push(e)}));var n={};n[this.loadParam.aoMap]=this.loadParam.aoMap2;var o=X.parseManager.parseWall(s,{aoMaps:n,pickIds:this.loadParam.pickIds}),a=this.loadParam.resourceUrlMap;if(a){var l=Object.values(a);l.push(this.loadParam.aoMap2),this.app.resourceManager.preloadTextures(l).then((()=>{e.destroyed||e.body.setNode(o),t()}))}else e.destroyed||(o.setStyle(e.bodyNode.getStyle()),e.bodyNode.add(o)),t()}}r(X,"parseManager",void 0);class K extends THING.BaseEntity{constructor(e){super(e)}static parseExtrasData(e){return M.parseExtrasData(e)}}r(K,"defaultTagArray",["BuildingElement","Window"]);class $ extends THING.Thing{constructor(e){super(e)}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{}}onSetupComplete(e){super.onSetupComplete(e),!1===this._extrasData.constantShowThings&&(this.visible=!1)}onLoadComplete(){super.onLoadComplete(),i.playAnimationFromExtras(this._extrasData,this)}onLoadResource(e,t,r){var s=this._extrasData;e.extras=s,i.setLoadModelPartialCallbacks(this,s),super.onLoadResource(e,t,r)}static parseExtrasData(e){return J.parseExtrasData(e)}}r($,"defaultTagArray",["Entity","Thing","Placement"]);let ee=class extends THING.Object3D{constructor(e){if(super(e),e){var t=e.extras||e.external;t&&!1===t.constantShowThings&&(this.visible=!1)}}onBeforeSetup(e){super.onBeforeSetup(e),this._extrasData=e.extras||e.external||{}}onLoadResource(e,t,r){var s=i.parseValue(e.dynamic,!1),n=this;super.onLoadResource(e,(()=>{var e=n._extrasData;!s&&e&&e.modelOptions?i.loadModelPartial(n,n._extrasData,t,r):t()}),r)}static parseExtrasData(e){return C.parseExtrasData(e)}};r(ee,"defaultTagArray",["Entity"]);let te=class extends THING.Object3D{constructor(e){super(e)}};r(te,"defaultTagArray",["Dummy"]);class re extends ${constructor(e){super(e)}}class se{static getIgnore(e,t){if(!e.level)return!1;var r=e.level.config;return!(!r||!0!==r[t])}static isGeneralObject(e){return!!e.has("Entity")||(!!e.has("Placement")||(!!e.has("Region")||(!!e.has("Line")||!!e.has("Geometry"))))}static traverseByIgnore(e,t,r){e.traverse((e=>{se.getIgnore(e,t)||r(e)}))}static compatibilityConstantShowStruct(e){return!!i.isValid(e._constantShowStruct)&&e._constantShowStruct}static compatibilityConstantShowThings(e){return!!i.isValid(e._constantShowThings)&&e._constantShowThings}static setFloorVisibleInCampusLevel(e,t,r){var s=se.compatibilityConstantShowThings(e),n=!t||r;e.setVisible(n,!1),e.children.forEach((e=>{se.traverseByIgnore(e,"ignoreVisible",(e=>{var t=e.tags;t.has("BuildingElement")?e.setVisible(n,!1):se.isGeneralObject(t)&&n?e.setVisible(s,!1):e.setVisible(!1,!1)}))}))}}var ne="ObjectSelect",oe=1;function ie(){return"__CampusLevelControl__TagName__"+ ++oe}var ae=Symbol("private");class le extends THING.BaseLevelControl{constructor(e){super(e);var t=this[ae]={};t.enableFly=!0,t.enableSkipLevel=!0,t.enableOutlineColor=!0,t.outlineColor=[1,.5019607843137255,0],t.viewpointCache=new Map,t.events=[],t.tagName=ie(),t.mouseEnterObject=null,t.cacheViewpoint=e=>{var r=e.current;if(r){var s=e.next;if(s&&s.isChildOf(r)){var n=r.app.camera;t.viewpointCache.set(r.uuid,{position:n.position,target:n.target})}}},t.getViewpointFromLevel=e=>{if(e){var t=e.level;if(t)return t.viewpoint}},t.backLevel=()=>{var e=this.app,t=e.level.current;if(!t.tags.has("Campus")){var r=t.parent;r&&e.levelManager.change(r)}},t.setOutlineColor=e=>{var t=e.object;if(t){var r=e.value;se.traverseByIgnore(t,"ignoreStyle",(e=>{(r||e.body.style.outlineColor)&&(e.body.style.outlineColor=r)}))}},t.registerFlyToEvent=e=>{var t=ie()+"_fly_tag_";return this._registerEvent(THING.EventType.MouseUp,(()=>{e.stopFlying()}),t),this._registerEvent(THING.EventType.MouseDown,(()=>{e.stopFlying()}),t),this._registerEvent(THING.EventType.Wheel,(()=>{e.stopFlying()}),t),()=>{this._unregisterEvent(THING.EventType.MouseUp,t),this._unregisterEvent(THING.EventType.MouseDown,t),this._unregisterEvent(THING.EventType.Wheel,t)}},t.processFlyParam=e=>{var r=e.current,s=r.app.camera,n=t.registerFlyToEvent(s),o={target:r,onStop:()=>{n()},onComplete:()=>{n()}},i=t.viewpointCache.get(r.uuid)||t.getViewpointFromLevel(r);return i?(o.target=i.target,o.position=i.position):t.getflyPos(o,r,s),o},t.getflyPos=(e,t,r)=>{var s=[];s.push(THING.MathUtils.getPositionByBoundingBoxAngles(t,45,45)),s.push(THING.MathUtils.getPositionByBoundingBoxAngles(t,135,45)),s.push(THING.MathUtils.getPositionByBoundingBoxAngles(t,225,45)),s.push(THING.MathUtils.getPositionByBoundingBoxAngles(t,315,45));for(var n=THING.MathUtils.getDistance(s[0],r.position),o=0,i=1;i<s.length;i++){var a=THING.MathUtils.getDistance(s[i],r.position);n>a&&(n=a,o=i)}e.target=t.boundingBox.center,e.position=s[o]}}_registerEvent(e,t,r){var s=this[ae],n=r||s.tagName;this.app.on(e,t,n),s.events.push({name:e,tag:n})}_unregisterEvent(e,t){if(e)for(var r=this[ae],s=this.app,n=r.events,o=0;o<n.length;o++){var i=n[o];if(i.name===e)return void(t?t===i.tag&&(s.off(e,t),n._removeAt(o)):(s.off(e,t),n._removeAt(o)))}}_unregisterAllEvents(){var e=this[ae],t=this.app;e.events.forEach((e=>{t.off(e.name,e.tag)}))}onEnter(e){super.onEnter(e);var t=this[ae];t.levelParam=e;var r=e.options;if(this.onSetEffect(e),!r.jumping&&(!t.enableSkipLevel||!this.onSkipLevel(e))&&(this.onRegisterEvent(e),t.enableFly)){var s=t.processFlyParam(e);return this.onFlyTo(s)}}onLeave(e){return super.onLeave(e),this[ae].cacheViewpoint(e),this.onResetEffect(e),this.onUnregisterEvent(e),Promise.resolve()}onRegisterEvent(e){var t=this[ae];this._registerEvent(ne,t.setOutlineColor,"ObjectEvent"),this._registerEvent(THING.EventType.MouseEnter,(e=>{this.onMouseEnter(e)})),this._registerEvent(THING.EventType.MouseLeave,(e=>{this.onMouseLeave(e)})),this._registerEvent(THING.EventType.DBLClick,(e=>{this.onDBLClick(e)}))}onUnregisterEvent(e){this._unregisterAllEvents()}onSetEffect(e){}onResetEffect(e){this.onMouseLeave()}filterObject(e){var t=e.parents;if(!e.parents.find("tags:or(Campus)"))return null;var r=e.app.levelManager.current;if(e.isBrotherOf(r))return i(e);var s=t.indexOf(r);if(0===s)return i(e);if(s>0)return i(t[s-1]);var n=r.parent,o=t.indexOf(n);return o>0?i(t[o-1]):null;function i(e){return e!=r?e:null}}getLevelParam(){return this.isRunning?this[ae].levelParam:null}onFlyTo(e){return new Promise(((t,r)=>{var s=e.onComplete;e.onComplete=e.onStop=()=>{s&&s(),t()},this.app.camera.flyTo(e)}))}onSkipLevel(e){var t=e.prev,r=e.path;if(!t||!r)return!1;var s=r[r.length-1];return!(!s||!t.isBrotherOf(s))}onMouseEnter(e){var t=this[ae],r=e.object;if(r&&!se.getIgnore(r,"ignoreEvent")){var s=t.mouseEnterObject=this.filterObject(r);if(s)return t.enableOutlineColor&&(r.app.trigger(ne,{object:s,value:t.outlineColor},{tag:"ObjectEvent"}),t.mouseEnterObject.on(THING.EventType.BeforeDestroy,(()=>{t.mouseEnterObject=null}),"__CampusLevelControl__Destroy__")),s}}onMouseLeave(e){var t=this[ae],r=t.mouseEnterObject;if(r)return t.enableOutlineColor&&r.app.trigger(ne,{object:r,value:null},{tag:"ObjectEvent"}),r.off(THING.EventType.BeforeDestroy,"__CampusLevelControl__Destroy__"),t.mouseEnterObject=null,r}onDBLClick(e){var t=this[ae];if(0===e.button){if(t.mouseEnterObject){var r=t.mouseEnterObject;this.onMouseLeave(),r.app.level.change(r)}}else 2===e.button&&(t.mouseEnterObject&&this.onMouseLeave(),t.backLevel())}get enableFly(){return this[ae].enableFly}set enableFly(e){this[ae].enableFly=e}get enableSkipLevel(){return this[ae].enableSkipLevel}set enableSkipLevel(e){this[ae].enableSkipLevel=e}get enableOutlineColor(){return this[ae].enableOutlineColor}set enableOutlineColor(e){this[ae].enableOutlineColor=e}get outlineColor(){return this[ae].outlineColor}set outlineColor(e){this[ae].outlineColor=e}}class he extends le{constructor(e){super(e)}onSetEffect(e){var t=e.current;t&&this.showCampus(t)}filterObject(e){return e.parents.find("tags:or(Misc,Ground)")?null:super.filterObject(e)}showCampus(e){e.children.forEach((e=>{if(e.tags.has("Building")){var t=e;t.setVisible(!0,!1);var r=t.find("tags:or(Facade,Roof)"),s=se.compatibilityConstantShowStruct(t);t.children.forEach((e=>{var t=e.tags;t.has("Floor")?se.setFloorVisibleInCampusLevel(e,r,s):t.has("Facade")||t.has("Roof")?se.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!0,!1)})):se.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)}))}))}else se.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!0,!1)}))}))}}var ce=Symbol("private");class ue extends le{constructor(e){super(e),(this[ce]={}).enableExpandFloors=!1}onEnter(e){var t=this[ce],r=super.onEnter(e),s=e.current;return t.enableExpandFloors&&s.expandFloors(),r}onLeave(e){var t=this[ce];return super.onLeave(e),new Promise((r=>{var s=e.current;t.enableExpandFloors?s.unexpandFloors({duration:1,onComplete:r}):r()}))}onSetEffect(e){var t=e.current;t&&(t.brothers.forEach((e=>{se.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)}))})),t.children.forEach((e=>{var t=e.tags;t.has("Floor")?(e.setVisible(!0,!1),se.traverseByIgnore(e,"ignoreVisible",(t=>{if(t!=e){var r=t.tags;r.has("BuildingElement")?t.setVisible(!r.has("RoomRoof"),!1):t.setVisible(!0,!1)}}))):t.has("Facade")||t.has("Roof")?se.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)})):se.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!0,!1)}))})))}get enableExpandFloors(){return this[ce].enableExpandFloors}set enableExpandFloors(e){this[ce].enableExpandFloors=e}}class de extends le{constructor(e){super(e)}onSetEffect(e){var t=e.current;t&&(se.traverseByIgnore(t,"ignoreVisible",(e=>{e.tags.has("RoomRoof")?e.setVisible(!1,!1):e.setVisible(!0,!1)})),t.brothers.forEach((e=>{se.traverseByIgnore(e,"ignoreVisible",(e=>{e.setVisible(!1,!1)}))})))}filterObject(e){return e.tags.has("Wall")||e.parents.find("tags:or(Misc,Wall)")?null:super.filterObject(e)}}var pe=Symbol("private");class ge extends le{constructor(e){super(e),(this[pe]={}).transparentObjects=[]}onSetEffect(e){var t=this[pe],r=e.current;if(r){var s=r.brothers;se.traverseByIgnore(r,"ignoreStyle",(e=>{e.body.style.opacity=null})),s.forEach((e=>{var r=e.find("tags:or(RoomFloor)");r&&se.traverseByIgnore(r,"ignoreStyle",(e=>{e.body.style.opacity=.25,t.transparentObjects.push(e)}))}))}}onResetEffect(){var e=this[pe];e.transparentObjects.forEach((e=>{e.style.opacity=null})),e.transparentObjects.length=0}filterObject(e){var t=e.tags;return e.tags.has("Wall")||(t.has("RoomFloor")||t.has("RoomCeiling")||t.has("RoomRoof"))&&e.parent==e.app.level.current||e.parents.find("tags:or(Misc,Wall)")?null:super.filterObject(e)}}var ve=Symbol("private");class me extends le{constructor(e){super(e);var t=this[ve]={};t.transparentObjects=[],t.filterBuildingElementOfIndoor=e=>{if(t.current.parents.find("tags:or(Floor)")){var r=e.tags;if(r.has("RoomFloor"))return!0;if(r.has("RoomCeiling"))return!0;if(r.has("RoomRoof"))return!0;if(r.has("Wall"))return!0}return!1}}onSetEffect(e){var t=this[ve],r=t.current=e.current;if(r){var s=r.brothers;se.traverseByIgnore(r,"ignoreStyle",(e=>{e.body.style.opacity=null})),s.forEach((e=>{se.traverseByIgnore(e,"ignoreStyle",(e=>{se.isGeneralObject(e.tags)&&(e.destroyed||(e.body.style.opacity=.25,t.transparentObjects.push(e)))}))}))}}onResetEffect(){var e=this[ve];e.transparentObjects.forEach((e=>{se.traverseByIgnore(e,"ignoreStyle",(e=>{e.destroyed||(e.body.style.opacity=null)}))})),e.transparentObjects.length=0}filterObject(e){var t=this[ve];return e.parents.find("tags:or(Misc,Ground)")||t.filterBuildingElementOfIndoor(e)?null:super.filterObject(e)}}var fe=Symbol("private");class ye extends THING.Component{constructor(e){super(e);var t=this[fe]={};t.data=null,t.dataType=null,t.pickIds=null,t.models=null,t.textures=null,t.aoMap=null,t.aoMap2=null,t.setData=(e,r)=>{e&&(t.toolkit=r,t.data=e,t.dataType=e.type,t.pickIds=e.pickIds,t.walls=e.walls,t.models=t.data.models,t.textures=t.data.textures,t.aoMap=t.data.aoMap||t._resolveTextureURL("81FDB96B43D441C5B3C650BFA2B76CD4.jpg"),t.aoMap2=t.data.aoMap2||t._resolveTextureURL("18091219l1g1hnjt.png"),t._wallao=i.parseBoolean(t.data._wallao,!0))},t.getData=()=>{var e={type:t.dataType};if(t.pickIds&&(e.pickIds=t.pickIds),"ModelWall"===t.dataType)t.models&&(e.models=t.models);else{var r=[];t.walls.forEach((n=>{s(n,"lefttexture",r),s(n,"righttexture",r),s(n,"edgetexture",r),t.textures&&(e.textures=t.textures),t.aoMap&&(e.aoMap=t.aoMap),t.aoMap2&&(e.aoMap2=t.aoMap2),t._wallao&&(e._wallao=t._wallao)}))}return t.walls&&(e.walls=t.walls),e;function s(e,t,r){var s=r.indexOf(e[t]);-1==s&&(s=r.push(e[t])-1),e[t]=s}},t.load=e=>"ModelWall"===t.dataType?t._loadModelWall(e):"TextureWall"===t.dataType?t._loadTextureWall(e):Promise.resolve(),t._resolveModelURL=e=>{if(!t.toolkit)return e;var r=t.toolkit.pathResolver;return r?r.resolveModelURL(e):t.toolkit.resolveModelURL?t.toolkit.resolveModelURL(e):e},t._resolveTextureURL=e=>{if(!t.toolkit)return e;var r=t.toolkit.pathResolver;return r?r.resolveTextureURL(e):t.toolkit.resolveTextureURL?t.toolkit.resolveTextureURL(e):e},t._getParserManager=()=>(t._parserManager||(t._parserManager=i.createObject("ParserManager")),t._parserManager),t._loadTextureWall=e=>{var r=this.app,s=[];t.walls.forEach((e=>{!1!==e.visible&&s.push(e),e.lefttexture=t.textures[e.lefttexture],e.righttexture=t.textures[e.righttexture],e.edgetexture=t.textures[e.edgetexture]}));var n={};n[t.aoMap]=t.aoMap2;var o={aoMaps:n,pickIds:t.pickIds,_wallao:t._wallao};return new Promise(((n,i)=>{if(t.textures){for(var a=[],l=0;l<t.textures.length;l++){var h=t.textures[l];a[l]=t._resolveTextureURL(h)}a.push(t.aoMap2),r.resourceManager.preloadTextures(a).then((()=>{t._loadTextureWallNode(e,s,o,n)}),i)}else t._loadTextureWallNode(e,s,o,n)}))},t._loadTextureWallNode=(e,r,s,n)=>{if(!e.destroyed){var o=t._getParserManager().parseWall(r,s);e.body.setNode(o),n()}},t._loadModelWall=e=>{for(var r=t.walls,s={},n={},o=function(){var e=r[i];if(!1===e.visible)return"continue";var o=t.models[e.model],a=o.url,l=t._resolveModelURL(a),h=t._generateModelWallTransfrom(e,o.size);if(t.pickIds){var c=t.pickIds[i],u=[];h.forEach((e=>{u.push(c)})),n[l]=n[l]?n[l].concat(u):u}s[l]=s[l]?s[l].concat(h):h},i=0;i<r.length;i++)o();for(var a=Object.keys(s),l=[],h=0;h<a.length;h++){var c=a[h],u=s[c];l[h]=t._mergeCreate(c,u,n[c],e)}return Promise.all(l)},t._generateModelWallTransfrom=(e,r)=>{for(var s=[],n=e.points,o=[n[0],0,n[1]+a()],l=[n[2]+a(),0,n[3]],h=e.holes,c=e.height,u=e.thickness,d=t._generateLines(o,l,h),p=THING.MathUtils.normalizeVector(THING.MathUtils.subVector(l,o)),g=THING.MathUtils.getQuatFromUnitVectors([-1,0,0],p),v=THING.MathUtils.getEulerFromQuat(g),m=[THING.MathUtils.radToDeg(v[0]),THING.MathUtils.radToDeg(v[1]),THING.MathUtils.radToDeg(v[2])],f=THING.MathUtils.scaleVector(p.concat(),r[0]/2),y=THING.MathUtils.scaleVector(p.concat(),r[0]),x=0==c?.001:c/r[1],_=0==u?.001:u/r[2],b=0;b<d.length;b++){var C=d[b],T=THING.MathUtils.getDistance(C.start,C.end)/r[0],M=T%1;if(T=Math.floor(T),1==(T+=1)){var J=THING.MathUtils.getPointOnLine(C.start,C.end,.5),w=THING.MathUtils.createMat4([J[0],0,J[2]],m,[M,x,_]);s.push(w)}else for(var S=void 0,I=void 0,N=0;N<T;N++){var E=THING.MathUtils.getPointOnLine(C.start,C.end,N),P=[E[0],0,E[2]];0==N?(S=THING.MathUtils.addVector(P,f),I=1):N==T-1?(S=THING.MathUtils.addVector(S,THING.MathUtils.scaleVector(p.concat(),r[0]/2+r[0]*M/2)),I=M):(S=THING.MathUtils.addVector(S,y),I=1);var R=THING.MathUtils.createMat4([S[0],0,S[2]],m,[I,x,_]);s.push(R)}}if(i.parseBoolean(e.fillHole,!1)&&h)for(var D=0;D<h.length;D++){var O=h[D],L=O.size,F=O.loc,G=F[1],z=THING.MathUtils.getPointOnLine(o,l,F[0]),H=L[0]/r[0];if(G>=.001){var U=c*G/r[1],j=THING.MathUtils.createMat4([z[0],0,z[2]],m,[H,U,_]);s.push(j)}if(G<1){var k=(1-G)*c-L[1];if(k>0){var B=k/r[1],A=THING.MathUtils.createMat4([z[0],c-k,z[2]],m,[H,B,_]);s.push(A)}}}return s},t._generateLines=(e,t,r)=>{var s=[],n=THING.MathUtils.getDistance(e,t);if(r&&r.length>0){for(var o=0;o<r.length-1;o++)for(var i=0;i<r.length-1-o;i++)if(r[i].loc[0]>r[i+1].loc[0]){var a=r[i];r[i]=r[i+1],r[i+1]=a}var l=null;r.forEach((r=>{var o,i,a=r.loc,h=r.size[0]/n,c=a[0]-h/2;l?(o=THING.MathUtils.getPointOnLine(e,t,l),i=THING.MathUtils.getPointOnLine(e,t,c)):(o=THING.MathUtils.getPointOnLine(e,t,0),i=THING.MathUtils.getPointOnLine(e,t,c)),s.push({start:o,end:i}),l=c+h})),l<1&&s.push({start:THING.MathUtils.getPointOnLine(e,t,l),end:THING.MathUtils.getPointOnLine(e,t,1)})}else s.push({start:e,end:t});return s},t._mergeCreate=(e,t,r,s)=>new Promise((function(n,o){t&&t.length&&s.app.resourceManager.loadModel(e,(e=>{s.destroyed||s.bodyNode.add(e.node),n()}),void 0,(e=>{o(e),console.error(e)}),{matrices:t,lights:!0,pickIds:r})}))}onImport(e,t){e&&this[fe].setData(e,t)}onExport(){return this[fe].getData()}onLoadResource(){this[fe].load(this.object)}}i.registerClass("WallComponent",ye);var xe=Symbol("private"),_e=[0,0],be=[1,1],Ce={textureType:"HTMLElement"};class Te extends THING.BaseResolver{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e);var t=this[xe]={},r=e.data;t.styles=r&&r.styles||[],t.textureResourceMap={},t.materialResourceMap={},t.stylesMap={},t.spliceUniqueKey=function(e){var t=e.map,r=e.uv;return e.transparent&&(t+="_"+e.transparent),e.sideType&&(t+="_"+e.sideType),e._floorao&&(t+="_"+e._floorao),e.color&&(t+="_"+e.color),r&&(r.angle&&(t+="_"+r.angle),r.repeat&&(t+="_"+r.repeat[0]+"_"+r.repeat[1]),r.center&&(t+="_"+r.center[0]+"_"+r.center[1]),r.offset&&(t+="_"+r.offset[0]+"_"+r.offset[1])),t},t.getUvMatrix=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.angle||0,r=e.center||_e,s=e.repeat||be,n=e.offset||_e,o=THING.MathUtils.degToRad(t),i=Math.cos(o),l=Math.sin(o);return[s[0]*i,-s[1]*l,0,s[0]*l,s[1]*i,0,-s[0]*(i*r[0]+l*r[1])+r[0]+n[0]+a(),-s[1]*(-l*r[0]+i*r[1])+r[1]+n[1],1]},t.createMaterialResource=function(e,r,s){var n=t.spliceUniqueKey(e),o=t.materialResourceMap[n];if(o)r&&setTimeout((()=>{r()}),1);else{var a=t.createImageTextureResource(e.map,r,s),l=t.getUvMatrix(e.uv);o=i.createObject("MaterialResource",{type:"Standard",map:a,color:e.color,transparent:i.parseBoolean(e.transparent,!1),side:e.sideType||THING.SideType.Front,uvMatrix:l,_floorao:i.parseBoolean(e._floorao,!1)}),t.materialResourceMap[n]=o}return o},t.createImageTextureResource=function(e,r,s){var n=t.textureResourceMap[e];if(n)return i.setTimeout((()=>{r&&r(n)})),n;n=i.createObject("ImageTextureResource",Ce);var o=i.getCurrentApp().loadImageTexture(e);return o.waitForComplete().then((()=>{n.setImage(o.resource),n.setWrapS(THING.ImageWrapType.Repeat),n.setWrapT(THING.ImageWrapType.Repeat),r&&r(n)}),(e=>{s&&s(e)})),t.textureResourceMap[e]=n,n},t.addData=function(e){var r=t.spliceUniqueKey(e),s=t.stylesMap[r];return i.isNull(s)&&(s=t.styles.push(e)-1,t.stylesMap[r]=s),s}}getData(){return{styles:this[xe].styles}}getMaterialResourceDataByIndex(e){return this[xe].styles[e]}createMaterialResource(e,t,r){return this[xe].createMaterialResource(e,t,r)}setMaterialResourceData(e){return this[xe].addData(e)}}var Me=Symbol("private");class Je extends THING.Component{constructor(e){super(e);var t=this[Me]={};t.materialResourceResolver=null,t.materialResourceData=null}onImport(e,t){if(e){var r=this[Me];r.materialResourceResolver||(r.materialResourceResolver=t.getResolver("MaterialResourceResolver")),r.materialResourceData=e.materialResource,r.materialResourceResolver&&i.isNumber(e.materialResource)&&(r.materialResourceData=r.materialResourceResolver.getMaterialResourceDataByIndex(e.materialResource))}}onExport(e){var t=this[Me],r=e.getResolver("MaterialResourceResolver");return r||(r=new Te,e.registerResolver("MaterialResourceResolver",r)),{materialResource:r.setMaterialResourceData(t.materialResourceData)}}loadMaterialResource(e,t){var r=this[Me];return r.materialResourceData?r.materialResourceResolver.createMaterialResource(r.materialResourceData,(()=>{e&&e()}),(()=>{t&&t()})):(e(),null)}}var we=Symbol("private"),Se=[0,0,0,1],Ie={};class Ne extends Je{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ie;super(e);var t=this[we]={dynamic:e.dynamic,points:null,holes:null};Se[1]=a(),t.setData=e=>{t.alwaysHide=e.alwaysHide;var r=this.object.parent.external;t.selfPoints=e.points,!t.selfPoints&&r&&(t.selfPoints=r.points),t.selfHoles=e.holes,!t.selfHoles&&r&&(t.selfHoles=r.holes),t.instanceGroupName=e.instanceGroupName},t.getData=e=>{!0===t.alwaysHide&&(e.alwaysHide=t.alwaysHide);var r=this.object.parent.external;return r&&r.points||(t.selfPoints&&(e.points=t.selfPoints),t.selfHoles&&(e.holes=t.selfHoles)),e},t.create=function(e,r){var s=i.createObject("ExtrudeShape",{materialResource:r});s.setQuaternion(Se),e.body.setNode(s),s.begin(),s.setPoints(JSON.parse(JSON.stringify(this.selfPoints))),this.selfHoles&&s.setHoles(JSON.parse(JSON.stringify(this.selfHoles))),s.end(),t.instanceGroupName&&(e.instanceGroupName=t.instanceGroupName,e.makeInstancedDrawing(!0))}}onImport(e,t){super.onImport(e,t),this[we].setData(e)}onExport(e){var t=super.onExport(e);return this[we].getData(t),t}onLoadResource(){var e=this[we];return new Promise(((t,r)=>{if(e.alwaysHide)t();else var s=this.loadMaterialResource((()=>{e.create(this.object,s),t()}),r)}))}}i.registerClass("PlaneComponent",Ne);class Ee{convert(e){this._data=e,this.onConvertTags(),this.onConvertModelResource();var t=e.extras||e.external;return t&&this.onConvertExternal(t),e}onConvertTags(){var e=i.getRegisteredClass(this.constructor.type).defaultTagArray,t=this._data.tags;t||(t=this._data.tags=[]);for(var r=0;r<e.length;r++){var s=e[r];-1===t.indexOf(s)&&t.push(s)}}onConvertModelResource(){var e=this._data.url,t=this._data.nodeName;e&&t&&(this._data.isModelResource=!0)}onConvertExternal(e){}addComponentData(e){var t=this._data.components;t||(t=this._data.components=[]),e.classType=i.getRegisteredClass(e.type),t.push(e)}}class Pe extends Ee{convert(e){return super.convert(e),e.external=e.extras=null,e}onConvertExternal(e){var t=e.walls;if(t&&t.length){var r=null,s=t[0];(r=THING.Utils.isValid(s.model)?this._convertModelWallData(t):this._convertTextureWallData(t)).pickIds=e.pickIds,r.aoMap=e.aoMap,r.aoMap2=e.aoMap2,r._wallao=e._wallao;var n={type:"WallComponent",name:"wallComponent",external:r};this.addComponentData(n)}}_convertModelWallData(e){var t=[],r=[],s=[];return e.forEach((e=>{var n=this._addUrlToArray(e.model,r);s[n]={url:e.model,size:e.modelSize},e.model=n,t.push(e)})),{type:"ModelWall",models:s,walls:t}}_convertTextureWallData(e){var t=[],r=[];return e.forEach((e=>{e.lefttexture=this._addUrlToArray(e.lefttexture,r),e.righttexture=this._addUrlToArray(e.righttexture,r),e.edgetexture=this._addUrlToArray(e.edgetexture,r),t.push(e)})),{type:"TextureWall",textures:r,walls:t}}_addUrlToArray(e,t){for(var r=0;r<t.length;r++){if(e===t[r])return r}return t.push(e)-1}}r(Pe,"type","Wall"),r(Pe,"convertType","Object3D");class Re extends Ee{onConvertModelResource(){this._data.url&&(this._data.isModelResource=!0)}onConvertExternal(e){this._converModelOptions(e)}_converModelOptions(e){var t=e.modelOptions;if(t&&t.useInstance){delete t.useInstance,e.instanceGroupName?(this._data.__convertInstanceGroupName__=e.instanceGroupName,delete e.instanceGroupName):t.id&&(this._data.__convertInstanceGroupName__=t.id+"__convert_instance_group_name__",delete t.id);var r=this._data.onComplete||this._data.complete;this._data.complete=this._data.onComplete=e=>{var t=e.object;t&&(t.options.__convertInstanceGroupName__&&(t.instanceGroupName=t.options.__convertInstanceGroupName__),t.makeInstancedDrawing(!0)),r&&r(e)}}}}r(Re,"type","Thing"),r(Re,"convertType","Entity");class De extends Re{}r(De,"type","Facade"),r(De,"convertType","Entity");class Oe extends Ee{}r(Oe,"type","Ground"),r(Oe,"convertType","Object3D");class Le extends Ee{}r(Le,"type","EmptyObject"),r(Le,"convertType","Object3D");class Fe extends Ee{}r(Fe,"type","Group"),r(Fe,"convertType","Object3D");class Ge extends Ee{}r(Ge,"type","Misc"),r(Ge,"convertType","Object3D");var ze={Wall:Pe,Thing:Re,Facade:De,Ground:Oe,EmptyObject:Le,Group:Fe,Misc:Ge},He=null,Ue=null,je={MaterialResourceResolver:new Te};class ke{static processToolkit(e){e.getResolver=e=>je[e],ke.tempObject=new THING.Object3D}static processClassType(e,t){var r=e.type,s=ze[r];if(s){He=r,Ue=i.getRegisteredClasses()[r];var n=null;return t&&(n=t(e)),n||(n=i.getRegisteredClass(s.convertType)),Ue.parseExtrasData&&n!=Ue&&(n.parseExtrasData=e=>{if(Ue.parseExtrasData){var t=Ue.parseExtrasData(e);return n.parseExtrasData=null,t}return e.extras}),n}return t?t(e):null}static processCreateOptions(e,t,r){if(!He)return r;var s=ze[He],n=r;s&&(n=(new s).convert(r));return He=null,Ue=null,n}static clear(){ke.tempObject&&(ke.tempObject.destroy(),ke.tempObject=null)}}class Be extends THING.SceneBundleLoader{onLoad(e,t){this.onCompatibleTSF(t),super.onLoad(e,t)}onLoadComplete(e,t,r){this.onClearCompatibleTSF();var s=r.app,n=r.children.query(".Campus"),o=n.length?n[0]:null;0!==n.length&&(i.parseValue(t.dynamic,!1)&&n.forEach((e=>{e.onNotifyComplete()})));e.campus=o,e.campuses=n,r.children.forEach((e=>{0==t.active&&(e.active=!1),s.root.add(e)})),n.forEach((t=>{t.on(THING.EventType.AfterDestroy,(t=>{var r=t.target,s=e.campuses.indexOf(r);e.campuses.splice(s,1)}))}));var a={bundle:e};a.campuses=n,o&&(a.campus=o),s.trigger(THING.EventType.Load,a)}onCompatibleTSF(e){var t=a(),r=e.onGetClassType;e.onGetClassType=e=>ke.processClassType(e,r);var s=e.onUpdateCreateOptions;e.onUpdateCreateOptions=(e,r,n)=>{var o=null;if(s&&(o=s(e,r,n)),o=ke.processCreateOptions(e,r,o||n),t){var a=i.parseValue(o.localQuaternion,[0,0,0,1]);o.localQuaternion=[a[0],a[1]+t,a[2],a[3]]}return o},e.onAddToolkit=e=>{e&&ke.processToolkit(e)}}onClearCompatibleTSF(){ke.clear()}}var Ae={campus:"tags:or(Campus)",building:"tags:or(Building)",floor:"tags:or(Floor)",room:"tags:or(Room)",placement:"tags:or(Placement,Entity,Line,Geometry,Region,Window,Door)"},Ve={campus:"_Campus_Level_Control_Inside_",building:"_Building_Level_Control_Inside_",floor:"_Floor_Level_Control_Inside_",room:"_Room_Level_Control_Inside_",placement:"_Placement_Level_Control_Inside_"};var We=THING.StringEncoder.toText("147,136,32,42,117,54,39,76,214,237,120,180,47"),qe=THING.StringEncoder.toText("186,156,39"),Qe=THING.StringEncoder.toText("183,133,36,48,115,33,42");THING.App.addCompleteCallback((e=>{e.on("__!!a$u^t@h*event@__",(t=>{if(t.hasExpired){s=THING.MathUtils.randomFloat(.1,1),o=s,new THING.Label({fontText:We+" "+qe+" "+Qe,fontSize:20,renderType:THING.RenderType.Sprite,style:{color:[1,0,0]},scale:[.4,.4,.4]});var r=e.camera;r.position=[0,10,0],r.target=[0,0,0],r.enable=!1}var s})),e.trigger("__a)s*k&!!a$u^t@h*event@__");var t=e.resourcePool.onLoadModelScene;e.resourcePool.onLoadModelScene=function(r){var s=r.onComplete;r.onComplete=e=>{var t=e.objects;if(t){for(var r=[],n=0;n<t.length;n++){var o=t[n];o&&o.isCampus&&r.push(o)}e.campuses=r,e.campus=r[0]||null,s&&s(e)}else s&&s(e)},t.call(e.resourcePool,r)},e.registerBundleLoader("scene",new Be),function(e){var t=e.level,r={campus:null,building:null,floor:null,room:null,placement:null},s=new Proxy(r,{get:(e,t,r)=>e[t],set:(e,r,s)=>{var n=e[r];n&&t.unregisterByControl(n);var o=Ae[r],i=Ve[r];return t.register(o,s,{tag:i,priority:0}),e[r]=s,!0}});t.controls=s,t.controls.campus=new he,t.controls.building=new ue,t.controls.floor=new de,t.controls.room=new ge,t.controls.placement=new me,t.setControlOption=(e,t)=>{for(var s in r)r[s][e]=t}}(e)}),-2);var Ye=Object.freeze({__proto__:null,Building:b,BuildingLevelControl:ue,Campus:d,CampusBundleLoader:Be,CampusLevelControl:he,Ceiling:A,DefaultLevelControl:le,Door:N,EmptyObject:te,Facade:I,Floor:E,FloorLevelControl:de,Ground:v,Group:ee,LevelControlOptions:{EnableFly:"enableFly",EnableSkipLevel:"enableSkipLevel",EnableOutlineColor:"enableOutlineColor",OutlineColor:"outlineColor"},Misc:g,PlacementLevelControl:me,PlaneComponent:Ne,Roof:B,Room:L,RoomLevelControl:ge,Slab:V,Thing:$,VideoProbe:re,Wall:Z,WallComponent:ye,Window:K});THING.Utils.registerClasses(Ye,THING),THING.Utils.registerClass("MaterialResourceResolver",Te);void 0!==d&&(d.className="Campus"),void 0!==p&&(p.className="BaseParser"),void 0!==g&&(g.className="Misc"),void 0!==v&&(v.className="Ground"),void 0!==_&&(_.className="ExpandObjectsComponent"),void 0!==b&&(b.className="Building"),void 0!==C&&(C.className="PartialModelParser"),void 0!==M&&(M.className="InstanceParser"),void 0!==J&&(J.className="MaterialParser"),void 0!==I&&(I.className="Facade"),void 0!==N&&(N.className="Door"),void 0!==E&&(E.className="Floor"),void 0!==P&&(P.className="SpaceComponent"),void 0!==R&&(R.className="PlaneTextureParser"),void 0!==D&&(D.className="RoomParse"),void 0!==L&&(L.className="Room"),void 0!==F&&(F.className="MaterialResourceManager"),void 0!==z&&(z.className="PlaneParser"),void 0!==j&&(j.className="BasePlane"),void 0!==B&&(B.className="Roof"),void 0!==A&&(A.className="Ceiling"),void 0!==V&&(V.className="Slab"),void 0!==W&&(W.className="WallParser"),void 0!==Z&&(Z.className="Wall"),void 0!==X&&(X.className="WallExtend"),void 0!==K&&(K.className="Window"),void 0!==ee&&(ee.className="Group"),void 0!==te&&(te.className="EmptyObject"),void 0!==re&&(re.className="VideoProbe"),void 0!==le&&(le.className="DefaultLevelControl"),void 0!==he&&(he.className="CampusLevelControl"),void 0!==ue&&(ue.className="BuildingLevelControl"),void 0!==de&&(de.className="FloorLevelControl"),void 0!==ge&&(ge.className="RoomLevelControl"),void 0!==me&&(me.className="PlacementLevelControl"),void 0!==ye&&(ye.className="WallComponent"),void 0!==Te&&(Te.className="MaterialResourceResolver"),void 0!==Je&&(Je.className="MaterialResourceComponent"),void 0!==Ne&&(Ne.className="PlaneComponent"),void 0!==Ee&&(Ee.className="BaseConvertor"),void 0!==Pe&&(Pe.className="WallConvertor"),void 0!==Re&&(Re.className="ThingConvert"),void 0!==De&&(De.className="FacadeConvert"),void 0!==Oe&&(Oe.className="GroundConvert"),void 0!==Le&&(Le.className="EmptyObjectConvert"),void 0!==Fe&&(Fe.className="GroupConvert"),void 0!==Ge&&(Ge.className="MiscConvert"),void 0!==ke&&(ke.className="CompatibilitySceneBundle"),void 0!==Be&&(Be.className="CampusBundleLoader");var Ze=Object.freeze({__proto__:null,Building:b,BuildingLevelControl:ue,COMPILETIME:"Fri, 01 Sep 2023 05:18:38 GMT",Campus:d,CampusBundleLoader:Be,CampusLevelControl:he,Ceiling:A,DefaultLevelControl:le,Door:N,EmptyObject:te,Facade:I,Floor:E,FloorLevelControl:de,Ground:v,Group:ee,Misc:g,PlacementLevelControl:me,PlaneComponent:Ne,Roof:B,Room:L,RoomLevelControl:ge,Slab:V,Thing:$,VERSION:"1.0.304",VideoProbe:re,Wall:Z,WallComponent:ye,Window:K}),Xe=["Entity","Facade","Placement","RoomFloor","RoomRoof","RoomCeiling","BuildingElement","Ground","Dummy"],Ke=0,$e=1,et=2,tt="https://model.3dmomoda.com/models/",rt="https://static.3dmomoda.com/textures/",st="FacadeMain",nt="Ground",ot="Thing",it="Tree",at="Objects",lt="FloorFloor",ht="FloorRoof",ct="FloorCeiling",ut="FloorManualWall",dt="Door",pt={BC4ACD398A9640859A6B386E1BF9231D:{id:"BC4ACD398A9640859A6B386E1BF9231D",type:"Wall",size:[.8,2.999,.8],version:"5"},"25DFE916055244849463F89A03DA97CD":{id:"25DFE916055244849463F89A03DA97CD",type:"Wall",size:[.845,3.099,.849],version:"5"}},gt={"3629A959F80C4D0EA31D1E26524735B8":{id:"3629A959F80C4D0EA31D1E26524735B8",type:"Placement",size:[8.1,9.60776,8.7],version:"7"},BB23ED379CFB4A0AB14BD124EC2995BE:{id:"BB23ED379CFB4A0AB14BD124EC2995BE",type:"Placement",size:[.64347,1.34912,.8],version:"7"},A7D96546FA744C38A949DFC6FEE43B6A:{id:"A7D96546FA744C38A949DFC6FEE43B6A",type:"Placement",size:[.6,1.1,.6],version:"7"},FA5766D2AA074128ABB5D4CA3FF45B36:{id:"FA5766D2AA074128ABB5D4CA3FF45B36",type:"Placement",size:[.4,.61599,.39999],version:"6"},"8EC4FF7178E64C538B215D69684E4F92":{id:"8EC4FF7178E64C538B215D69684E4F92",type:"Placement",size:[.4,.5,.4],version:"6"},"449c02c5e8f84a2aa32f58ed53aa24b9":{id:"449c02c5e8f84a2aa32f58ed53aa24b9",type:"Placement",size:[.23118,.5986,.24155],version:"1"},c26acc8a9f804d8da2f49aba46283ac3:{id:"c26acc8a9f804d8da2f49aba46283ac3",type:"Placement",size:[7.85544,7.80654,7.44832],version:"2"},"07b2d180e1ea42de98723fe147f6750a":{id:"07b2d180e1ea42de98723fe147f6750a",type:"Placement",size:[10.3207,9.84333,10.0598],version:"3"},"2c969242db5f4da58442182ccbda7471":{id:"2c969242db5f4da58442182ccbda7471",type:"Placement",size:[7.20139,25.1363,6.56474],version:"4"},D26DB25C34C94CAABF24FED40F1A9719:{id:"D26DB25C34C94CAABF24FED40F1A9719",type:"Placement",size:[8.24071,19.2,7.6],version:"6"},"ebafecf0-cc89-42dc-b847-0f841a31bdca":{id:"ebafecf0-cc89-42dc-b847-0f841a31bdca",type:"Placement",size:[4.94077,5.83847,4.78861],version:"9"},"4EF86FC4FFA44013AC4F45E8CD0D343F":{id:"4EF86FC4FFA44013AC4F45E8CD0D343F",type:"Placement",size:[5.66699,7.4,6.233],version:"6"},"9C27FD900C4443FBA1151C9DF767D19A":{id:"9C27FD900C4443FBA1151C9DF767D19A",type:"Placement",size:[7.50716,8.2,7.87936],version:"6"},"6b768c2d-3c2f-4954-a625-ef4b57f72a47":{id:"6b768c2d-3c2f-4954-a625-ef4b57f72a47",type:"Placement",size:[6.32989,7.49752,5.72546],version:"8"},"9fc66d5b-a213-4fc6-9fc6-f759aa88716a":{id:"9fc66d5b-a213-4fc6-9fc6-f759aa88716a",type:"Placement",size:[4.5,9.4,4.4],version:"4"},"963de658-70b6-49e7-bb0e-504ad603fe27":{id:"963de658-70b6-49e7-bb0e-504ad603fe27",type:"Placement",size:[1.4073,4.03187,1.37224],version:"5"},"d5b06cf7-2a31-4252-8d7c-02d48815ed18":{id:"d5b06cf7-2a31-4252-8d7c-02d48815ed18",type:"Placement",size:[7.3,7.4,6.1],version:"4"},"f9058709-ee84-41f6-8260-fbb734dc9483":{id:"f9058709-ee84-41f6-8260-fbb734dc9483",type:"Placement",size:[4.3,7.2,4],version:"4"},"be7d0bfc-ce60-4132-8a88-afd1301c82b3":{id:"be7d0bfc-ce60-4132-8a88-afd1301c82b3",type:"Placement",size:[4.41539,7.57112,4.49063],version:"5"},"95bd04fe237f42e0adeabb78028c8ee7":{id:"95bd04fe237f42e0adeabb78028c8ee7",type:"Placement",size:[4.41539,7.57112,4.49063],version:"1"},"1d2827ffd12b4ac1a2035fa81646a450":{id:"1d2827ffd12b4ac1a2035fa81646a450",type:"Placement",size:[12.63521,15.81749,13.21056],version:"3"}};function vt(e,t,r,s,n,o,i){try{var a=e[o](i),l=a.value}catch(e){return void r(e)}a.done?t(l):Promise.resolve(l).then(s,n)}function mt(e){return function(){var t=this,r=arguments;return new Promise((function(s,n){var o=e.apply(t,r);function i(e){vt(o,s,n,i,a,"next",e)}function a(e){vt(o,s,n,i,a,"throw",e)}i(void 0)}))}}function ft(e){return ft="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ft(e)}function yt(e){var t=function(e,t){if("object"!==ft(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var s=r.call(e,t||"default");if("object"!==ft(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===ft(t)?t:String(t)}function xt(e,t,r){return(t=yt(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class _t{constructor(e){if(this._mode=3,this._bigVersion=null,this._smallVersion=null,this._version=e,e)if(isNaN(e)){var t=e.split(".");this._mode=parseInt(t[0]),t[1]&&(this._bigVersion=parseInt(t[1])),t[2]&&(this._smallVersion=parseInt(t[2]))}else this._mode=e}get versionText(){return this._version}get mode(){return this._mode}get bigVersion(){return this._bigVersion}get smallVersion(){return this._smallVersion}}class bt extends THING.Utils{static vec3ApplyQuat(e,t,r){var s=e[0],n=e[1],o=e[2],i=t[0],a=t[1],l=t[2],h=t[3],c=h*s+a*o-l*n,u=h*n+l*s-i*o,d=h*o+i*n-a*s,p=-i*s-a*n-l*o;return void 0===r&&(r=[0,0,0]),r[0]=c*h+p*-i+u*-l-d*-a,r[1]=u*h+p*-a+d*-i-c*-l,r[2]=d*h+p*-l+c*-a-u*-i,r}static multiplyQuat(e,t){var r=e[0],s=e[1],n=e[2],o=e[3],i=t[0],a=t[1],l=t[2],h=t[3];return[r*h+o*i+s*l-n*a,s*h+o*a+n*i-r*l,n*h+o*l+r*a-s*i,o*h-r*i-s*a-n*l]}static saveDecimal(e,t){if("number"==typeof e)return o(e,t);if(e.length>0){for(var r=[],s=0;s<e.length;s++){var n=o(e[s],t);r.push(n)}return r}return e;function o(e,t){t=null==t?3:t;for(var r=1;t>0;r*=10,t--);for(;t<0;r/=10,t++);return Math.round(e*r)/r}}static floatEquals(e,t,r){if(void 0===e||void 0===t)return!1;if(void 0!==r&&0!=r||(r=.002),"number"==typeof e&&"number"==typeof t)return Math.abs(e-t)<=r;if(e.length>0&&t.length>0&&e.length==t.length){for(var s=0;s<e.length;s++){var n=e[s],o=t[s];if(Math.abs(n-o)>r)return!1}return!0}return!1}static parseModel(e,t,r,s){e.loadversion&&(t=new _t(e.loadversion));var n=1===t.bigVersion?$e:et;e.localurl||(n=Ke);var o=null;switch(n){case $e:o="https://www.thingjs.com/"+e.localurl;break;case et:switch(s.bundleInfo={main:"index.json",type:"model"},o=r+e.localurl,delete e.version,delete e.resourceType,delete e.hasanimation,e.applyTransposeToMesh=!1,e.applyTransposeToVertices=!1,t.smallVersion){case 3:case 4:case 5:!0!==e.keeprootrotation&&(e.applyTransposeToMesh=!0);break;case 6:!0!==e.keeprootrotation&&(e.applyTransposeToVertices=!0)}delete e.keeprootrotation;break;default:o=e.id}e.url=o,delete e.id,delete e.localurl}static parseTexture(e,t){return{url:e.id+"."+e.ext,flipY:t||!1}}static versionControl(e,t){switch(e.bigVersion+"_"+e.smallVersion){case"0_0":case"0_1":case"1_0":case"1_1":return null}return jt.getIdOnesPlaceNumber(t)}static getParseCorners(e,t,r,s){var n=bt.versionControl(s,r);if(t.corners&&t.corners[0][2]){e.corners=JSON.parse(JSON.stringify(t.corners));for(var o=0;o<e.corners.length;o++)e.corners[o][2]*=-1,n&&jt.decodeArray(0,e.corners[o],n,3)}}static getParseTransform(e,t,r,s){var n=bt.versionControl(s,r);t.position&&(e.realPosition=[t.position[0],t.position[1],t.position[2]],e.realPosition[2]*=-1),t.rotation&&(e.realRotation=[t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]],e.realRotation[2]*=-1,e.realRotation[3]*=-1),t.scale&&(e.realScale=[t.scale[0],t.scale[1],t.scale[2]]),n&&(t.position&&jt.decodeArray(0,e.realPosition,n,3),t.rotation&&jt.decodeArray(0,e.realRotation,n,3),t.scale&&jt.decodeArray(1,e.realScale,n,3))}static loadFile(e,t){t.url=e;var r=new Promise(((r,s)=>{fetch(e+"index.json").then((e=>e.text())).then((e=>{t.index=JSON.parse(e),r()})).catch((e=>{console.error(e),s()}))})),s=new Promise(((r,s)=>{fetch(e+"scene.json").then((e=>e.text())).then((e=>{t.scene=JSON.parse(e),r()})).catch((e=>{console.error(e),s()}))}));return Promise.all([r,s])}static getBaseUrl(e){var t=e+"/";return"/"!==e.charAt(e.length-1)&&"\\"!==e.slice(e.length-1,e.length-2)||(t=e),t}}for(var Ct=[],Tt=0;Tt<256;Tt++)Ct[Tt]=(Tt<16?"0":"")+Tt.toString(16);var Mt=1234567,Jt={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(Ct[255&e]+Ct[e>>8&255]+Ct[e>>16&255]+Ct[e>>24&255]+"-"+Ct[255&t]+Ct[t>>8&255]+"-"+Ct[t>>16&15|64]+Ct[t>>24&255]+"-"+Ct[63&r|128]+Ct[r>>8&255]+"-"+Ct[r>>16&255]+Ct[r>>24&255]+Ct[255&s]+Ct[s>>8&255]+Ct[s>>16&255]+Ct[s>>24&255]).toUpperCase()},clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,r,s,n){return s+(e-t)*(n-s)/(r-t)},lerp:function(e,t,r){return(1-r)*e+r*t},smoothstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*(3-2*e)},smootherstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){return void 0!==e&&(Mt=e%2147483647),((Mt=16807*Mt%2147483647)-1)/2147483646},degToRad:function(e){return e*Jt.DEG2RAD},radToDeg:function(e){return e*Jt.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,r,s,n){var o=Math.cos,i=Math.sin,a=o(r/2),l=i(r/2),h=o((t+s)/2),c=i((t+s)/2),u=o((t-s)/2),d=i((t-s)/2),p=o((s-t)/2),g=i((s-t)/2);switch(n){case"XYX":e.set(a*c,l*u,l*d,a*h);break;case"YZY":e.set(l*d,a*c,l*u,a*h);break;case"ZXZ":e.set(l*u,l*d,a*c,a*h);break;case"XZX":e.set(a*c,l*g,l*p,a*h);break;case"YXY":e.set(l*p,a*c,l*g,a*h);break;case"ZYZ":e.set(l*g,l*p,a*c,a*h);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+n)}}};class wt{constructor(e,t,r,s){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===s&&(s=1),Object.defineProperty(this,"isQuaternion",{value:!0}),this._x=e,this._y=t,this._z=r,this._w=s}static slerp(e,t,r,s){return r.copy(e).slerp(t,s)}static slerpFlat(e,t,r,s,n,o,i){var a=r[s+0],l=r[s+1],h=r[s+2],c=r[s+3],u=n[o+0],d=n[o+1],p=n[o+2],g=n[o+3];if(c!==g||a!==u||l!==d||h!==p){var v=1-i,m=a*u+l*d+h*p+c*g,f=m>=0?1:-1,y=1-m*m;if(y>Number.EPSILON){var x=Math.sqrt(y),_=Math.atan2(x,m*f);v=Math.sin(v*_)/x,i=Math.sin(i*_)/x}var b=i*f;if(a=a*v+u*b,l=l*v+d*b,h=h*v+p*b,c=c*v+g*b,v===1-i){var C=1/Math.sqrt(a*a+l*l+h*h+c*c);a*=C,l*=C,h*=C,c*=C}}e[t]=a,e[t+1]=l,e[t+2]=h,e[t+3]=c}static multiplyQuaternionsFlat(e,t,r,s,n,o){var i=r[s],a=r[s+1],l=r[s+2],h=r[s+3],c=n[o],u=n[o+1],d=n[o+2],p=n[o+3];return e[t]=i*p+h*c+a*d-l*u,e[t+1]=a*p+h*u+l*c-i*d,e[t+2]=l*p+h*d+i*u-a*c,e[t+3]=h*p-i*c-a*u-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,r,s){return this._x=e,this._y=t,this._z=r,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var r=e._x,s=e._y,n=e._z,o=e._order,i=Math.cos,a=Math.sin,l=i(r/2),h=i(s/2),c=i(n/2),u=a(r/2),d=a(s/2),p=a(n/2);switch(o){case"XYZ":this._x=u*h*c+l*d*p,this._y=l*d*c-u*h*p,this._z=l*h*p+u*d*c,this._w=l*h*c-u*d*p;break;case"YXZ":this._x=u*h*c+l*d*p,this._y=l*d*c-u*h*p,this._z=l*h*p-u*d*c,this._w=l*h*c+u*d*p;break;case"ZXY":this._x=u*h*c-l*d*p,this._y=l*d*c+u*h*p,this._z=l*h*p+u*d*c,this._w=l*h*c-u*d*p;break;case"ZYX":this._x=u*h*c-l*d*p,this._y=l*d*c+u*h*p,this._z=l*h*p-u*d*c,this._w=l*h*c+u*d*p;break;case"YZX":this._x=u*h*c+l*d*p,this._y=l*d*c+u*h*p,this._z=l*h*p-u*d*c,this._w=l*h*c-u*d*p;break;case"XZY":this._x=u*h*c-l*d*p,this._y=l*d*c-u*h*p,this._z=l*h*p+u*d*c,this._w=l*h*c+u*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+o)}return!1!==t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){var r=t/2,s=Math.sin(r);return this._x=e.x*s,this._y=e.y*s,this._z=e.z*s,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(e){var t=e.elements,r=t[0],s=t[4],n=t[8],o=t[1],i=t[5],a=t[9],l=t[2],h=t[6],c=t[10],u=r+i+c;if(u>0){var d=.5/Math.sqrt(u+1);this._w=.25/d,this._x=(h-a)*d,this._y=(n-l)*d,this._z=(o-s)*d}else if(r>i&&r>c){var p=2*Math.sqrt(1+r-i-c);this._w=(h-a)/p,this._x=.25*p,this._y=(s+o)/p,this._z=(n+l)/p}else if(i>c){var g=2*Math.sqrt(1+i-r-c);this._w=(n-l)/g,this._x=(s+o)/g,this._y=.25*g,this._z=(a+h)/g}else{var v=2*Math.sqrt(1+c-r-i);this._w=(o-s)/v,this._x=(n+l)/v,this._y=(a+h)/v,this._z=.25*v}return this._onChangeCallback(),this}setFromUnitVectors(e,t){var r=e.dot(t)+1;return r<1e-6?(r=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=r):(this._x=0,this._y=-e.z,this._z=e.y,this._w=r)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=r),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Jt.clamp(this.dot(e),-1,1)))}rotateTowards(e,t){var r=this.angleTo(e);if(0===r)return this;var s=Math.min(1,t/r);return this.slerp(e,s),this}identity(){return this.set(0,0,0,1)}inverse(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){var r=e._x,s=e._y,n=e._z,o=e._w,i=t._x,a=t._y,l=t._z,h=t._w;return this._x=r*h+o*i+s*l-n*a,this._y=s*h+o*a+n*i-r*l,this._z=n*h+o*l+r*a-s*i,this._w=o*h-r*i-s*a-n*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);var r=this._x,s=this._y,n=this._z,o=this._w,i=o*e._w+r*e._x+s*e._y+n*e._z;if(i<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,i=-i):this.copy(e),i>=1)return this._w=o,this._x=r,this._y=s,this._z=n,this;var a=1-i*i;if(a<=Number.EPSILON){var l=1-t;return this._w=l*o+t*this._w,this._x=l*r+t*this._x,this._y=l*s+t*this._y,this._z=l*n+t*this._z,this.normalize(),this._onChangeCallback(),this}var h=Math.sqrt(a),c=Math.atan2(h,i),u=Math.sin((1-t)*c)/h,d=Math.sin(t*c)/h;return this._w=o*u+this._w*d,this._x=r*u+this._x*d,this._y=s*u+this._y*d,this._z=n*u+this._z*d,this._onChangeCallback(),this}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}class St{constructor(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),Object.defineProperty(this,"isVector3",{value:!0}),this.x=e,this.y=t,this.z=r}set(e,t,r){return void 0===r&&(r=this.z),this.x=e,this.y=t,this.z=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Nt.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Nt.setFromAxisAngle(e,t))}applyMatrix3(e){var t=this.x,r=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[3]*r+n[6]*s,this.y=n[1]*t+n[4]*r+n[7]*s,this.z=n[2]*t+n[5]*r+n[8]*s,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){var t=this.x,r=this.y,s=this.z,n=e.elements,o=1/(n[3]*t+n[7]*r+n[11]*s+n[15]);return this.x=(n[0]*t+n[4]*r+n[8]*s+n[12])*o,this.y=(n[1]*t+n[5]*r+n[9]*s+n[13])*o,this.z=(n[2]*t+n[6]*r+n[10]*s+n[14])*o,this}applyQuaternion(e){var t=this.x,r=this.y,s=this.z,n=e.x,o=e.y,i=e.z,a=e.w,l=a*t+o*s-i*r,h=a*r+i*t-n*s,c=a*s+n*r-o*t,u=-n*t-o*r-i*s;return this.x=l*a+u*-n+h*-i-c*-o,this.y=h*a+u*-o+c*-n-l*-i,this.z=c*a+u*-i+l*-o-h*-n,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){var t=this.x,r=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[4]*r+n[8]*s,this.y=n[1]*t+n[5]*r+n[9]*s,this.z=n[2]*t+n[6]*r+n[10]*s,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this}cross(e,t){return void 0!==t?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)}crossVectors(e,t){var r=e.x,s=e.y,n=e.z,o=t.x,i=t.y,a=t.z;return this.x=s*a-n*i,this.y=n*o-r*a,this.z=r*i-s*o,this}projectOnVector(e){var t=e.lengthSq();if(0===t)return this.set(0,0,0);var r=e.dot(this)/t;return this.copy(e).multiplyScalar(r)}projectOnPlane(e){return It.copy(this).projectOnVector(e),this.sub(It)}reflect(e){return this.sub(It.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){var t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;var r=this.dot(e)/t;return Math.acos(Jt.clamp(r,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){var t=this.x-e.x,r=this.y-e.y,s=this.z-e.z;return t*t+r*r+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,r){var s=Math.sin(t)*e;return this.x=s*Math.sin(r),this.y=Math.cos(t)*e,this.z=s*Math.cos(r),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,r){return this.x=e*Math.sin(t),this.y=r,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){var t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){var t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),s=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=s,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t,r){return void 0!==r&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}var It=new St,Nt=new wt;class Et{constructor(){Object.defineProperty(this,"isMatrix4",{value:!0}),this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(e,t,r,s,n,o,i,a,l,h,c,u,d,p,g,v){var m=this.elements;return m[0]=e,m[4]=t,m[8]=r,m[12]=s,m[1]=n,m[5]=o,m[9]=i,m[13]=a,m[2]=l,m[6]=h,m[10]=c,m[14]=u,m[3]=d,m[7]=p,m[11]=g,m[15]=v,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Et).fromArray(this.elements)}copy(e){var t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],this}copyPosition(e){var t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this}extractBasis(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this}extractRotation(e){var t=this.elements,r=e.elements,s=1/Pt.setFromMatrixColumn(e,0).length(),n=1/Pt.setFromMatrixColumn(e,1).length(),o=1/Pt.setFromMatrixColumn(e,2).length();return t[0]=r[0]*s,t[1]=r[1]*s,t[2]=r[2]*s,t[3]=0,t[4]=r[4]*n,t[5]=r[5]*n,t[6]=r[6]*n,t[7]=0,t[8]=r[8]*o,t[9]=r[9]*o,t[10]=r[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,r=e.x,s=e.y,n=e.z,o=Math.cos(r),i=Math.sin(r),a=Math.cos(s),l=Math.sin(s),h=Math.cos(n),c=Math.sin(n);if("XYZ"===e.order){var u=o*h,d=o*c,p=i*h,g=i*c;t[0]=a*h,t[4]=-a*c,t[8]=l,t[1]=d+p*l,t[5]=u-g*l,t[9]=-i*a,t[2]=g-u*l,t[6]=p+d*l,t[10]=o*a}else if("YXZ"===e.order){var v=a*h,m=a*c,f=l*h,y=l*c;t[0]=v+y*i,t[4]=f*i-m,t[8]=o*l,t[1]=o*c,t[5]=o*h,t[9]=-i,t[2]=m*i-f,t[6]=y+v*i,t[10]=o*a}else if("ZXY"===e.order){var x=a*h,_=a*c,b=l*h,C=l*c;t[0]=x-C*i,t[4]=-o*c,t[8]=b+_*i,t[1]=_+b*i,t[5]=o*h,t[9]=C-x*i,t[2]=-o*l,t[6]=i,t[10]=o*a}else if("ZYX"===e.order){var T=o*h,M=o*c,J=i*h,w=i*c;t[0]=a*h,t[4]=J*l-M,t[8]=T*l+w,t[1]=a*c,t[5]=w*l+T,t[9]=M*l-J,t[2]=-l,t[6]=i*a,t[10]=o*a}else if("YZX"===e.order){var S=o*a,I=o*l,N=i*a,E=i*l;t[0]=a*h,t[4]=E-S*c,t[8]=N*c+I,t[1]=c,t[5]=o*h,t[9]=-i*h,t[2]=-l*h,t[6]=I*c+N,t[10]=S-E*c}else if("XZY"===e.order){var P=o*a,R=o*l,D=i*a,O=i*l;t[0]=a*h,t[4]=-c,t[8]=l*h,t[1]=P*c+O,t[5]=o*h,t[9]=R*c-D,t[2]=D*c-R,t[6]=i*h,t[10]=O*c+P}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Dt,e,Ot)}lookAt(e,t,r){var s=this.elements;return Gt.subVectors(e,t),0===Gt.lengthSq()&&(Gt.z=1),Gt.normalize(),Lt.crossVectors(r,Gt),0===Lt.lengthSq()&&(1===Math.abs(r.z)?Gt.x+=1e-4:Gt.z+=1e-4,Gt.normalize(),Lt.crossVectors(r,Gt)),Lt.normalize(),Ft.crossVectors(Gt,Lt),s[0]=Lt.x,s[4]=Ft.x,s[8]=Gt.x,s[1]=Lt.y,s[5]=Ft.y,s[9]=Gt.y,s[2]=Lt.z,s[6]=Ft.z,s[10]=Gt.z,this}multiply(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){var r=e.elements,s=t.elements,n=this.elements,o=r[0],i=r[4],a=r[8],l=r[12],h=r[1],c=r[5],u=r[9],d=r[13],p=r[2],g=r[6],v=r[10],m=r[14],f=r[3],y=r[7],x=r[11],_=r[15],b=s[0],C=s[4],T=s[8],M=s[12],J=s[1],w=s[5],S=s[9],I=s[13],N=s[2],E=s[6],P=s[10],R=s[14],D=s[3],O=s[7],L=s[11],F=s[15];return n[0]=o*b+i*J+a*N+l*D,n[4]=o*C+i*w+a*E+l*O,n[8]=o*T+i*S+a*P+l*L,n[12]=o*M+i*I+a*R+l*F,n[1]=h*b+c*J+u*N+d*D,n[5]=h*C+c*w+u*E+d*O,n[9]=h*T+c*S+u*P+d*L,n[13]=h*M+c*I+u*R+d*F,n[2]=p*b+g*J+v*N+m*D,n[6]=p*C+g*w+v*E+m*O,n[10]=p*T+g*S+v*P+m*L,n[14]=p*M+g*I+v*R+m*F,n[3]=f*b+y*J+x*N+_*D,n[7]=f*C+y*w+x*E+_*O,n[11]=f*T+y*S+x*P+_*L,n[15]=f*M+y*I+x*R+_*F,this}multiplyScalar(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){var e=this.elements,t=e[0],r=e[4],s=e[8],n=e[12],o=e[1],i=e[5],a=e[9],l=e[13],h=e[2],c=e[6],u=e[10],d=e[14];return e[3]*(+n*a*c-s*l*c-n*i*u+r*l*u+s*i*d-r*a*d)+e[7]*(+t*a*d-t*l*u+n*o*u-s*o*d+s*l*h-n*a*h)+e[11]*(+t*l*c-t*i*d-n*o*c+r*o*d+n*i*h-r*l*h)+e[15]*(-s*i*h-t*a*c+t*i*u+s*o*c-r*o*u+r*a*h)}transpose(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(e,t,r){var s=this.elements;return e.isVector3?(s[12]=e.x,s[13]=e.y,s[14]=e.z):(s[12]=e,s[13]=t,s[14]=r),this}getInverse(e,t){void 0!==t&&console.warn("THREE.Matrix4: .getInverse() can no longer be configured to throw on degenerate.");var r=this.elements,s=e.elements,n=s[0],o=s[1],i=s[2],a=s[3],l=s[4],h=s[5],c=s[6],u=s[7],d=s[8],p=s[9],g=s[10],v=s[11],m=s[12],f=s[13],y=s[14],x=s[15],_=p*y*u-f*g*u+f*c*v-h*y*v-p*c*x+h*g*x,b=m*g*u-d*y*u-m*c*v+l*y*v+d*c*x-l*g*x,C=d*f*u-m*p*u+m*h*v-l*f*v-d*h*x+l*p*x,T=m*p*c-d*f*c-m*h*g+l*f*g+d*h*y-l*p*y,M=n*_+o*b+i*C+a*T;if(0===M)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var J=1/M;return r[0]=_*J,r[1]=(f*g*a-p*y*a-f*i*v+o*y*v+p*i*x-o*g*x)*J,r[2]=(h*y*a-f*c*a+f*i*u-o*y*u-h*i*x+o*c*x)*J,r[3]=(p*c*a-h*g*a-p*i*u+o*g*u+h*i*v-o*c*v)*J,r[4]=b*J,r[5]=(d*y*a-m*g*a+m*i*v-n*y*v-d*i*x+n*g*x)*J,r[6]=(m*c*a-l*y*a-m*i*u+n*y*u+l*i*x-n*c*x)*J,r[7]=(l*g*a-d*c*a+d*i*u-n*g*u-l*i*v+n*c*v)*J,r[8]=C*J,r[9]=(m*p*a-d*f*a-m*o*v+n*f*v+d*o*x-n*p*x)*J,r[10]=(l*f*a-m*h*a+m*o*u-n*f*u-l*o*x+n*h*x)*J,r[11]=(d*h*a-l*p*a-d*o*u+n*p*u+l*o*v-n*h*v)*J,r[12]=T*J,r[13]=(d*f*i-m*p*i+m*o*g-n*f*g-d*o*y+n*p*y)*J,r[14]=(m*h*i-l*f*i-m*o*c+n*f*c+l*o*y-n*h*y)*J,r[15]=(l*p*i-d*h*i+d*o*c-n*p*c-l*o*g+n*h*g)*J,this}scale(e){var t=this.elements,r=e.x,s=e.y,n=e.z;return t[0]*=r,t[4]*=s,t[8]*=n,t[1]*=r,t[5]*=s,t[9]*=n,t[2]*=r,t[6]*=s,t[10]*=n,t[3]*=r,t[7]*=s,t[11]*=n,this}getMaxScaleOnAxis(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],s=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,s))}makeTranslation(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this}makeRotationX(e){var t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this}makeRotationY(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this}makeRotationZ(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){var r=Math.cos(t),s=Math.sin(t),n=1-r,o=e.x,i=e.y,a=e.z,l=n*o,h=n*i;return this.set(l*o+r,l*i-s*a,l*a+s*i,0,l*i+s*a,h*i+r,h*a-s*o,0,l*a-s*i,h*a+s*o,n*a*a+r,0,0,0,0,1),this}makeScale(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this}makeShear(e,t,r){return this.set(1,t,r,0,e,1,r,0,e,t,1,0,0,0,0,1),this}compose(e,t,r){var s=this.elements,n=t._x,o=t._y,i=t._z,a=t._w,l=n+n,h=o+o,c=i+i,u=n*l,d=n*h,p=n*c,g=o*h,v=o*c,m=i*c,f=a*l,y=a*h,x=a*c,_=r.x,b=r.y,C=r.z;return s[0]=(1-(g+m))*_,s[1]=(d+x)*_,s[2]=(p-y)*_,s[3]=0,s[4]=(d-x)*b,s[5]=(1-(u+m))*b,s[6]=(v+f)*b,s[7]=0,s[8]=(p+y)*C,s[9]=(v-f)*C,s[10]=(1-(u+g))*C,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}decompose(e,t,r){var s=this.elements,n=Pt.set(s[0],s[1],s[2]).length(),o=Pt.set(s[4],s[5],s[6]).length(),i=Pt.set(s[8],s[9],s[10]).length();this.determinant()<0&&(n=-n),e.x=s[12],e.y=s[13],e.z=s[14],Rt.copy(this);var a=1/n,l=1/o,h=1/i;return Rt.elements[0]*=a,Rt.elements[1]*=a,Rt.elements[2]*=a,Rt.elements[4]*=l,Rt.elements[5]*=l,Rt.elements[6]*=l,Rt.elements[8]*=h,Rt.elements[9]*=h,Rt.elements[10]*=h,t.setFromRotationMatrix(Rt),r.x=n,r.y=o,r.z=i,this}makePerspective(e,t,r,s,n,o){void 0===o&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var i=this.elements,a=2*n/(t-e),l=2*n/(r-s),h=(t+e)/(t-e),c=(r+s)/(r-s),u=-(o+n)/(o-n),d=-2*o*n/(o-n);return i[0]=a,i[4]=0,i[8]=h,i[12]=0,i[1]=0,i[5]=l,i[9]=c,i[13]=0,i[2]=0,i[6]=0,i[10]=u,i[14]=d,i[3]=0,i[7]=0,i[11]=-1,i[15]=0,this}makeOrthographic(e,t,r,s,n,o){var i=this.elements,a=1/(t-e),l=1/(r-s),h=1/(o-n),c=(t+e)*a,u=(r+s)*l,d=(o+n)*h;return i[0]=2*a,i[4]=0,i[8]=0,i[12]=-c,i[1]=0,i[5]=2*l,i[9]=0,i[13]=-u,i[2]=0,i[6]=0,i[10]=-2*h,i[14]=-d,i[3]=0,i[7]=0,i[11]=0,i[15]=1,this}equals(e){for(var t=this.elements,r=e.elements,s=0;s<16;s++)if(t[s]!==r[s])return!1;return!0}fromArray(e,t){void 0===t&&(t=0);for(var r=0;r<16;r++)this.elements[r]=e[r+t];return this}toArray(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}}for(var Pt=new St,Rt=new Et,Dt=new St(0,0,0),Ot=new St(1,1,1),Lt=new St,Ft=new St,Gt=new St,zt=[],Ht=0;Ht<256;Ht++)zt[Ht]=(Ht<16?"0":"")+Ht.toString(16).toUpperCase();class Ut{static pointInsidePolygon(e,t){var r,s,n,o,i=0;for(e.push(e[0]),r=0;r<e.length-1;r++)n=e[r],o=e[r+1],t[0]>Math.min(n[0],o[0])&&t[0]<=Math.max(n[0],o[0])&&t[1]<=Math.max(n[1],o[1])&&n[0]!=o[0]&&(s=(t[0]-n[0])*(o[1]-n[1])/(o[0]-n[0])+n[1],(n[1]==o[1]||t[1]<=s)&&i++);return!!i%2}static processPosition(e){return e&&e.length>2?[bt.saveDecimal(e[0],3),bt.saveDecimal(e[1],3),bt.saveDecimal(e[2],3)]:[0,0,0]}static processAngles(e){if(e&&e.length>2&&(0!=e[0]||0!=e[1]||0!=e[2])){var t=THING.Utils.parseQuaternion(e).toArray();return[bt.saveDecimal(t[0],8),bt.saveDecimal(t[1],8),bt.saveDecimal(t[2],8),bt.saveDecimal(t[3],8)]}return null}static processQuaternion(e){var t=new wt(e[0],e[1],e[2],e[3]);if(Ut.getDecimalLength(e[0])<=7||Ut.getDecimalLength(e[1])<=7||Ut.getDecimalLength(e[2])<=7||Ut.getDecimalLength(e[3])<=7){var r=new Et;r.compose(new St(0,0,0),t,new St(1,1,1)),r.decompose(new St,t,new St)}return THING.MathUtils.getAnglesFromQuat([t.x,t.y,t.z,t.w])}static processScale(e){return e&&e.length>2&&(1!=e[0]||1!=e[1]||1!=e[2])?[bt.saveDecimal(e[0],3),bt.saveDecimal(e[1],3),bt.saveDecimal(e[2],3)]:null}static addResourceToArray(e,t){for(var r=0;r<e.length;r++){if(e[r].url==t.url)return r}return e.push(t)-1}static addTextureToArray(e,t){for(var r=0;r<e.length;r++){var s=e[r];if(s.url==t.url&&s.flipY===t.flipY)return r}return e.push(t)-1}static addStringToArray(e,t){for(var r=0;r<e.length;r++){if(e[r]==t)return r}return e.push(t)-1}static getIdOnesPlaceNumber(e){var t=-1,r=Number(e);if(isNaN(r)){if(t=0,Ut.isUUID(e)){var s=e.slice(e.length-2);if(s){var n=parseInt(s,16);isNaN(n)||(t=n)}}}else"number"==typeof e&&(e+=""),t=(r=parseInt(e.substring(e.length-1)))%10;return 1^t}static decodeArray(e,t,r,s){if(void 0===s&&(s=3),t)for(var n=0;n<s;n++){var o=t[n];Ut.isTwoDoublesEqual(e,o)||(t[n]=Ut.decodeNumber(o,r))}return t}static encodeArray(e,t,r,s){if(void 0===s&&(s=3),t)for(var n=0;n<s;n++){var o=t[n];Ut.isTwoDoublesEqual(e,o)||(t[n]=Ut.encodeNumber(o,r))}return t}static decodeNumber(e,t){return e>0?e-t:e+t}static encodeNumber(e,t){return e>0?e+t:e-t}static isUUID(e){var t=""+e;return null!==(t=t.match("^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"))}static isTwoDoublesEqual(e,t){return e===t}static getDecimalLength(e){if(e){var t=e.toString().split(".")[1];if(t)return t.length}return 0}static isDefaultVector3(e,t){return void 0===t&&(t=0),e&&e.length>2&&e[0]===t&&e[1]===t&&e[2]===t}static isDefaultQuat(e){return e&&e.length>3&&0===e[0]&&0===e[1]&&0===e[2]&&1===e[3]}static generateUUID(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return zt[255&e]+zt[e>>8&255]+zt[e>>16&255]+zt[e>>24&255]+"-"+zt[255&t]+zt[t>>8&255]+"-"+zt[t>>16&15|64]+zt[t>>24&255]+"-"+zt[63&r|128]+zt[r>>8&255]+"-"+zt[r>>16&255]+zt[r>>24&255]+zt[255&s]+zt[s>>8&255]+zt[s>>16&255]+zt[s>>24&255]}}var jt=Ut;function kt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}class Bt{constructor(e){this.app=e.app,this.baseLocalUrl=e.baseLocalUrl._appendURL("/"),this.importModels=e.models||[],this.importTextures=e.textures||[],this.importAoMap=e.aoMap,this.exportModels=[],this.exportTextures=[],this.exportUuids=[],this.modelUseCount=[],this.exportInstanceCount=[],this.instancePlanes=new Map,this.matrixData={},this.matrixNode=null}getMatrixData(e,t){return new Promise(((r,s)=>{var n=null;switch(t){case 3:case 4:case 5:n="InverseRotationToMesh";break;case 6:n="InverseRotationToVertices"}this.app.resourceManager.loadModel(this.baseLocalUrl+e.localurl,(e=>{this.matrixData=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?kt(Object(r),!0).forEach((function(t){xt(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):kt(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},this.matrixData,e.node.getSubNodesMatrixInfo()),this.matrixNode=e.node,r()}),void 0,void 0,{lights:!0,inverseRotationMode:n})}))}getTransform(e){var t=this.matrixData[e];if(t){var r=[],s=[],n=[];return THING.MathUtils.decomposeFromMat4(t,r,s,n),{position:r,quaternion:s,scale:n}}}addInstancePlanes(e){this.instancePlanes.has(e)?this.instancePlanes.get(e).value++:this.instancePlanes.set(e,{value:1,instanceCountIndex:null})}getInstancePlanes(e){return this.exportInstanceCount.push(Array(e))-1}getModelByIndex(e){var t=this.importModels[e];return t.id?t:null}getModelById(e){for(var t=0;t<this.importModels.length;t++)if(e===this.importModels[t].id)return this.importModels[t];return null}getTextureByIndex(e){var t=this.importTextures[e];return t||null}getTextureById(e){for(var t=0;t<this.importTextures.length;t++)if(e===this.importTextures[t].id)return this.importTextures[t];return null}addModel(e){return jt.addResourceToArray(this.exportModels,e)}addModelUseCount(e){this.modelUseCount[e]?this.modelUseCount[e]++:this.modelUseCount[e]=1}getInstance(e){for(var t=0;t<this.exportInstanceCount.length;t++){if(e===this.exportInstanceCount[t][0])return this.exportInstanceCount[t].push(e),t}return this.exportInstanceCount[this.exportInstanceCount.length]=[e],this.exportInstanceCount.length-1}addTexture(e){return jt.addTextureToArray(this.exportTextures,e)}addUUID(e){return this.exportUuids.push(e)-1}}class At{constructor(e){this.param=e,this.version=e.version,this.app=e.app,this._versionMap={},this._smallVersionLibs=[],this._bigVersions=[]}import(e){var t=null;return e.scene.materialsetting&&e.scene.materialsetting.straightmanualwall&&e.scene.materialsetting.straightmanualwall.lightingtexture&&(t=e.scene.materialsetting.straightmanualwall.lightingtexture),this.resourceManager=new Bt({app:this.app,baseLocalUrl:e.url,models:e.scene.models,textures:e.scene.textures,aoMap:t}),new Promise(((t,r)=>{if(e.scene&&e.scene.models){for(var s=[],n=0;n<e.scene.models.length;n++){var o=e.scene.models[n];if(!0!==o.keeprootrotation)if(5===this.version.mode)s.push(this.resourceManager.getMatrixData(o,this.version.smallVersion));else if(7===this.version.mode&&o.loadversion){var i=new _t(o.loadversion);5===i.mode&&o.localurl&&s.push(this.resourceManager.getMatrixData(o,i.smallVersion))}}window.promises=s,Promise.all(s).then((()=>{t()}))}else t()}))}_getCreatorConfig(e,t){if(null==e){var r=this._smallVersionLibs[this._bigVersions.length-1];return t=r[r.length-1],this._versionMap[this._bigVersions.length-1][t]}if(null==t){var s=this._smallVersionLibs[e];return t=s[s.length-1],this._versionMap[e][t]}var n=this._smallVersionLibs[e];if(!(e>this._bigVersions[this._bigVersions.length-1])){var o=n[n.length-1];return t>o||!this._versionMap[e][t]?this._versionMap[e][o]:this._versionMap[e][t]}console.error("ubuilderLoader not support version "+e+"."+t)}_currentDate(e){var t=new Date,r=" ",s="/",n=":",o=t.getMonth()+1,i=t.getDate();return e&&(r=s=n=e),o>=1&&o<=9&&(o="0"+o),i>=0&&i<=9&&(i="0"+i),t.getFullYear()+s+o+s+i+r+t.getHours()+n+t.getMinutes()+n+t.getSeconds()}}class Vt{static getStyleTag(e){var t=e.originalType,r=null;switch(t){case"Facade":r=st;break;case"Placement":r=Vt.placementStyleTag(e);break;case"Window":case"Door":r=Vt.doorOrWindowStyleTag(e,t);break;case"VideoProbe":r=ot;break;case"Room":r=Vt.roomStyleTag(e);break;case"RoomSlab":r=lt;break;case"RoomRoof":r=ht;break;case"RoomCeiling":r=ct;break;case"CombineWall":case"PlacementWall":r="Outdoors"===e.parent.originalType?nt:ut;break;default:-1!==t.indexOf("Combine")&&(r=Vt.combinedStyleTag(e,t))}return r}static placementStyleTag(e){var t=e.baseModel.url;return Vt.isTree(t)?it:Vt.isWall(t)?"Outdoors"===("Misc"===e.parent.thing2Type?e.parent.parent:e.parent).originalType?nt:ut:"Misc"===e.parent.thing2Type?at:ot}static doorOrWindowStyleTag(e,t){return"Window"===t?"Outdoors"===e.parent.originalType?at:ot:"Outdoors"===e.parent.originalType?at:dt}static roomStyleTag(e){if(!e.isFloorRoom)return nt}static combinedStyleTag(e,t){var r=at;switch(t){case"CombineFloor":r=lt;break;case"CombineCeiling":r=ct;break;case"CombineRoof":r=ht;break;case"CombinePlacement":if(e.baseModel){var s=e.baseModel.id;if(Vt.isTree(s))r=it;else if(Vt.isWall(s)){r="Outdoors"===("Misc"===e.parent.thing2Type?e.parent.parent:e.parent).originalType?nt:ut}r=at}}return r}static isWall(e){return!!e&&!!pt[e]}static isTree(e){return!!e&&!!gt[e]}}class Wt{constructor(e,t,r){void 0===e&&(e={}),this.options=e,this.resourceManager=e.resourceManager,this.creatorMap=e.creatorMap,this.parent=r,this.originalJson=t,this.children=[],this.baseModel={},this.convertJson={external:{material:{}},userData:{},body:{},style:{uv:{}},children:[]},!1===t.visible&&(this.convertJson.visible=!1)}_parseChildren(){}_generateChildrenCreators(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{r=r||this,!1===this.originalJson.visible&&(e.visible=!1);var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}convert(e){return this._convertSelf(e),this._convertChildren(e),this._cutEmptyJson(),this.convertJson}_convertStyleTag(){var e=this.originalJson.properties;e||(e=this.originalJson.properties={}),e._styleTag_||(e._styleTag_=Vt.getStyleTag(this)),e._styleTag_||delete this.originalJson.properties,this.originalJson.properties&&(this.convertJson.userData=this.originalJson.properties)}_convertSelf(e){this._convertStyleTag(),e&&!1===e.queryable&&(this.convertJson.queryable=!1),this.convertJson.type=this.thing2Type,this.originalJson.id&&(this.convertJson.uuid=this.resourceManager.addUUID(this.originalJson.id)),this.originalJson.name&&(this.convertJson.name=this.originalJson.name),this.originalJson.userid&&(this.convertJson.id=this.originalJson.userid),this._convertTags(),this._convertTransform(),this._convertCamInfo()}_convertTags(){}_convertTransform(){}_convertCamInfo(){var e,t;if(this.originalJson.caminfo&&(e=this.originalJson.caminfo.eye,t=this.originalJson.caminfo.target),this.originalJson.camInfo&&(e=s(this.originalJson.camInfo.eye),t=s(this.originalJson.camInfo.target)),e&&t){var r=this._getWorldPosition();this.convertJson.components=[{name:"level",type:"LevelComponent",external:{viewpoint:{position:[e[0]-r[0],e[1]-r[1],-e[2]-r[2]],target:[t[0]-r[0],t[1]-r[1],-t[2]-r[2]]}}}]}function s(e,t){t=e.split(" ");for(var r=0;r<t.length;r++)t[r]=parseFloat(t[r]);return t}}_getWorldPosition(){return[0,0,0]}_toSelfPoints(e){return e.map((e=>{var t,r,s=(t=e,r=this.realPosition,[t[0]-r[0],t[1]-r[1],t[2]-r[2]]);return[s[0],s[2]]}))}_toSelfHoles(e){return e.map((e=>this._toSelfPoints(e)))}_convertChildren(e){var t=[];this.children.forEach((r=>{t.push(r.convert(e))})),t.length&&this.convertJson.children.push(...t)}_cutEmptyJson(){this.convertJson.external&&!Object.keys(this.convertJson.external.corners||{}).length&&delete this.convertJson.external.corners,this.convertJson.external&&!Object.keys(this.convertJson.external.material||{}).length&&delete this.convertJson.external.material,Object.keys(this.convertJson.external||{}).length||delete this.convertJson.external,Object.keys(this.convertJson.userData||{}).length||delete this.convertJson.userData,Object.keys(this.convertJson.body||{}).length||delete this.convertJson.body,this.convertJson.style&&!Object.keys(this.convertJson.style.uv||{}).length&&delete this.convertJson.style.uv,Object.keys(this.convertJson.style||{}).length||delete this.convertJson.style,Object.keys(this.convertJson.body||{}).length||delete this.convertJson.body,this.convertJson.children&&!this.convertJson.children.length&&delete this.convertJson.children}_isShouldCombine(e){return!!(t(e.originalJson.userid)&&t(e.originalJson.name)&&t(e.originalJson.isshow)&&(t(e.originalJson.properties)||!t(e.originalJson.properties._styleTag_)&&1===Object.keys(e.originalJson.properties).length));function t(e){return null==e}}addCorners(e){for(var t=0;t<this.originalJson.corners.length;t++){var r=this.originalJson.corners[t];if(bt.floatEquals(r,e))return t}return this.originalJson.corners.push(e)-1}}class qt extends Wt{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.version=e.version,this._parseSelf(),e.noCreateChildren||this._parseChildren()}_parseSelf(){this._parseDecodeNumber(),bt.getParseTransform(this,this.originalJson,this.decodeNumber,this.version)}_parseDecodeNumber(){this.decodeNumber=this.originalJson.id}_convertSelf(e){if(super._convertSelf(e),"number"==typeof this.originalJson.texture){var t=this._convertTextureByType(this.originalJson.texture,this);"number"==typeof t&&(this.convertJson.style.map=t)}if("number"==typeof this.convertJson.body.id){var r=this.resourceManager.getModelByIndex(this.originalJson.model);this.resourceManager.modelUseCount[r.id]>1&&this.enableInstance&&(this.convertJson.external.instance=this.resourceManager.getInstance(r.id),this.convertJson.external.instanceId=1e4+this.convertJson.external.instance,this.convertJson.external.instanceCount=this.resourceManager.modelUseCount[r.id],Object.keys(this.convertJson.style||{}).length&&(this.convertJson.external.instanceStyle=this.convertJson.style,delete this.convertJson.style))}}_convertTexture(e,t){void 0===t&&(t=!1);var r={};return Object.assign(r,this.resourceManager.getTextureByIndex(e)),Object.keys(r).length?this.resourceManager.addTexture(bt.parseTexture(r,t)):null}_convertTransform(){this.realPosition&&(this.convertJson.position=this.realPosition),this.realScale&&(this.convertJson.scale=this.realScale),this.parent&&this.parent.useInverseRotation&&(this.convertJson.quaternion=[-this.parent.useInverseRotation[0],-this.parent.useInverseRotation[1],-this.parent.useInverseRotation[2],this.parent.useInverseRotation[3]],this.convertJson.position=bt.vec3ApplyQuat(this.convertJson.position,this.convertJson.quaternion)),this.realRotation&&(this.convertJson.quaternion?this.convertJson.quaternion=bt.multiplyQuat(this.realRotation,this.convertJson.quaternion):this.convertJson.quaternion=this.realRotation)}_convertTextureByType(e,t){return"Placement"===t.originalType||"GeneralRouteLine"===t.originalType?this._convertTexture(e):this._convertTexture(e,!0)}get thing2Type(){}_convertPlane(e){var t="custom",r={materialResource:{uv:{}}};if(!this.isRoom){var s=this.resourceManager.instancePlanes.get(this.instanceString);s.value>1&&("number"!=typeof s.instanceCountIndex&&(s.instanceCountIndex=this.resourceManager.getInstancePlanes(s.value)),r.instanceGroupName=this.instanceString)}r.materialResource.sideType=this.sideType,r.materialResource._floorao=this._floorao;var n=null;"number"==typeof this.originalJson[e+t+"texture"]?(n=this.resourceManager.getTextureByIndex(this.originalJson[e+t+"texture"]))&&(r.materialResource.map=rt+(n.texture||n.id)+"."+n.ext,n.color&&(r.materialResource.color=n.color)):(n=this.resourceManager.getTextureByIndex(this.originalJson[e+"texture"]))&&(r.materialResource.map=rt+n.id+"."+n.ext);var o="roof"===e?[2,2]:[.6,.6],i=this.originalJson[e+"blocksize"]||o;r.materialResource.uv.repeat=[1/i[0],1/i[1]],this.originalJson[e+"blockangle"]&&(r.materialResource.uv.angle=-this.originalJson[e+"blockangle"]),!1===this.originalJson["isshow"+e]&&(r.alwaysHide=!0,this.convertJson.layerMask=0),this.convertJson.components=[{name:"PlaneComponent",type:"PlaneComponent",external:r}]}}let Qt=class extends qt{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.misc=this.misc||null,this.rooms=this.rooms||[],this.parent&&this.parent.hideStruct&&(this.convertJson.visible=!1)}get thing2Type(){return"Floor"}get originalType(){return"Floorplan"}get isFloor(){return!0}_convertSelf(e){super._convertSelf(e),this.isFloor&&(this.convertJson.external.constantShowThings=!!this.originalJson.alwaysshowinsideobjs),this.corners.length&&(this.convertJson.external.corners=this.corners),this.originalJson.height&&(this.convertJson.height=this.originalJson.height)}_getWorldPosition(){if(this.isFloor){return e=this.convertJson.position,t=this.parent.convertJson.position,[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}var e,t;return[0,0,0]}_parseSelf(){super._parseSelf(),bt.getParseCorners(this,this.originalJson,this.decodeNumber,this.version),this.originalJson.corners||(this.corners=[])}_parseChildren(){var e=this.originalJson.walls;if(e){var t=[],r=[],s=[];if(e.forEach((e=>{0===e.type?r.push(e):1===e.type?t.push(e):2===e.type&&s.push(e)})),t.length){var n=new this.creatorMap.wall(this.options,{},this);this.children.push(n),this._generateChildrenCreators(t,"modelWall",n)}if(r.length){var o=new this.creatorMap.wall(this.options,{},this);this.children.push(o),this._generateChildrenCreators(r,"textureWall",o)}this._generateChildrenCreators(s,"placementWall")}this._generateChildrenCreators(this.originalJson.curvelines,"curveLine"),this._generateChildrenCreators(this.originalJson.routelines,"routeLine"),this._generateChildrenCreators(this.originalJson.leakwaterlines,"leakWaterLine"),this._generateChildrenCreators(this.originalJson.arrowlines,"arrowLine"),this._generateChildrenCreators(this.originalJson.arrowdatalines,"arrowDataLine"),this._generateChildrenCreators(this.originalJson.pipelines,"pipeLine"),this._generateChildrenCreators(this.originalJson.grounds,"ground"),this._generateChildrenCreators(this.originalJson.generalpolygonlines,"generalPolygonLine"),this._generateChildrenCreators(this.originalJson.generalroutelines,"generalRouteLine"),this.rooms=this._generateChildrenCreators(this.originalJson.rooms,"room"),this.__generateChildrenCreators(this.originalJson.placements,"placement"),this.__generateChildrenCreators(this.originalJson.videoprobes,"placement"),this.__generateChildrenCreators(this.originalJson.groups,"group")}_generateChildrenCreators(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible?e.visible=!1:this.isFloor&&!this.originalJson.alwaysshowinsideobjs&&("room"===t||t.includes("Wall")||(e.visible=!1)),r&&r.isWall&&!1===e.visible&&(r.convertJson.visible=!1),r=r||this;var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}__generateChildrenCreators(e,t,r){void 0===r&&(r=this),e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{if((!1===this.originalJson.visible||this.isFloor&&!this.originalJson.alwaysshowinsideobjs)&&(e.visible=!1),e.properties&&"Ground"===e.properties._tjsType_){var s=new this.creatorMap[t](this.options,e,this);this.children.push(s)}else{var n=r,o=!1===e.isshow?"emptyObject":t,i=new this.creatorMap[o](this.options,e,this);if(this._isShouldCombine(i))this.misc||(this.misc=new this.creatorMap.misc(this.options,{visible:e.visible},r),r.children.push(this.misc)),n=this.misc;else if(this.isFloor&&i.originalJson._temp_belongroom)for(var a=0;a<this.rooms.length;a++){var l=this.rooms[a];if(l.originalJson.userid&&l.originalJson.userid===i.originalJson._temp_belongroom){i.realPosition&&(i.realPosition=[i.realPosition[0]-l.realPosition[0],i.realPosition[1]-l.realPosition[1],i.realPosition[2]-l.realPosition[2]]),n=l;break}}i.parent=n,n.children.push(i)}})))}};class Yt extends qt{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.doororwindows=this.doororwindows||[]}_parseChildren(){this.doororwindows=this.__generateChildrenCreators(this.originalJson.doororwindows,"doororwindow",this.parent.parent)}__generateChildrenCreators(e,t,r){var s=[];if(e){this.convertJson.holes=[];var n=this.parent.parent.corners[this.originalJson.corners[0]],o=this.parent.parent.corners[this.originalJson.corners[1]];Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible&&(e.visible=!1),r=r||this;var l=new this.creatorMap[t](this.options,e,r);r.children.push(l),s.push(l);var h,c,u,d=l.realPosition,p=a(n,d),g=a(n,o);this.convertJson.holes.push({loc:[p/g,l.originalJson.suspendpercent||0],size:i(l.baseModel.size,l.realScale)}),l.originalJson.suspendpercent&&this.convertJson.height&&(l.realPosition=[l.realPosition[0],l.realPosition[1]+this.convertJson.height*l.originalJson.suspendpercent,l.realPosition[2]]),l.realRotation=(h=[o[0]-n[0],o[1]-n[1],o[2]-n[2]],c=new St(...h).normalize(),(u=new wt).setFromUnitVectors(new St(1,0,0),c),u.toArray())}))}function i(e,t,r){return t=t||[1,1,1],(r=r||[])[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r}function a(e,t){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])+(e[2]-t[2])*(e[2]-t[2]))}return s}_convertSelf(e){super._convertSelf(e),this.parent&&!1===this.parent.convertJson.visible&&delete this.convertJson.visible,!1===this.originalJson.isshow&&(this.convertJson.visible=!1)}}let Zt=class extends qt{get thing2Type(){return"Entity"}get originalType(){return"Placement"}_convertTags(){this.convertJson.tags=[2]}_parseSelf(){super._parseSelf(),this._convertModel()}_convertModel(){if("number"==typeof this.originalJson.model){var e=this.resourceManager.getModelByIndex(this.originalJson.model);if(e){if("number"==typeof e.texture){var t=this._convertTextureByType(e.texture,this);"number"==typeof t&&(this.convertJson.style.map=t)}e.color&&(this.convertJson.style.color=[e.color[0],e.color[1],e.color[2]]),"number"==typeof e.opacity?(this.convertJson.style.opacity=e.opacity,this._convertRendermode(e)):e.color&&"number"==typeof e.color[3]&&(this.convertJson.style.opacity=e.color[3],this._convertRendermode(e));var r=this.baseModel={};if(Object.assign(r,e.model?this.resourceManager.getModelById(e.model):e),this.originalJson.animinfo&&this.originalJson.animinfo.isplay){var s=this.originalJson.animinfo.clip;this.convertJson.external.animInfo={name:s},"_defaultAnim_"===s&&(this.convertJson.external.animInfo.loopType="Repeat"),delete r.hasanimation}bt.parseModel(r,this.version,this.resourceManager.baseLocalUrl,this.convertJson),delete r.type,this.convertJson.body.id=this.resourceManager.addModel(r),this.addModelUseCount(e)}}}addModelUseCount(e){this.originalJson.animinfo&&this.originalJson.animinfo.clip.length&&this.originalJson.animinfo.isplay||this.realScale&&!(this.realScale[0]>0&&this.realScale[1]>0&&this.realScale[2]>0)||(this.resourceManager.addModelUseCount(e.id),this.enableInstance=!0)}_convertRendermode(e){this.convertJson.style.transparent=!0;var t=e.rendermode;t&&1===t&&!e.color&&(this.convertJson.style.transparent=!1)}_getWorldPosition(){var e=[0,0,0],t=function t(r){if(e=i(e,r.convertJson.position),r.parent.isGroup)return t(r.parent);return r}(this);if(t.parent.isWorld||t.parent.isOutdoor||t.parent.isMisc&&t.parent.parent.isWorld)return e;if(t.parent.isFloor){var r=i(e,t.parent.convertJson.position);return i(r,t.parent.parent.convertJson.position)}if(t.parent.isRoom){var s=i(e,t.parent.convertJson.position),n=i(s,t.parent.parent.convertJson.position);return i(n,t.parent.parent.parent.convertJson.position)}var o=i(e,t.parent.parent.convertJson.position);return i(o,t.parent.parent.parent.convertJson.position);function i(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}}};class Xt extends qt{_convertSelf(e){super._convertSelf(e),this.originalJson.color&&(this.convertJson.style.color=[this.originalJson.color[0],this.originalJson.color[1],this.originalJson.color[2]]),!1===this.originalJson.isshow&&(this.convertJson.layerMask=0),this.convertJson.external.selfPoints=this.originalJson.path;for(var t=0;t<this.convertJson.external.selfPoints.length;t++)this.convertJson.external.selfPoints[t][2]*=-1;if(this.originalJson.pointuserids&&this.originalJson.pointproperteis){for(var r=[],s=0;s<this.originalJson.pointuserids.length;s++)r[s]={},r[s].id=this.originalJson.pointuserids[s],r[s].userData=this.originalJson.pointproperteis[s];this.convertJson.userData._NODEPROPERTY_=r}}}let Kt=class extends Xt{get thing2Type(){return"RouteLine"}get originalType(){return"CurveLine"}_convertSelf(e){super._convertSelf(e);var t=this.convertJson.external.width=this.originalJson.width||2*parseFloat(this.originalJson.radius),r=[1,-t];this.originalJson.textiling&&(r=[this.originalJson.textiling[0],-this.originalJson.textiling[1]]),this.originalJson.blocksize&&(r=[t/this.originalJson.blocksize[0],-t/this.originalJson.blocksize[1]]),this.convertJson.style.uv.repeat=r;var s=[0,0];this.originalJson.texoffset&&(s=[this.originalJson.texoffset[0]*r[0]/t,this.originalJson.texoffset[1]*r[1]/t]),this.originalJson.blockoffset&&(s=[this.originalJson.blockoffset[0]*r[0]/t,this.originalJson.blockoffset[1]*r[1]/t]),this.convertJson.style.uv.offset=s;var n=90;this.originalJson.blockangle&&(n+=this.originalJson.blockangle),this.convertJson.style.uv.rotation=n;var o=[0,-1];this.originalJson.matanimdirection&&(o=this.originalJson.matanimdirection),this.originalJson.enableanim&&(this.convertJson.components=[{name:"lerp",type:"LerpComponent",external:{uv:{map:{value:{offset:[s[0]-o[0],s[1]+o[1]]},options:{time:1/(this.originalJson.matanimspeed||1)*1e3,loopType:"Repeat"}}}}}])}},$t=class extends Xt{get thing2Type(){return"PolygonLine"}get originalType(){return"PipeLine"}_convertSelf(e){super._convertSelf(e),this.convertJson.external.radius=parseFloat(this.originalJson.radius),"Square"===this.originalJson.sectiontype?(this.convertJson.external.radialSegments=4,this.convertJson.external.startDegree=45):"Triangle"===this.originalJson.sectiontype?this.convertJson.external.radialSegments=3:this.convertJson.external.radialSegments=8,this.convertJson.style.color=this.convertJson.style.color||[0,0,1];var t=2*this.convertJson.external.radius,r=[1,1],s=1.1*t*2*Math.PI/(this.originalJson.textiling?this.originalJson.textiling[0]:1);r=[s,-s],this.originalJson.blocksize&&(r=[t/this.originalJson.blocksize[0],-t/this.originalJson.blocksize[1]]),this.convertJson.style.uv.repeat=r;var n=[0,0];this.originalJson.texoffset&&(n=[this.originalJson.texoffset[0]*r[0]/t,this.originalJson.texoffset[1]*r[1]/t]),this.originalJson.blockoffset&&(n=[this.originalJson.blockoffset[0]*r[0]/t,this.originalJson.blockoffset[1]*r[1]/t]),this.convertJson.style.uv.offset=n;var o=0;this.originalJson.blockangle&&(o+=this.originalJson.blockangle),this.convertJson.style.uv.rotation=o;var i=[1,0];this.originalJson.matanimdirection&&(i=this.originalJson.matanimdirection),this.originalJson.enableanim&&(this.convertJson.components=[{name:"lerp",type:"LerpComponent",external:{uv:{map:{value:{offset:[n[0]-i[0],n[1]+i[1]]},options:{time:1/(this.originalJson.matanimspeed||1)*1e3,loopType:"Repeat"}}}}}])}},er=class extends $t{get originalType(){return"LeakWaterLine"}},tr=class extends Kt{get originalType(){return"ArrowLine"}_convertSelf(e){super._convertSelf(e),this.convertJson.external.arrow=!0}};class rr extends Wt{get thing2Type(){return"Misc"}get isMisc(){return!0}_convertSelf(e){this.convertJson={children:[]},!1===this.originalJson.visible&&(this.convertJson.visible=!1),this.convertJson.type=this.thing2Type}_convertChildren(e){void 0===e&&(e={}),e.queryable=!1,super._convertChildren(e)}}class sr extends Wt{get thing2Type(){return"Wall"}get originalType(){return"CombineWall"}get isWall(){return!0}_convertSelf(e){this._convertStyleTag(),this.convertJson.external={},this.resourceManager.importAoMap&&(this.convertJson.external.aoMap=this.resourceManager.importAoMap),this.convertJson.renderOrder=-9,this.convertJson.type=this.thing2Type}_convertChildren(e){var t=this.convertJson.external.walls=[];this.children.forEach((r=>{t.push(r.convert(e))}))}}class nr extends qt{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this._addInstancePlanes()}get sideType(){return"Double"}get _floorao(){return!1}_parseSelf(){}_addInstancePlanes(){if(!1!==this.originalJson.isshow){var e=this.thing2Type.toLowerCase();"slab"===e&&(e="floor");var t=this.parent.convertJson.external.points;if(this.parent.convertJson.external.holes)for(var r=0;r<this.parent.convertJson.external.holes.length;r++)t=t.concat(this.parent.convertJson.external.holes[r]);var s=e;if(s+=t.length,s+=this.sideType,s+=this.originalJson[e+"texture"],s+=this.originalJson[e+"blockangle"],s+=this.originalJson[e+"blocksize"],"number"==typeof this.originalJson[e+"customtexture"]){var n=this.resourceManager.getTextureByIndex(this.originalJson[e+"customtexture"]);n&&n.color&&(s+=n.color)}for(var o=0;o<t.length;o++){for(var i=t[o],a="",l=0;l<2;l++)a+=i[l].toFixed(3);s+=a}this.instanceString=s,this.resourceManager.addInstancePlanes(s)}}_convertSelf(e){super._convertSelf(e)}}var or={world:class extends qt{get thing2Type(){return"Campus"}get originalType(){return"World"}get isWorld(){return!0}_parseChildren(){this._generateChildrenCreators(this.originalJson.buildings,"building"),this._generateChildrenCreators(this.originalJson.outdoors,"outdoors")}},building:class extends qt{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.facades=this.facades||[],this.facadegroups=this.facadegroups||[]}get thing2Type(){return"Building"}get originalType(){return"Building"}get isBuilding(){return!0}get hideStruct(){if(this.originalJson.structshow)return!1;var e=this.originalJson.facades||[],t=this.originalJson.facadegroups||[];return!(!e.length&&!t.length)}_parseChildren(){this.facades=this._generateChildrenCreators(this.originalJson.facades,"facade"),this.facadegroups=this._generateChildrenCreators(this.originalJson.facadegroups,"facadeGroup"),this._generateChildrenCreators(this.originalJson.plans,"floorplan")}_convertSelf(e){super._convertSelf(e),this.hideStruct||(this.convertJson.external.constantShowStruct=!0)}_getWorldPosition(){return this.convertJson.position}},floorplan:Qt,modelWall:class extends Yt{get thing2Type(){return"PrefabWall"}get originalType(){return"ModelWall"}_parseSelf(){super._parseSelf(),void 0===this.originalJson.height||null===this.originalJson.height?this.convertJson.height=3:this.convertJson.height=this.originalJson.height}_convertSelf(e){if(super._convertSelf(e),this.originalJson.corners&&(this.convertJson.points=this.originalJson.corners),this.originalJson.thick&&(this.convertJson.thickness=this.originalJson.thick),"number"==typeof this.originalJson.model){var t=this.resourceManager.getModelByIndex(this.originalJson.model);if("C9FB3F9A29C842F79F02CECC4037FEA1"===t.id&&(this.convertJson.fillHole=!0),t){var r={};Object.assign(r,t),bt.parseModel(r,this.version,this.resourceManager.baseLocalUrl,this.convertJson),delete r.type,this.convertJson.model=this.resourceManager.addModel(r)}}}},textureWall:class extends Yt{get thing2Type(){return"StraightManualWall"}get originalType(){return"TextureWall"}_parseSelf(){super._parseSelf(),void 0===this.originalJson.height||null===this.originalJson.height?this.convertJson.height=3:this.convertJson.height=this.originalJson.height}_convertSelf(e){if(super._convertSelf(e),this.originalJson.corners&&(this.convertJson.points=this.originalJson.corners),this.convertJson.thickness=this.originalJson.thick||.25,this.convertJson.uvrepeat=[1,1,1,1],this.originalJson.uvmultiple){var t=[parseFloat(this.originalJson.uvmultiple[0]),parseFloat(this.originalJson.uvmultiple[1])];this.convertJson.uvrepeat=[t[0],t[1],t[0],t[1]]}var r=this._convertTexture(this.originalJson.lefttexture);"number"==typeof r&&(this.convertJson.lefttexture=r);var s=this._convertTexture(this.originalJson.righttexture);"number"==typeof s&&(this.convertJson.righttexture=s);var n=this._convertTexture(this.originalJson.edgetexture);"number"==typeof n&&(this.convertJson.edgetexture=n)}},placement:Zt,group:class extends qt{get thing2Type(){return"Group"}get originalType(){return"Group"}get isGroup(){return!0}_parseChildren(){this._generateChildrenCreators(this.originalJson.groups,"group"),this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.videoprobes,"placement")}},doororwindow:class extends Zt{get thing2Type(){return this.originalJson.iswindow?"Window":"Door"}get originalType(){return"DoorOrWindow"}_convertTags(){}addModelUseCount(e){this.originalJson.isopen||this.originalJson.diridx||this.realScale&&!(this.realScale[0]>0&&this.realScale[1]>0&&this.realScale[2]>0)||(this.resourceManager.addModelUseCount(e.id),this.enableInstance=!0)}_convertSelf(e){return super._convertSelf(e),this.convertJson.external.isOpen=this.originalJson.isopen||!1,this.convertJson.transformCorrection=!0,"number"==typeof this.originalJson.diridx&&(this.convertJson.external.dirIdx=this.originalJson.diridx),this.convertJson}},room:class extends qt{get thing2Type(){return this.isFloorRoom?"Room":"Object3D"}_convertTags(){this.isFloorRoom||(this.convertJson.tags=[3,6])}get originalType(){return"Room"}get isRoom(){return!0}_parseChildren(){if(this.isFloorRoom){var e=JSON.parse(JSON.stringify(this.originalJson));e.name=null,e.userid=null,e.properties={},this._generateChildrenCreators(e,"roomslab"),this._generateChildrenCreators(e,"roomceiling"),this._generateChildrenCreators(e,"roomroof")}}getPolygons(){var e=this.parent.corners,t=[];return this.originalJson.corners&&this.originalJson.corners.forEach((r=>{var s=e[r];t.push([s[0],s[2]])})),this.originalJson.holescorners&&this.originalJson.holescorners.forEach((r=>{r.forEach((r=>{var s=e[r];t.push([s[0],s[2]])}))})),t}_parseSelf(){super._parseSelf(),this.isFloorRoom="Floor"===this.parent.thing2Type;var e=this.parent.corners,t=[],r=[];if(this.originalJson.corners)for(var s=0;s<this.originalJson.corners.length;s++){var n=this.originalJson.corners[s];t.push(e[n])}if(this.originalJson.holescorners)for(var o=0;o<this.originalJson.holescorners.length;o++){for(var i=[],a=0;a<this.originalJson.holescorners[o].length;a++){var l=this.originalJson.holescorners[o][a];i.push(e[l])}r.push(i)}if(this.originalJson.points)for(var h=0;h<this.originalJson.points.length;h++){var c=this.originalJson.points[h];t.push([c[0],c[1],-c[2]])}if(this.originalJson.holespoints)for(var u=0;u<this.originalJson.holespoints.length;u++){for(var d=[],p=0;p<this.originalJson.holespoints[u].length;p++){var g=this.originalJson.holespoints[u][p];d.push([g[0],g[1],-g[2]])}r.push(d)}t.length&&(this.realPosition=THING.MathUtils.getLabelPosition(t)),this.isFloorRoom||"number"==typeof this.originalJson.floorheight&&(this.realPosition=[this.realPosition[0],this.realPosition[1]+(this.originalJson.floorheight||0),this.realPosition[2]]),t.length&&(this.convertJson.external.points=this._toSelfPoints(t)),r.length&&(this.convertJson.external.holes=this._toSelfHoles(r))}_convertSelf(e){super._convertSelf(e),this.isFloorRoom||(this._convertPlane("floor"),this.convertJson.components[0].external.points=this.convertJson.external.points,this.convertJson.components[0].external.holes=this.convertJson.external.holes,this.convertJson.components[0].external.materialResource.sideType="Double",this.convertJson.components[0].external.materialResource._floorao=!0,delete this.convertJson.external.points,delete this.convertJson.external.holes)}},outdoors:class extends Qt{get thing2Type(){return"Ground"}get originalType(){return"Outdoors"}get isFloor(){return!1}get isOutdoor(){return!0}_parseDecodeNumber(){this.decodeNumber="3"}__generateChildrenCreators(e,t,r){void 0===r&&(r=this.parent),super.__generateChildrenCreators(e,t,r)}},facade:class extends Zt{get thing2Type(){return"BaseEntity"}_convertTags(){this.convertJson.tags=[1]}get originalType(){return"Facade"}},facadeGroup:class extends qt{get thing2Type(){return"Group"}get originalType(){return"FacadeGroup"}_parseChildren(){this._generateChildrenCreators(this.originalJson.facades,"facade"),this._generateChildrenCreators(this.originalJson.groups,"facadeGroup")}_convertSelf(e){super._convertSelf(e),this.convertJson.external.tags="Facade"}},curveLine:Kt,leakWaterLine:er,arrowLine:tr,arrowDataLine:class extends tr{get originalType(){return"ArrowDataLine"}},pipeLine:$t,routeLine:class extends Kt{_convertSelf(e){super._convertSelf(e),this.convertJson.style.color=this.convertJson.style.color||[0,0,1]}get originalType(){return"RouteLine"}},placementWall:class extends Zt{get thing2Type(){return"Wall"}get originalType(){return"PlacementWall"}_convertTags(){}_convertSelf(e){super._convertSelf(e),this.convertJson.renderOrder=-9}},ground:class extends Zt{get originalType(){return"Ground"}_convertTags(){}},generalPolygonLine:class extends er{_convertSelf(e){super._convertSelf(e),this.originalJson.color||delete this.convertJson.style.color}get originalType(){return"GeneralPolygonLine"}},generalRouteLine:class extends Kt{_convertSelf(e){super._convertSelf(e),this.originalJson.arrowVisible&&(this.convertJson.external.arrow=!0)}get originalType(){return"GeneralRouteLine"}},misc:rr,wall:sr,roomslab:class extends nr{get _floorao(){return!0}get thing2Type(){return"Object3D"}get originalType(){return"RoomSlab"}_convertTags(){this.convertJson.tags=[3,6]}_parseSelf(){}_convertSelf(e){super._convertSelf(e),this.convertJson.uuid=this.resourceManager.addUUID(jt.generateUUID()),this.convertJson.position=[0,this.originalJson.floorheight||.01,0],this.convertJson.renderOrder=-10,this._convertPlane("floor")}},roomroof:class extends nr{get sideType(){return"Back"}get thing2Type(){return"Object3D"}get originalType(){return"RoomCeiling"}_convertTags(){this.convertJson.tags=[5,6]}_parseSelf(){}_convertSelf(e){super._convertSelf(e),this.convertJson.uuid=this.resourceManager.addUUID(jt.generateUUID()),this.convertJson.position=[0,this.originalJson.ceilingheight||(this.parent.parent.convertJson.height||3)-.1,0],this.convertJson.castShadow=!1,this._convertPlane("ceiling")}},roomceiling:class extends nr{get thing2Type(){return"Object3D"}get originalType(){return"RoomRoof"}get sideType(){return"Front"}_convertTags(){this.convertJson.tags=[4,6]}_parseSelf(){}_convertSelf(e){super._convertSelf(e),this.convertJson.uuid=this.resourceManager.addUUID(jt.generateUUID()),this.convertJson.position=[0,this.originalJson.roofheight||(this.parent.parent.convertJson.height||3)+.005,0],this._convertPlane("roof")}},emptyObject:class extends Zt{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[8]}_convertSelf(e){super._convertSelf(e),this.convertJson.layerMask=0,this.convertJson.external.oriType="Thing",this.convertJson.body&&"number"==typeof this.convertJson.body.id&&(this.convertJson.external.body={},this.convertJson.external.body.id=this.convertJson.body.id,delete this.convertJson.body)}}};class ir{static getMap(){return or}}class ar extends At{import(e){return new Promise(((t,r)=>{var s=super.import(e),n=ir.getMap(),o=new n.world({creatorMap:n,version:this.version,resourceManager:this.resourceManager},e.scene);s.then((()=>{t(o)}))}))}getCreatorConfig(){return ir}}class lr extends Wt{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.version=e.version,this.useInverseRotation=null,this._parseSelf(),e.noCreateChildren||this._parseChildren()}_parseSelf(){this._convertModel()}_convertSelf(e){super._convertSelf(e),this._convertExcludeNodeNames(),"number"==typeof this.convertJson.body.id&&this.resourceManager.modelUseCount[this.convertJson.body.id]>1&&(this.convertJson.external.instance=this.resourceManager.getInstance(this.convertJson.body.id),this.convertJson.external.instanceId=1e4+this.convertJson.external.instance,this.convertJson.external.instanceCount=this.resourceManager.modelUseCount[this.convertJson.body.id])}_convertExcludeNodeNames(){if("number"==typeof this.convertJson.body.id){for(var e=[],t=0;t<this.children.length;t++){var r=this.children[t];r.convertJson.body&&r.convertJson.body.node&&e.push(r.convertJson.body.node)}e.length&&(this.convertJson.body.excludeNodeNames=e)}}_convertTransform(){var e=this.resourceManager.getTransform(this.convertJson.body.node),t=this.originalJson.position;!t||0===t[0]&&0===t[1]&&0===t[2]?e&&(this.convertJson.position=this.realPosition=e.position):this.convertJson.position=this.realPosition=[t[0],t[1],t[2]];var r=this.originalJson.rotation;!r||0===r[0]&&0===r[1]&&0===r[2]&&1===r[3]?e&&(this.convertJson.quaternion=this.useInverseRotation=this.realRotation=e.quaternion):this.convertJson.quaternion=this.realRotation=[r[0],r[1],r[2],r[3]];var s=this.originalJson.scale;!s||1===s[0]&&1===s[1]&&1===s[2]?e&&(this.convertJson.scale=this.realScale=e.scale):this.convertJson.scale=this.realScale=[s[0],s[1],s[2]]}_convertModel(){if("number"==typeof this.originalJson.model){var e=this.resourceManager.getModelByIndex(this.originalJson.model);if(e){var t={};Object.assign(t,e),bt.parseModel(t,this.version,this.resourceManager.baseLocalUrl,this.convertJson),t.applyTransposeToMesh&&(this.convertJson.body.inverseRotationMode="InverseRotationToMesh"),t.applyTransposeToVertices&&(this.convertJson.body.inverseRotationMode="InverseRotationToVertices"),delete t.applyTransposeToMesh,delete t.applyTransposeToVertices,delete t.type,this.convertJson.body.id=this.resourceManager.addModel(t),this.originalJson.node?this.convertJson.body.node=this.originalJson.node:this.originalJson.source&&"instance"===this.originalJson.source&&this.resourceManager.addModelUseCount(this.convertJson.body.id)}}}}let hr=class extends lr{get thing2Type(){return"Entity"}_convertTags(){this.convertJson.tags=[2]}get originalType(){return"Placement"}_convertSelf(e){super._convertSelf(e),this.originalJson.animinfo&&this.originalJson.animinfo.clip.length&&this.originalJson.animinfo.isplay&&(this.convertJson.external.animInfo={},this.convertJson.external.animInfo.clips=[this.originalJson.animinfo.clip])}},cr=class extends lr{get thing2Type(){return"Floor"}get originalType(){return"Floorplan"}get isFloor(){return!0}_parseSelf(){super._parseSelf(),this.originalJson.corners||(this.originalJson.corners=[])}_parseChildren(){this._generateChildrenCreators(this.originalJson.walls,"placementWall"),this._generateChildrenCreators(this.originalJson.rooms,"room"),this._generateChildrenCreators(this.originalJson.doororwindows,"doororwindow"),this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.groups,"group"),this.__generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement")}_generateChildrenCreators(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible?e.visible=!1:this.isFloor&&!this.originalJson.alwaysshowinsideobjs&&("room"===t||t.includes("Wall")||(e.visible=!1)),r=r||this,!1===this.originalJson.visible&&(e.visible=!1);var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}__generateChildrenCreators(e,t,r){void 0===r&&(r=this),e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{(!1===this.originalJson.visible||this.isFloor&&!this.originalJson.alwaysshowinsideobjs)&&(e.visible=!1),this.misc||(this.misc=new this.creatorMap.misc(this.options,{visible:e.visible},r),r.children.push(this.misc)),this.misc.children.push(new this.creatorMap[t](this.options,e,this.misc))})))}_convertExcludeNodeNames(){this.isFloor&&"number"==typeof this.convertJson.body.id&&(this.convertJson.body.excludeNodeNames="All")}_convertSelf(e){super._convertSelf(e),this.originalJson.height&&(this.convertJson.height=this.originalJson.height),this.originalJson.corners&&(this.convertJson.external.corners=this.originalJson.corners),"Building"===this.parent.thing2Type&&this.parent.hideStruct&&(this.convertJson.visible=!1),this.isFloor&&(this.convertJson.external.constantShowThings=!!this.originalJson.alwaysshowinsideobjs)}},ur=class extends cr{get thing2Type(){return"Ground"}get originalType(){return"Outdoors"}get isFloor(){return!1}_parseChildren(){this._generateChildrenCreators(this.originalJson.walls,"placementWall"),this._generateChildrenCreators(this.originalJson.rooms,"room"),this._generateChildrenCreators(this.originalJson.doororwindows,"doororwindow"),this._generateChildrenCreatorsByTjsType(this.originalJson.placements,"placement"),this._generateChildrenCreatorsByTjsType(this.originalJson.groups,"group"),this.__generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement")}_generateChildrenCreatorsByTjsType(e,t,r){var s=[];return e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{!1===this.originalJson.visible&&(e.visible=!1),r=e.properties&&"Ground"===e.properties._tjsType_?this:this.parent;var n=new this.creatorMap[t](this.options,e,r);r.children.push(n),s.push(n)}))),s}_convertSelf(e){super._convertSelf(e),this.convertJson.name=""}__generateChildrenCreators(e,t,r){void 0===r&&(r=this.parent),super.__generateChildrenCreators(e,t,r)}},dr=class extends lr{get thing2Type(){return"Room"}get originalType(){return"Room"}_convertExcludeNodeNames(){}_convertSelf(e){if(super._convertSelf(e),this.originalJson.points&&this.originalJson.points.length){for(var t=0;t<this.originalJson.points[0].length;t++)this.convertJson.external.points=this._toSelfPoints(this.originalJson.points[0]);if(this.originalJson.points.length>1){this.convertJson.external.holes=[];for(var r=1;r<this.originalJson.points.length;r++)this.convertJson.external.holes.push(this._toSelfPoints(this.originalJson.points[r]))}}return this.convertJson.children.push({uuid:this.resourceManager.addUUID(jt.generateUUID()),type:"Object3D",name:"slab",tags:[3,6],body:this.convertJson.body,external:this.convertJson.external,quaternion:this.convertJson.quaternion,renderOrder:-10}),delete this.convertJson.body,delete this.convertJson.quaternion,this.convertJson}_parseSelf(){super._parseSelf()}};var pr={world:class extends lr{_parseChildren(){this._generateChildrenCreators(this.originalJson.outdoors,"outdoors"),this._generateChildrenCreators(this.originalJson.buildings,"building")}_convertExcludeNodeNames(){}get thing2Type(){return"Campus"}get originalType(){return"World"}},building:class extends lr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.facades=[],this.facadegroups=[]}_parseChildren(){this.facades=this._generateChildrenCreators(this.originalJson.facades,"facade"),this.facadegroups=this._generateChildrenCreators(this.originalJson.facadegroups,"facadeGroup"),this._generateChildrenCreators(this.originalJson.plans,"floorplan")}get thing2Type(){return"Building"}get originalType(){return"Building"}get isBuilding(){return!0}get hideStruct(){if(this.originalJson.structshow)return!1;var e=this.originalJson.facades||[],t=this.originalJson.facadegroups||[];return!(!e.length&&!t.length)}_convertExcludeNodeNames(){"number"==typeof this.convertJson.body.id&&(this.convertJson.body.excludeNodeNames="All")}_convertSelf(e){super._convertSelf(e),this.hideStruct||(this.convertJson.external.constantShowStruct=!0)}},combinePlacement:class extends lr{get thing2Type(){return"Entity"}_convertTags(){this.convertJson.tags=[2]}get originalType(){return"CombinePlacement"}},doororwindow:class extends lr{get thing2Type(){return this.originalJson.iswindow?"Window":"Door"}get originalType(){return"DoorOrWindow"}},facadeGroup:class extends lr{_parseChildren(){this._generateChildrenCreators(this.originalJson.facades,"facade"),this._generateChildrenCreators(this.originalJson.groups,"facadeGroup")}get thing2Type(){return"Group"}get originalType(){return"FacadeGroup"}_convertSelf(e){super._convertSelf(e),this.convertJson.external.tags="Facade"}},facade:class extends hr{get thing2Type(){return"BaseEntity"}_convertTags(){this.convertJson.tags=[1]}get originalType(){return"Facade"}},floorplan:cr,group:class extends lr{_parseChildren(){this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.groups,"group")}get thing2Type(){return"Group"}get originalType(){return"Group"}},outdoors:ur,placementWall:class extends lr{get thing2Type(){return"Wall"}get originalType(){return"PlacementWall"}_convertSelf(e){super._convertSelf(e),this.convertJson.renderOrder=-9}},placement:hr,room:dr,misc:rr};class gr{static getMap(){return pr}}let vr=class extends cr{};var mr=gr.getMap();mr.floorplan=vr;class fr{static getMap(){return mr}}let yr=class extends lr{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[3,6]}_convertSelf(e){super._convertSelf(e),this.convertJson.renderOrder=-10}};var xr=fr.getMap();xr.floorplan=class extends vr{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.combinefloors,"combineFloor"),this._generateChildrenCreators(this.originalJson.combineroofs,"combineRoof"),this._generateChildrenCreators(this.originalJson.combineceilings,"combineCeiling")}},xr.outdoors=class extends ur{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.combinefloors,"combineFloor"),this._generateChildrenCreators(this.originalJson.combineroofs,"combineRoof"),this._generateChildrenCreators(this.originalJson.combineceilings,"combineCeiling")}},xr.combineFloor=yr,xr.combineCeiling=class extends yr{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[5,6]}},xr.combineRoof=class extends yr{get thing2Type(){return"Object3D"}_convertTags(){this.convertJson.tags=[4,6]}};class _r{static getMap(){return xr}}var br=_r.getMap();br.room=class extends dr{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement"),this._generateChildrenCreators(this.originalJson.groups,"group")}};class Cr{static getMap(){return br}}var Tr=Cr.getMap();Tr.placement=class extends hr{_parseChildren(){super._parseChildren(),this._generateChildrenCreators(this.originalJson.placements,"placement")}};class Mr{static getMap(){return Tr}}class Jr extends At{constructor(e){super(e),this._versionMap={0:{0:gr,1:fr,2:fr,3:_r,4:Cr,5:Cr,6:Mr}},this._smallVersionLibs=[[0,1,2,3,4,5,6]],this._bigVersions=[0]}import(e){return new Promise(((t,r)=>{var s=super.import(e),n=this._getCreatorConfig(this.version.bigVersion,this.version.smallVersion).getMap(),o=new n.world({creatorMap:n,version:this.version,resourceManager:this.resourceManager},e.scene);s.then((()=>{t(o)}))}))}getCreatorConfig(e,t){return this._getCreatorConfig(e,t)}}class wr extends Wt{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.dataHandleMap=e.dataHandleMap,this._parseLoadVersion(),this._parseSelf(),this._parseChildren()}_parseLoadVersion(){this.originalJson.loadversion?this.loadVersion=new _t(this.originalJson.loadversion):this.parent&&this.parent.loadVersion?this.loadVersion=new _t(this.parent.loadVersion.mode):this.loadVersion=new _t(3)}_parseSelf(){var e,t=this.dataHandleMap[this.loadVersion.mode].getCreatorConfig(this.loadVersion.bigVersion,this.loadVersion.smallVersion).getMap(),r=t[this.creatorType];this.parent&&(e=this.parent.creator||this.parent),this.creator=new r({creatorMap:t,noCreateChildren:this.noCreateChildren,version:this.loadVersion,resourceManager:this.resourceManager},this.originalJson,e)}convert(e){return this.convertJson=this.creator.convert(e),this.convertJson.children||(this.convertJson.children=[]),this._convertChildren(e),this._cutEmptyJson(),this.convertJson}get noCreateChildren(){return!0}}class Sr extends wr{constructor(e,t,r){void 0===e&&(e={}),super(e,t,r),this.rooms=this.rooms||[]}_parseSelf(){super._parseSelf(),this.corners=this.creator.corners}_parseChildren(){var e=this.originalJson.walls;if(e){var t=[],r=[],s=[];if(e.forEach((e=>{0===e.type?r.push(e):1===e.type?t.push(e):s.push(e)})),t.length){var n=new this.creatorMap.wall(this.options,{},this);this.children.push(n),this._generateChildrenCreators(t,"modelWall",n)}if(r.length){var o=new this.creatorMap.wall(this.options,{},this);this.children.push(o),this._generateChildrenCreators(r,"textureWall",o)}this._generateChildrenCreators(s,"placementWall")}this.rooms=this._generateChildrenCreators(this.originalJson.rooms,"room"),this._generateChildrenCreators(this.originalJson.grounds,"ground"),this._generateChildrenCreators(this.originalJson.doororwindows,"doororwindow"),this._generateChildrenCreators(this.originalJson.combinefloors,"combineFloor"),this._generateChildrenCreators(this.originalJson.combineroofs,"combineRoof"),this._generateChildrenCreators(this.originalJson.combineceilings,"combineCeiling"),this._generateChildrenCreators(this.originalJson.curvelines,"curveLine"),this._generateChildrenCreators(this.originalJson.routelines,"routeLine"),this._generateChildrenCreators(this.originalJson.leakwaterlines,"leakWaterLine"),this._generateChildrenCreators(this.originalJson.arrowlines,"arrowLine"),this._generateChildrenCreators(this.originalJson.arrowdatalines,"arrowDataLine"),this._generateChildrenCreators(this.originalJson.pipelines,"pipeLine"),this._generateChildrenCreators(this.originalJson.generalpolygonlines,"generalPolygonLine"),this._generateChildrenCreators(this.originalJson.generalroutelines,"generalRouteLine"),this.__generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement"),this.__generateChildrenCreators(this.originalJson.placements,"placement"),this.__generateChildrenCreators(this.originalJson.groups,"group"),this.__generateChildrenCreators(this.originalJson.videoprobes,"placement")}__generateChildrenCreators(e,t,r){if(void 0===r&&(r=this),e){Array.isArray(e)||(e=[e]);var s=this,n=r;function o(){s.misc||(s.misc=new s.creatorMap.misc(s.options,{},r),r.children.push(s.misc)),n=s.misc}e.forEach((e=>{var r=new this.creatorMap[t](this.options,e,this);if(r.isShouldCombine)o();else if(3===r.loadVersion.mode){this._isShouldCombine(r)&&o()}if(r.originalJson._temp_belongroom)for(var s=0;s<this.rooms.length;s++)if(3===this.rooms[s].loadVersion.mode){var i=this.rooms[s].creator,a=r.creator;if(i.originalJson.userid&&i.originalJson.userid===a.originalJson._temp_belongroom){a.realPosition&&(a.realPosition=[a.realPosition[0]-i.realPosition[0],a.realPosition[1]-i.realPosition[1],a.realPosition[2]-i.realPosition[2]]),n=i;break}}r.parent=n,n.children.push(r)}))}}get creatorType(){return"floorplan"}get isFloor(){return!0}}var Ir={world:class extends wr{_parseChildren(){this._generateChildrenCreators(this.originalJson.buildings,"building"),this._generateChildrenCreators(this.originalJson.outdoors,"outdoors")}get creatorType(){return"world"}},building:class extends wr{_parseChildren(){this._generateChildrenCreators(this.originalJson.facades,"facade"),this._generateChildrenCreators(this.originalJson.facadegroups,"facadeGroup"),this._generateChildrenCreators(this.originalJson.plans,"floorplan")}get creatorType(){return"building"}},facadeGroup:class extends wr{get creatorType(){return"facadeGroup"}get noCreateChildren(){return!1}},facade:class extends wr{get creatorType(){return"facade"}},floorplan:Sr,outdoors:class extends Sr{get creatorType(){return"outdoors"}__generateChildrenCreators(e,t,r){void 0===r&&(r=this.parent),super.__generateChildrenCreators(e,t,r)}get isFloor(){return!1}},group:class extends wr{get creatorType(){return"group"}get noCreateChildren(){return!1}},room:class extends wr{_parseChildren(){this._generateChildrenCreators(this.originalJson.placements,"placement"),this._generateChildrenCreators(this.originalJson.combineplacements,"combinePlacement"),this._generateChildrenCreators(this.originalJson.groups,"group")}get creatorType(){return"room"}get noCreateChildren(){return!1}},placement:class extends wr{get creatorType(){return"placement"}},combinePlacement:class extends wr{get creatorType(){return"combinePlacement"}get isShouldCombine(){return!0}},doororwindow:class extends wr{get creatorType(){return"doororwindow"}},ground:class extends wr{get creatorType(){return"ground"}},modelWall:class extends wr{get creatorType(){return"modelWall"}get noCreateChildren(){return!1}},textureWall:class extends wr{get creatorType(){return"textureWall"}get noCreateChildren(){return!1}},placementWall:class extends wr{get creatorType(){return"placementWall"}},arrowLine:class extends wr{get creatorType(){return"arrowLine"}},arrowDataLine:class extends wr{get creatorType(){return"arrowDataLine"}},curveLine:class extends wr{get creatorType(){return"curveLine"}},leakWaterLine:class extends wr{get creatorType(){return"leakWaterLine"}},pipeLine:class extends wr{get creatorType(){return"pipeLine"}},routeLine:class extends wr{get creatorType(){return"routeLine"}},generalPolygonLine:class extends wr{get creatorType(){return"generalPolygonLine"}},generalRouteLine:class extends wr{get creatorType(){return"generalRouteLine"}},combineCeiling:class extends wr{get creatorType(){return"combineCeiling"}},combineFloor:class extends wr{get creatorType(){return"combineFloor"}},combineRoof:class extends wr{get creatorType(){return"combineRoof"}},misc:rr,wall:sr};class Nr{static getMap(){return Ir}}class Er extends At{import(e){return new Promise(((t,r)=>{var s=super.import(e),n=new ar(this.param),o=new Jr(this.param),i=Nr.getMap(),a=new i.world({creatorMap:i,dataHandleMap:{3:n,5:o},resourceManager:this.resourceManager},e.scene);s.then((()=>{t(a)}))}))}getCreatorConfig(){return Nr}}class Pr{static getDataHandler(e){var t,r=e.index,s=new _t(r.version);if(e.version=s,3===s.mode?t=ar:5===s.mode?t=Jr:7===s.mode&&(t=Er),t)return new t(e)}}var Rr=Symbol("private");class Dr{constructor(e){this[Rr]={};var t=this[Rr];t.app=e.app,t.dataHandle=null}convert(e){var t=this;return mt((function*(){var r=yield t.parseTjs(e);return t.convertToThing2(r)}))()}parseTjs(e){var t=this;return mt((function*(){var r=t[Rr];return e.app=r.app,r.dataHandle=Pr.getDataHandler(e),yield r.dataHandle.import(e)}))()}convertToThing2(e){for(var t=this[Rr],r=e.convert(),s=t.dataHandle.resourceManager,n=[],o=0;o<s.exportInstanceCount.length;o++)n[o]=s.exportInstanceCount[o].length;return{version:"1.0.0",objects:[r],resources:{rootPath:{model:tt,texture:rt},models:s.exportModels,images:s.exportTextures,uuids:s.exportUuids,tags:Xe,instanceCount:n}}}get matrixNode(){return this[Rr].dataHandle.resourceManager.matrixNode}set matrixNode(e){this[Rr].dataHandle.resourceManager.matrixNode=e}}class Or{constructor(e){void 0===e&&(e={}),this.app=e.app,this.baseUrl=e.url}parse(e){e?(this.parseLight(e.light),this.parseCamera(e.camera),this.parseEffectConfig(e.effectConfig),this.parseSkybox(e.skybox)):this.setMainLightRefresh()}parseLight(e){if(e){var t=e.ambientLight;t&&Object.assign(this.app.scene.ambientLight,t);var r=e.mainLight;if(r){var s=this.app.scene.mainLight;void 0!==r.shadow&&(s.castShadow=r.shadow),void 0!==r.intensity&&(s.intensity=r.intensity),void 0!==r.color&&(s.color=r.color);var n=s.adapter;void 0!==r.beta&&(n.horzAngle=r.beta),void 0!==r.alpha&&(n.vertAngle=r.alpha)}var o=e.secondaryLight;if(o&&o.intensity>0){var i=app.queryByName("secondaryLight").objects[0];i||(i=new THING.DirectionalLight({parent:this.app.root,name:"secondaryLight"})),void 0!==o.shadow&&(i.castShadow=o.shadow),void 0!==o.intensity&&(i.intensity=o.intensity),o.color&&(i.color=o.color);var a=i.adapter;void 0!==o.beta&&(a.horzAngle=o.beta),void 0!==o.alpha&&(a.vertAngle=o.alpha)}var l=e.hemisphereLight;if(l&&l.intensity>0){var h=app.query(".HemisphereLight").objects[0];h||(h=new THING.HemisphereLight({parent:this.app.root,name:"hemisphereLight"})),h.intensity=l.intensity,h.color=l.color,h.groundColor=l.groundColor}}else this.setMainLightRefresh()}setMainLightRefresh(){this.app.scene.mainLight.adapter.needRefresh=!0}parseEffectConfig(e){if(e){var t=this.app.camera.postEffect;for(var r in e)"vignette"===r?Object.assign(t.vignetting,e[r]):Object.assign(t[r],e[r])}}parseCamera(e){if(e){var t=this.app.camera;if(e.fov&&(t.fov=e.fov),e.far&&(t.far=e.far),e.xAngleLimitRange){var r=[90-e.xAngleLimitRange[0],90-e.xAngleLimitRange[1]];t.vertAngleLimit=r}e.distanceLimited&&(t.distanceLimited=e.distanceLimited)}}parseSkybox(e){e&&!this.app.options.background&&(this.app.background=new THING.CubeTexture({url:this._parseCubeTextureUrls(this.baseUrl,e)}))}getEnvMaps(e,t){var r=this;return mt((function*(){var s=new Promise(((s,n)=>{e&&e.environment?new THING.CubeTexture({url:r._parseEnvTextureUrls(r.baseUrl,e.environment)}).waitForComplete().then((e=>{t.outer=e,s()}),(e=>{s()})):s()})),n=new Promise(((s,n)=>{e&&e.environmentInside?new THING.CubeTexture({url:r._parseEnvTextureUrls(r.baseUrl,e.environmentInside)}).waitForComplete().then((e=>{t.inner=e,s()}),(e=>{s()})):s()}));yield Promise.all([s,n])}))()}_parseCubeTextureUrls(e,t){return{negx:e+t.lf,negy:e+t.dn,negz:e+t.bk,posx:e+t.rt,posy:e+t.up,posz:e+t.fr}}_parseEnvTextureUrls(e,t){return{negx:e+t.rt,negy:e+t.dn,negz:e+t.fr,posx:e+t.lf,posy:e+t.up,posz:e+t.bk}}static setEnvMap(e,t,r){(t||r)&&e.children.forEach((e=>{if(e.tags.has("Building")){if(t)e.facades.forEach((e=>{e.style.envMap=t,e.isInstancedDrawing&&e.makeInstancedDrawing(!0)}));r&&e.traverse((e=>{e.tags.has("Facade")||e.tags.has("Building")||(e.body.style.envMap=r,e.isInstancedDrawing&&e.makeInstancedDrawing(!0))}))}else t&&e.traverse((e=>{e.body.style.envMap=t,e.isInstancedDrawing&&e.makeInstancedDrawing(!0)}))}))}}class Lr extends Be{constructor(){super(...arguments),this._restructureData=(e,t,r)=>{var s=t.objects[0];!e.uuid&&s.uuid&&(r.uuid=s.uuid),!e.id&&s.id&&(r.id=s.id),!e.name&&s.name&&(r.name=s.name);var n=s.extras||s.external;if(n){var o=r.external||{};for(var i in n)o[i]||(o[i]=n[i]);r.external=n}t.objects=s.children}}onLoad(e,t){var r=this;this._parseBundle(e).then((s=>{if(s){this.onCompatibleTSF(t);var n=THING.Utils.getCurrentApp(),o=new Dr({app:n}),i=t.owner,a=!1;if(!i){var l=Object.assign({},t);l.url=null,l.complete=l.onComplete=null,i=new THING.Object3D(l),a=!0,i.on(THING.EventType.AfterRemoveChild,(()=>{this.onClearCompatibleTSF(),0===i.children.length&&(a=!1,i.destroy()),o.matrixNode&&(o.matrixNode.dispose(),o.matrixNode=null)}),""+i.uuid)}bt.parseValue(t.progressBarVisible,!0)&&this.initLoadingBar(i);var h=e.url._appendPath("scene.json");bt.loadJSONFile(h,mt((function*(l){var h={url:e.url,index:s,scene:l.data},c=yield o.convert(h),u=new Or({app:n,url:h.url}),d=h.scene.thingjsconfig,p={outer:n.envMap,inner:n.envMap};yield u.getEnvMaps(d,p),a||r._restructureData(t,c,i);var g=new THING.SceneLoaderOld,v=0,m=Object.assign({},t);m.owner=i,g.parse(THING.SceneResourceType.Object,c,(s=>{if(s.objects&&s.objects.length){a?r.onLoadComplete(e,t,i):r._loadComplete(e,i);var n=e.campus;u.parse(d),r._setEnvMap(n,p),t.onComplete(),o.matrixNode&&(o.matrixNode.dispose(),o.matrixNode=null),i.loadingBar?i.loadingBar.fadeOut({time:2e3,delayTime:1e3}).then((()=>{a&&i.destroy()})):a&&i.destroy()}else t.onComplete()}),(e=>{t.onProgress(e.progress),i.loadingBar&&(i.loadingBar.value+=(e.progress-v)/1,v=e.progress)}),t.onError,m)})))}else super.onLoad(e,t)}))}_loadComplete(e,t){this.onClearCompatibleTSF(),e.campus=t,e.campuses=[t],t.on(THING.EventType.AfterDestroy,(()=>{e.campus=null,e.campuses.length=0}));var r={bundle:e,campuses:e.campuses,campus:t};t.app.trigger(THING.EventType.Load,r)}_setEnvMap(e,t){t.outer==e.app.envMap&&t.inner==e.app.envMap||(e.app.envMap=t.outer,e.on(THING.EventType.BeforeEnterLevel,".Building",(function(r){r.prev&&r.prev.isCampus&&(e.app.envMap=t.inner)}),e.uuid+"TjsCampusBundleLoaderCampusToBuilding"),e.on(THING.EventType.BeforeLeaveLevel,".Building",(function(r){r.next&&r.next.isCampus&&(e.app.envMap=t.outer)}),e.uuid+"TjsCampusBundleLoaderBuildingToCampus"))}_checkVersion(e){if(!e)return!1;var t=e.major;return 3==t||5==t||7==t}_parseBundle(e){var t=e.info.version.split("."),r=parseInt(t.length>=1?t[0]:0);if(1==r){var s=e.url._appendPath("index.json");return bt.loadJSONFile(s)}return 3==r||5==r||7==r?Promise.resolve(e.info):Promise.resolve()}}THING.App.addCompleteCallback((e=>{e.registerBundleLoader("scene",new Lr)}),-4);var Fr=Object.freeze({__proto__:null,COMPILETIME:"Fri, 01 Sep 2023 05:18:38 GMT",VERSION:"1.0.0"});for(var Gr in Ze){var zr=Ze[Gr];"VERSION"!=Gr&&"COMPILETIME"!=Gr&&window.THING.Utils.registerClass(Gr,zr)}window.THING.CAMPUS=Ze,window.THING.SCENE_CONVERT=Fr}));
